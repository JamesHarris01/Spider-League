<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle Arena - Spider League</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
        }

        h1 {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .nav-bar {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-bar a {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: bold;
            transition: transform 0.2s;
        }

        .nav-bar a:hover {
            transform: translateY(-2px);
        }

        .nav-bar a.active {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%);
        }

        .user-coins {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin: 0 10px;
        }

        .config-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .config-section h2 {
            margin-bottom: 15px;
            color: #4ecdc4;
        }

        .spider-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .spider-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .spider-card:hover {
            transform: translateY(-5px);
            border-color: #4ecdc4;
        }

        .spider-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .spider-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .spider-name {
            font-size: 1.3em;
            color: #4ecdc4;
            margin-bottom: 5px;
        }

        .energy-bar {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a6a0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .battle-arena {
            background: rgba(0, 0, 0, 0.5);
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .battle-fighters {
            display: flex;
            justify-content: space-between;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .fighter {
            flex: 1;
            min-width: 250px;
            text-align: center;
        }

        .fighter-image {
            width: 150px;
            height: 150px;
            border-radius: 10px;
            margin: 0 auto 15px;
            object-fit: cover;
        }

        .battle-log {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .battle-log-entry {
            padding: 5px;
            margin: 5px 0;
            border-left: 3px solid #4ecdc4;
            padding-left: 10px;
        }

        .move-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .move-btn {
            padding: 15px;
            background: rgba(102, 126, 234, 0.8);
            border: 2px solid rgba(102, 126, 234, 1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .move-btn:hover:not(:disabled) {
            background: rgba(102, 126, 234, 1);
            transform: scale(1.05);
        }

        .move-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .move-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .move-cost {
            font-size: 12px;
            color: #ffa500;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚öîÔ∏è Battle Arena ‚öîÔ∏è</h1>
            <p>Challenge other spiders to epic battles!</p>
        </header>

        <div class="nav-bar">
            <a href="index.html">üï∏Ô∏è Collection</a>
            <a href="battle.html" class="active">‚öîÔ∏è Battle</a>
            <a href="shop.html">üõí Shop</a>
            <a href="admin.html" id="adminLink" class="hidden">üëë Admin</a>
        </div>

        <div style="text-align: center; margin-bottom: 20px;">
            <span class="user-coins" id="userCoins">üí∞ 0 coins</span>
        </div>

        <div id="selectPhase" class="config-section">
            <h2>Select Your Spider</h2>
            <p style="color: #aaa; margin-bottom: 15px;">Choose one of your spiders to battle (needs at least 20 energy)</p>
            <div class="spider-grid" id="mySpiders">
                <p style="color: #666;">Loading your spiders...</p>
            </div>
        </div>

        <div id="opponentPhase" class="config-section hidden">
            <button onclick="backToSpiderSelect()" style="margin-bottom: 15px;">‚Üê Back to Spider Selection</button>
            <h2>Choose Your Opponent</h2>
            <p style="color: #aaa; margin-bottom: 15px;">Select an opponent to battle against</p>
            <div class="spider-grid" id="opponentSpiders">
                <p style="color: #666;">Loading opponents...</p>
            </div>
        </div>

        <div id="battlePhase" class="config-section hidden">
            <button onclick="backToOpponentSelect()" style="margin-bottom: 15px;">‚Üê Back to Opponent Selection</button>
            <div id="battleContent"></div>
        </div>
    </div>

    <script src="shared.js"></script>
    <script>
        let selectedPlayerSpider = null;
        let selectedEnemySpider = null;
        let currentBattle = null;

        const MOVE_TYPES = [
            { name: 'Web Shot', power: 30, energyCost: 20, type: 'web' },
            { name: 'Bite', power: 40, energyCost: 25, type: 'strength' },
            { name: 'Quick Strike', power: 25, energyCost: 15, type: 'speed' },
            { name: 'Venom Spray', power: 50, energyCost: 35, type: 'strength' },
            { name: 'Web Trap', power: 20, energyCost: 18, type: 'web' },
            { name: 'Lightning Dash', power: 35, energyCost: 28, type: 'speed' }
        ];

        function generateMoves(spider) {
            const moves = [];
            const shuffled = [...MOVE_TYPES].sort(() => Math.random() - 0.5);
            
            for (let i = 0; i < 4; i++) {
                const move = { ...shuffled[i] };
                if (move.type === 'strength' && spider.stats.Strength) {
                    move.power += Math.floor(spider.stats.Strength / 10);
                } else if (move.type === 'speed' && spider.stats.Speed) {
                    move.power += Math.floor(spider.stats.Speed / 10);
                } else if (move.type === 'web' && spider.stats['Web Quality']) {
                    move.power += Math.floor(spider.stats['Web Quality'] / 10);
                }
                moves.push(move);
            }
            
            return moves;
        }

        function renderBattleList() {
            renderMySpiders();
        }

        function renderMySpiders() {
            const grid = document.getElementById('mySpiders');
            const mySpiders = spiders.filter(s => s.owner === currentUser && s.verified);

            if (!currentUser) {
                grid.innerHTML = '<p style="color: #666;">Please login to battle!</p>';
                return;
            }

            if (mySpiders.length === 0) {
                grid.innerHTML = '<p style="color: #666;">You have no verified spiders yet!</p>';
                return;
            }

            grid.innerHTML = mySpiders.map(spider => {
                const canBattle = spider.energy >= 20;
                return `
                    <div class="spider-card ${!canBattle ? 'disabled' : ''}" 
                         onclick="${canBattle ? `selectPlayerSpider(${spider.id})` : ''}">
                        <img src="${spider.image}" class="spider-image" alt="${spider.name}">
                        <div class="spider-name">${spider.name}</div>
                        <p style="color: #ffa500;">Level ${spider.level}</p>
                        <div class="energy-bar">
                            <div class="energy-fill" style="width: ${(spider.energy / spider.maxEnergy) * 100}%">
                                ‚ö° ${spider.energy}/${spider.maxEnergy}
                            </div>
                        </div>
                        <p style="color: #aaa;">Power: ${spider.powerLevel}</p>
                        <p style="color: #aaa;">Record: ${spider.wins || 0}W - ${spider.losses || 0}L</p>
                        ${!canBattle ? '<p style="color: #f5576c; margin-top: 10px;">‚ö†Ô∏è Not enough energy!</p>' : ''}
                    </div>
                `;
            }).join('');
        }

        function selectPlayerSpider(spiderId) {
            selectedPlayerSpider = spiders.find(s => s.id === spiderId);
            if (!selectedPlayerSpider) return;

            document.getElementById('selectPhase').classList.add('hidden');
            document.getElementById('opponentPhase').classList.remove('hidden');
            renderOpponents();
        }

        function renderOpponents() {
            const grid = document.getElementById('opponentSpiders');
            const opponents = spiders.filter(s => 
                s.verified && s.owner !== currentUser && s.energy >= 20
            );

            if (opponents.length === 0) {
                grid.innerHTML = '<p style="color: #666;">No opponents available for battle!</p>';
                return;
            }

            grid.innerHTML = opponents.map(spider => `
                <div class="spider-card" onclick="selectOpponent(${spider.id})">
                    <img src="${spider.image}" class="spider-image" alt="${spider.name}">
                    <div class="spider-name">${spider.name}</div>
                    <p style="color: #ffa500;">Level ${spider.level}</p>
                    <p style="color: #aaa;">Owner: ${spider.owner}</p>
                    <p style="color: #aaa;">Power: ${spider.powerLevel}</p>
                    <p style="color: #aaa;">Record: ${spider.wins || 0}W - ${spider.losses || 0}L</p>
                </div>
            `).join('');
        }

        function selectOpponent(spiderId) {
            selectedEnemySpider = spiders.find(s => s.id === spiderId);
            if (!selectedEnemySpider) return;

            startBattle();
        }

        function startBattle() {
            currentBattle = {
                player: { ...selectedPlayerSpider, currentEnergy: selectedPlayerSpider.energy, moves: generateMoves(selectedPlayerSpider) },
                enemy: { ...selectedEnemySpider, currentEnergy: selectedEnemySpider.energy, moves: generateMoves(selectedEnemySpider) },
                log: [],
                turn: 'player'
            };

            document.getElementById('opponentPhase').classList.add('hidden');
            document.getElementById('battlePhase').classList.remove('hidden');
            renderBattle();
        }

        function renderBattle() {
            const battle = currentBattle;
            const content = document.getElementById('battleContent');

            content.innerHTML = `
                <div class="battle-arena">
                    <div class="battle-fighters">
                        <div class="fighter">
                            <img src="${battle.player.image}" class="fighter-image" alt="${battle.player.name}">
                            <h3>${battle.player.name} (Lvl ${battle.player.level})</h3>
                            <div class="energy-bar">
                                <div class="energy-fill" style="width: ${(battle.player.currentEnergy / battle.player.maxEnergy) * 100}%">
                                    ${battle.player.currentEnergy}/${battle.player.maxEnergy}
                                </div>
                            </div>
                            <p style="color: #4ecdc4;">Your Spider</p>
                        </div>
                        <div style="text-align: center; align-self: center;">
                            <h2 style="font-size: 3em;">VS</h2>
                        </div>
                        <div class="fighter">
                            <img src="${battle.enemy.image}" class="fighter-image" alt="${battle.enemy.name}">
                            <h3>${battle.enemy.name} (Lvl ${battle.enemy.level})</h3>
                            <div class="energy-bar">
                                <div class="energy-fill" style="width: ${(battle.enemy.currentEnergy / battle.enemy.maxEnergy) * 100}%">
                                    ${battle.enemy.currentEnergy}/${battle.enemy.maxEnergy}
                                </div>
                            </div>
                            <p style="color: #f5576c;">${battle.enemy.owner}'s Spider</p>
                        </div>
                    </div>

                    <div class="battle-log">
                        ${battle.log.map(entry => `<div class="battle-log-entry">${entry}</div>`).join('') || '<div style="color: #666;">Battle started! Choose your move...</div>'}
                    </div>

                    ${battle.turn === 'player' ? `
                        <div class="move-buttons">
                            ${battle.player.moves.map((move, index) => `
                                <button class="move-btn" onclick="useMove(${index})" ${battle.player.currentEnergy < move.energyCost ? 'disabled' : ''}>
                                    <div class="move-name">${move.name}</div>
                                    <div>Power: ${move.power}</div>
                                    <div class="move-cost">Energy Cost: ${move.energyCost}</div>
                                </button>
                            `).join('')}
                        </div>
                    ` : '<p style="text-align: center; color: #ffa500; margin-top: 20px;">Enemy is choosing their move...</p>'}
                </div>
            `;

            if (battle.turn === 'enemy') {
                setTimeout(() => enemyTurn(), 1500);
            }
        }

        async function useMove(moveIndex) {
            const battle = currentBattle;
            const move = battle.player.moves[moveIndex];

            if (battle.player.currentEnergy < move.energyCost) return;

            battle.player.currentEnergy -= move.energyCost;
            battle.enemy.currentEnergy -= move.power;

            battle.log.push(`${battle.player.name} used ${move.name}! Dealt ${move.power} damage!`);

            if (battle.enemy.currentEnergy <= 0) {
                await endBattle(true);
                return;
            }

            battle.turn = 'enemy';
            renderBattle();
        }

        async function enemyTurn() {
            const battle = currentBattle;
            
            const availableMoves = battle.enemy.moves.filter(m => m.energyCost <= battle.enemy.currentEnergy);
            if (availableMoves.length === 0) {
                battle.log.push(`${battle.enemy.name} has no energy left to attack!`);
                battle.turn = 'player';
                renderBattle();
                return;
            }

            const move = availableMoves[Math.floor(Math.random() * availableMoves.length)];
            
            battle.enemy.currentEnergy -= move.energyCost;
            battle.player.currentEnergy -= move.power;

            battle.log.push(`${battle.enemy.name} used ${move.name}! Dealt ${move.power} damage!`);

            if (battle.player.currentEnergy <= 0) {
                await endBattle(false);
                return;
            }

            battle.turn = 'player';
            renderBattle();
        }

        async function endBattle(playerWon) {
            const battle = currentBattle;
            
            const playerSpider = spiders.find(s => s.id === battle.player.id);
            const enemySpider = spiders.find(s => s.id === battle.enemy.id);

            if (!playerSpider || !enemySpider) return;

            playerSpider.energy = Math.max(0, battle.player.currentEnergy);
            enemySpider.energy = Math.max(0, battle.enemy.currentEnergy);

            if (playerWon) {
                playerSpider.wins = (playerSpider.wins || 0) + 1;
                enemySpider.losses = (enemySpider.losses || 0) + 1;
                
                const xpGained = gameBalance.battleWinXP;
                const coinsGained = gameBalance.battleWinCoins;
                
                playerSpider.xp += xpGained;
                
                while (playerSpider.xp >= gameBalance.xpPerLevel) {
                    playerSpider.xp -= gameBalance.xpPerLevel;
                    playerSpider.level++;
                    
                    Object.keys(playerSpider.stats).forEach(stat => {
                        playerSpider.stats[stat] += 2;
                    });
                    playerSpider.powerLevel += 2;
                }

                const currentCoins = getUserCoins();
                setUserCoins(currentCoins + coinsGained);

                battle.log.push(`üéâ ${battle.player.name} wins!`);
                battle.log.push(`Earned ${xpGained} XP and ${coinsGained} coins!`);
                
                if (playerSpider.level > battle.player.level) {
                    battle.log.push(`üåü ${battle.player.name} leveled up to level ${playerSpider.level}!`);
                }
            } else {
                playerSpider.losses = (playerSpider.losses || 0) + 1;
                enemySpider.wins = (enemySpider.wins || 0) + 1;
                
                battle.log.push(`üíî ${battle.player.name} lost the battle...`);
            }

            await saveData();
            renderBattle();

            setTimeout(() => {
                backToSpiderSelect();
            }, 4000);
        }

        function backToSpiderSelect() {
            document.getElementById('selectPhase').classList.remove('hidden');
            document.getElementById('opponentPhase').classList.add('hidden');
            document.getElementById('battlePhase').classList.add('hidden');
            selectedPlayerSpider = null;
            selectedEnemySpider = null;
            currentBattle = null;
            renderMySpiders();
        }

        function backToOpponentSelect() {
            document.getElementById('opponentPhase').classList.remove('hidden');
            document.getElementById('battlePhase').classList.add('hidden');
            currentBattle = null;
            renderOpponents();
        }

        // Initialize
        loadConfig();
        loadData();
    </script>
</body>
</html>