<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>Spider League</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 15px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto;
            width: 100%;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
        }
        
        h1 { 
            font-size: clamp(2em, 8vw, 3em);
            margin-bottom: 10px;
            word-break: break-word;
        }
        
        h2 {
            font-size: clamp(1.3em, 5vw, 1.8em);
        }
        
        h3 {
            font-size: clamp(1.1em, 4vw, 1.3em);
        }
        
        .nav-tabs {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            padding: 0 5px;
        }
        
        .tab-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: clamp(14px, 3.5vw, 16px);
            font-weight: bold;
            transition: all 0.3s;
            touch-action: manipulation;
            min-height: 44px;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%);
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .config-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px 15px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        
        .config-section h2 { margin-bottom: 15px; color: #4ecdc4; }
        
        .input-group { margin-bottom: 15px; }
        
        label { 
            display: block; 
            margin-bottom: 8px; 
            color: #aaa;
            font-size: clamp(14px, 3.5vw, 16px);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
            min-height: 44px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: 2px solid #4ecdc4;
            outline-offset: 2px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: clamp(14px, 3.5vw, 16px);
            font-weight: bold;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
            touch-action: manipulation;
            min-height: 44px;
        }
        
        button:active { transform: scale(0.95); }
        button:hover { transform: translateY(-2px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .spider-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .rarity-common { border-color: rgba(158, 158, 158, 0.8) !important; }
        .rarity-uncommon { border-color: rgba(30, 255, 0, 0.8) !important; }
        .rarity-rare { border-color: rgba(0, 112, 221, 0.8) !important; }
        .rarity-epic { border-color: rgba(163, 53, 238, 0.8) !important; }
        .rarity-legendary { border-color: rgba(255, 128, 0, 0.8) !important; }
        .rarity-mythic { 
            border-color: rgba(255, 0, 0, 0.8) !important;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
            animation: mythicGlow 2s infinite;
        }
        
        @keyframes mythicGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.5); }
            50% { box-shadow: 0 0 30px rgba(255, 0, 0, 0.8); }
        }
        
        .countdown-timer {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            font-size: 1.5em;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .countdown-timer.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            font-size: 2em;
            animation: shake 0.5s infinite;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .hat-slot {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            position: relative;
        }
        
        .hat-emoji {
            font-size: 4em;
            margin: 10px 0;
        }
        
        .hat-inventory-item {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 15px;
            align-items: center;
        }
        
        .hat-inventory-item .hat-emoji {
            font-size: 3em;
            margin: 0;
        }

        .spider-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .spider-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.3);
            touch-action: manipulation;
            position: relative;
        }
        
        .spider-image-container {
            position: relative;
            width: 100%;
            height: 180px;
            margin-bottom: 15px;
        }
        
        .spider-hat {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3em;
            z-index: 10;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
        }
        
        .spider-name {
            font-size: clamp(1.2em, 4vw, 1.5em);
            margin-bottom: 10px;
            color: #4ecdc4;
            word-break: break-word;
        }
        
        .stat {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            font-size: clamp(13px, 3.2vw, 15px);
        }
        
        .stat-allocator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .stat-allocator button {
            padding: 8px 16px;
            min-height: 40px;
            margin: 0;
        }
        
        .stat-allocator input {
            width: 60px;
            text-align: center;
            padding: 8px;
            min-height: 40px;
        }
        
        .points-remaining {
            background: rgba(255, 165, 0, 0.2);
            border: 2px solid rgba(255, 165, 0, 0.6);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin: 15px 0;
            font-size: 1.1em;
            color: #ffa500;
        }
        
        .user-coins {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            font-size: clamp(14px, 3.5vw, 16px);
            margin: 10px 5px;
        }
        
        .hidden { display: none; }
        
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-size: clamp(14px, 3.5vw, 16px);
        }
        
        .status.success {
            background: rgba(78, 205, 196, 0.2);
            border: 1px solid #4ecdc4;
        }
        
        .status.error {
            background: rgba(245, 87, 108, 0.2);
            border: 1px solid #f5576c;
        }

        .hp-bar {
            width: 100%;
            height: 28px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a6a0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(12px, 3vw, 14px);
            font-weight: bold;
            transition: width 0.5s;
        }

        .hp-fill.low {
            background: linear-gradient(90deg, #ff6b6b, #ee5a6f);
        }

        .battle-arena {
            background: rgba(0, 0, 0, 0.6);
            padding: 20px 15px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .battle-field {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        @media (min-width: 768px) {
            .battle-field {
                flex-direction: row;
                justify-content: space-between;
                gap: 30px;
            }
        }

        .fighter {
            flex: 1;
            min-width: 0;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
        }

        .fighter-image {
            width: 120px;
            height: 120px;
            border-radius: 10px;
            margin: 0 auto 15px;
            object-fit: cover;
            display: block;
        }
        
        @media (min-width: 768px) {
            .fighter-image {
                width: 150px;
                height: 150px;
            }
        }

        .battle-log {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            margin: 20px 0;
            border: 2px solid rgba(78, 205, 196, 0.3);
        }

        .battle-log-entry {
            padding: 6px;
            margin: 5px 0;
            border-left: 3px solid #4ecdc4;
            padding-left: 10px;
            animation: slideIn 0.3s;
            font-size: clamp(13px, 3.2vw, 15px);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .battle-actions {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        @media (min-width: 768px) {
            .battle-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .action-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
        }

        .action-section h3 {
            color: #4ecdc4;
            margin-bottom: 12px;
        }

        .move-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        @media (min-width: 480px) {
            .move-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .move-btn {
            background: rgba(102, 126, 234, 0.8);
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid rgba(102, 126, 234, 1);
            transition: all 0.3s;
            text-align: left;
            touch-action: manipulation;
            min-height: 44px;
        }

        .move-btn:active:not(:disabled) {
            background: rgba(102, 126, 234, 1);
            transform: scale(0.98);
        }

        .move-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .move-name {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: clamp(14px, 3.5vw, 16px);
        }

        .move-type {
            font-size: 11px;
            color: #ffa500;
            text-transform: uppercase;
        }

        .move-power {
            font-size: 12px;
            color: #aaa;
        }

        .item-btn {
            background: rgba(255, 165, 0, 0.8);
            padding: 12px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid rgba(255, 165, 0, 1);
            width: 100%;
            text-align: left;
            touch-action: manipulation;
            min-height: 44px;
        }

        .item-btn:active:not(:disabled) {
            background: rgba(255, 165, 0, 1);
            transform: scale(0.98);
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            min-height: 44px;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%);
        }

        .owner-history {
            font-size: 0.85em;
            color: #aaa;
            margin-top: 5px;
            font-style: italic;
        }

        .move-list {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 10px;
        }

        .inventory-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .inventory-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            font-size: clamp(14px, 3.5vw, 16px);
        }
        
        @media screen and (max-width: 767px) {
            input[type="text"],
            input[type="password"],
            input[type="number"],
            select,
            textarea {
                font-size: 16px !important;
            }
        }
        
        @supports (padding: max(0px)) {
            body {
                padding-left: max(15px, env(safe-area-inset-left));
                padding-right: max(15px, env(safe-area-inset-right));
                padding-bottom: max(15px, env(safe-area-inset-bottom));
            }
        }
        
        @keyframes pulse {
            0%, 100% { 
                background: rgba(255, 255, 255, 0.1);
            }
            50% { 
                background: rgba(255, 87, 108, 0.3);
                box-shadow: 0 0 20px rgba(255, 87, 108, 0.5);
            }
        }
        
        .bug-report-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .bug-report-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        .bug-report-btn:active {
            transform: translateY(0);
        }
        
        .bug-report-modal, .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .bug-report-modal.active, .login-modal.active {
            display: flex;
        }
        
        .bug-report-content, .login-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid #4ecdc4;
        }
        
        .bug-report-content h2, .login-content h2 {
            color: #4ecdc4;
            margin-bottom: 20px;
        }
        
        .bug-report-content textarea {
            width: 100%;
            min-height: 150px;
            margin-bottom: 15px;
            font-family: inherit;
        }
        
        @media (max-width: 640px) {
            .bug-report-btn {
                bottom: 15px;
                right: 15px;
                padding: 12px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🕷️ Spider League 🕷️</h1>
            <p id="tagline">Pokemon-Style Spider Battles!</p>
        </header>

        <div style="text-align: center; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap;">
            <button onclick="toggleConfig()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">⚙️ Settings</button>
            <div class="user-coins" id="userCoins">💰 0 coins</div>
            <button onclick="openLoginModal()" id="loginBtn" style="background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%);">👤 Login / Register</button>
            <button onclick="logout()" id="logoutBtn" class="hidden" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">🚪 Logout</button>
        </div>

        <div id="configSection" class="config-section hidden">
            <h2>⚙️ GitHub Configuration</h2>
            <div class="input-group">
                <label>GitHub Token:</label>
                <input type="password" id="githubToken" placeholder="ghp_...">
            </div>
            <div class="input-group">
                <label>Gist ID:</label>
                <input type="text" id="gistId" placeholder="Leave empty for first time">
            </div>
            <button onclick="saveConfig()">Save Configuration</button>
            <button onclick="loadData()">Refresh Data</button>
            <div id="configStatus"></div>
        </div>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('collection')">🕸️ Collection</button>
            <button class="tab-btn" onclick="switchTab('add')">➕ Add Spider</button>
            <button class="tab-btn" onclick="switchTab('battle')" id="battleTabBtn">⚔️ Battle</button>
            <button class="tab-btn" onclick="switchTab('trade')" id="tradeTabBtn">🔄 Trade</button>
            <button class="tab-btn" onclick="switchTab('shop')">🛒 Shop & Inventory</button>
            <button class="tab-btn" onclick="switchTab('hats')">🎩 Hats</button>
            <button class="tab-btn hidden" onclick="switchTab('admin')" id="adminTab">👑 Admin</button>
        </div>

        <div id="collectionTab" class="tab-content active">
            <div class="config-section">
                <h2>🕸️ Spider Collection</h2>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="setFilter('all')">All Spiders</button>
                    <button class="filter-btn" onclick="setFilter('mine')">My Spiders</button>
                </div>
                <div class="spider-grid" id="spiderGrid">
                    <p style="color: #666;">Loading spiders...</p>
                </div>
            </div>
        </div>

        <div id="addTab" class="tab-content">
            <div class="config-section">
                <h2>➕ Add New Spider</h2>
                <div class="input-group">
                    <label>Spider Name:</label>
                    <input type="text" id="spiderName" placeholder="e.g., Sir Websworth">
                </div>
                <div class="input-group">
                    <label>Latin Name (Scientific):</label>
                    <input type="text" id="spiderLatinName" placeholder="e.g., Araneus diadematus">
                </div>
                <div class="input-group">
                    <label>Spider Image:</label>
                    <div style="display: flex; gap: 10px; flex-direction: column;">
                        <input type="file" id="spiderImageFile" accept="image/*" onchange="handleImageUpload(event)" style="padding: 8px;">
                        <p style="color: #aaa; font-size: 0.85em; margin: 5px 0;">OR</p>
                        <input type="text" id="spiderImage" placeholder="Image URL (if not uploading)">
                    </div>
                    <div id="imagePreview" style="margin-top: 10px; display: none;">
                        <img id="previewImg" style="max-width: 200px; max-height: 200px; border-radius: 10px; border: 2px solid rgba(78, 205, 196, 0.5);">
                        <p style="color: #4ecdc4; font-size: 0.9em; margin-top: 5px;">✓ Image ready to upload</p>
                    </div>
                </div>
                
                <div class="points-remaining" id="pointsRemaining">
                    <strong>Points Remaining: <span id="pointsCount">100</span>/100</strong>
                </div>
                
                <div class="input-group">
                    <label>Strength:</label>
                    <div class="stat-allocator">
                        <button onclick="changeStat('strength', -1)">−</button>
                        <input type="number" id="strength" value="0" min="1" max="100" readonly>
                        <button onclick="changeStat('strength', 1)">+</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Speed:</label>
                    <div class="stat-allocator">
                        <button onclick="changeStat('speed', -1)">−</button>
                        <input type="number" id="speed" value="0" min="1" max="100" readonly>
                        <button onclick="changeStat('speed', 1)">+</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Size:</label>
                    <div class="stat-allocator">
                        <button onclick="changeStat('size', -1)">−</button>
                        <input type="number" id="size" value="0" min="1" max="100" readonly>
                        <button onclick="changeStat('size', 1)">+</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Venom:</label>
                    <div class="stat-allocator">
                        <button onclick="changeStat('venom', -1)">−</button>
                        <input type="number" id="venom" value="0" min="1" max="100" readonly>
                        <button onclick="changeStat('venom', 1)">+</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Toughness:</label>
                    <div class="stat-allocator">
                        <button onclick="changeStat('toughness', -1)">−</button>
                        <input type="number" id="toughness" value="0" min="1" max="100" readonly>
                        <button onclick="changeStat('toughness', 1)">+</button>
                    </div>
                </div>
                
                <h3 style="color: #4ecdc4; margin-top: 20px;">Custom Fields (Optional)</h3>
                <p style="color: #aaa; font-size: 0.9em; margin-bottom: 10px;">Add fun custom info (won't affect battles)</p>
                <div id="customFieldsContainer"></div>
                <button onclick="addCustomField()" style="background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%); margin-bottom: 15px;">+ Add Custom Field</button>
                
                <button onclick="addSpider()">Submit Spider for Approval</button>
                <div id="addStatus"></div>
            </div>
        </div>

        <div id="battleTab" class="tab-content">
            <div class="config-section">
                <h2>⚔️ Battle Arena</h2>
                <div id="battleSelectPhase">
                    <p style="color: #aaa; margin-bottom: 15px;">Select your spider to challenge an opponent:</p>
                    <div class="spider-grid" id="battleSelectSpiders"></div>
                </div>
                <div id="battleOpponentPhase" class="hidden">
                    <button onclick="backToBattleSelect()">← Back</button>
                    <p style="color: #aaa; margin: 15px 0;">Choose your opponent:</p>
                    <div class="spider-grid" id="battleOpponents"></div>
                </div>
                <div id="battleArenaPhase" class="hidden"></div>
            </div>
        </div>

        <div id="tradeTab" class="tab-content">
            <div class="config-section">
                <h2>🔄 Trade Center</h2>
                
                <div style="background: rgba(78, 205, 196, 0.1); border: 2px solid rgba(78, 205, 196, 0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #4ecdc4; margin-bottom: 10px;">📥 Incoming Trade Offers</h3>
                    <div id="incomingTrades"></div>
                </div>

                <div style="background: rgba(255, 165, 0, 0.1); border: 2px solid rgba(255, 165, 0, 0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #ffa500; margin-bottom: 10px;">📤 Outgoing Trade Offers</h3>
                    <div id="outgoingTrades"></div>
                </div>

                <div>
                    <h3 style="color: #4ecdc4; margin-bottom: 15px;">✨ Create Trade Offer</h3>
                    <p style="color: #aaa; margin-bottom: 15px;">Select one of your spiders to offer in trade:</p>
                    <div class="spider-grid" id="tradeMySpiders"></div>
                </div>
            </div>
        </div>

        <div id="hatsTab" class="tab-content">
            <div class="config-section">
                <h2>🎩 Hat Shop</h2>
                
                <div class="countdown-timer" id="hatCountdown">
                    Next hats in: --:--:--
                </div>
                
                <div class="spider-grid" id="dailyHatSlots"></div>
            </div>
            
            <div class="config-section">
                <h2>🎒 Your Hat Collection</h2>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center;">
                    <button class="filter-btn active" onclick="filterHats('all')">All Hats</button>
                    <button class="filter-btn" onclick="filterHats('equipped')">Equipped</button>
                    <button class="filter-btn" onclick="filterHats('unequipped')">Unequipped</button>
                    <button class="filter-btn" onclick="filterHats('common')">Common</button>
                    <button class="filter-btn" onclick="filterHats('uncommon')">Uncommon</button>
                    <button class="filter-btn" onclick="filterHats('rare')">Rare</button>
                    <button class="filter-btn" onclick="filterHats('epic')">Epic</button>
                    <button class="filter-btn" onclick="filterHats('legendary')">Legendary</button>
                    <button class="filter-btn" onclick="filterHats('mythic')">Mythic</button>
                </div>
                
                <div id="hatInventory"></div>
            </div>
        </div>

        <div id="shopTab" class="tab-content">
            <div class="config-section">
                <h2>🎒 Your Inventory</h2>
                <div id="inventoryDisplay" class="inventory-display">
                    <p style="color: #666;">Your items will appear here</p>
                </div>
            </div>
            <div class="config-section">
                <h2>🛒 Shop</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 3em;">⚡</div>
                        <h3>Potion</h3>
                        <p style="color: #aaa;">Restore 20 Toughness in battle</p>
                        <div style="color: #ffd700; font-weight: bold; margin: 10px 0; font-size: 1.2em;">💰 <span id="pricePotion">15</span> coins</div>
                        <button onclick="buyShopItem('potion')">Buy</button>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 3em;">💊</div>
                        <h3>Super Potion</h3>
                        <p style="color: #aaa;">Restore 50 Toughness in battle</p>
                        <div style="color: #ffd700; font-weight: bold; margin: 10px 0; font-size: 1.2em;">💰 <span id="priceSuperPotion">30</span> coins</div>
                        <button onclick="buyShopItem('superPotion')">Buy</button>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 3em;">✨</div>
                        <h3>Full Restore</h3>
                        <p style="color: #aaa;">Restore all Toughness in battle</p>
                        <div style="color: #ffd700; font-weight: bold; margin: 10px 0; font-size: 1.2em;">💰 <span id="priceFullRestore">50</span> coins</div>
                        <button onclick="buyShopItem('fullRestore')">Buy</button>
                    </div>
                </div>
                <div id="shopStatus"></div>
            </div>
        </div>

        <div id="adminTabContent" class="tab-content">
            <div class="config-section">
                <h2>👑 Admin Panel</h2>
                
                <div id="adminAccessDenied">
                    <p style="color: #f5576c;">⛔ Access Denied - Admin login required</p>
                </div>

                <div id="adminContent" class="hidden">
                    <div style="background: rgba(78, 205, 196, 0.1); border: 2px solid rgba(78, 205, 196, 0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #4ecdc4; margin-bottom: 10px;">📝 Direct Gist Access</h3>
                        <p style="color: #aaa; margin-bottom: 10px; font-size: 0.95em;">Edit the raw data directly on GitHub for advanced modifications:</p>
                        <a id="adminGistLink" href="#" target="_blank" style="display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%); color: white; text-decoration: none; border-radius: 25px; font-weight: bold;">
                            Open Gist in GitHub →
                        </a>
                        <p style="color: #ffa500; margin-top: 10px; font-size: 0.9em;">⚠️ Be careful when editing directly - invalid JSON will break the game!</p>
                    </div>

                    <h3 style="color: #4ecdc4;">📋 Spider Verification Queue</h3>
                    <div id="verificationQueue" style="margin-bottom: 30px;"></div>

                    <h3 style="color: #4ecdc4;">⚔️ Move List Editor</h3>
                    <p style="color: #aaa; margin-bottom: 10px;">Edit the list of moves available in the game (JSON format):</p>
                    <textarea id="adminMoves" rows="10" style="font-family: monospace; font-size: 12px;"></textarea>
                    <button onclick="saveMoveList()">Save Move List</button>

                    <h3 style="color: #4ecdc4; margin-top: 30px;">🛒 Shop Prices</h3>
                    <div class="input-group">
                        <label>Potion Price:</label>
                        <input type="number" id="adminPricePotion" min="0" value="15">
                    </div>
                    <div class="input-group">
                        <label>Super Potion Price:</label>
                        <input type="number" id="adminPriceSuperPotion" min="0" value="30">
                    </div>
                    <div class="input-group">
                        <label>Full Restore Price:</label>
                        <input type="number" id="adminPriceFullRestore" min="0" value="50">
                    </div>
                    <button onclick="saveShopPrices()">Save Shop Prices</button>

                    <h3 style="color: #4ecdc4; margin-top: 30px;">💬 Daily Taglines</h3>
                    <p style="color: #aaa; margin-bottom: 10px;">Edit the rotating taglines that appear in the header (one per line):</p>
                    <textarea id="adminTaglines" rows="8" style="font-family: inherit; font-size: 14px;" placeholder="Enter one tagline per line..."></textarea>
                    <button onclick="saveTaglines()">Save Taglines</button>

                    <div style="margin-top: 30px;" id="adminBugReports"></div>

                    <h3 style="color: #4ecdc4; margin-top: 30px;">👥 User Management</h3>
                    <div id="usersList" style="background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 5px;"></div>
                    
                    <div id="adminStatus"></div>
                </div>
            </div>
        </div>

        <button class="bug-report-btn" onclick="openBugReport()">
            🐛 Report Bug
        </button>

        <div id="loginModal" class="login-modal" onclick="closeLoginModalOnOverlay(event)">
            <div class="login-content" onclick="event.stopPropagation()">
                <h2>👤 Login / Register</h2>
                <div style="background: rgba(255, 165, 0, 0.2); border: 2px solid rgba(255, 165, 0, 0.6); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <strong style="color: #ffa500;">⚠️ Security Warning:</strong>
                    <p style="color: #ffcc00; margin-top: 8px; font-size: 0.95em;">
                        Your password will be hashed and stored in a GitHub Gist. <strong>DO NOT use a password you use anywhere else!</strong> This is a casual game - use a simple, unique password.
                    </p>
                </div>
                <div class="input-group">
                    <label>Username:</label>
                    <input type="text" id="username" placeholder="Enter username">
                </div>
                <div class="input-group">
                    <label>Password (use a unique password!):</label>
                    <input type="password" id="password" placeholder="Enter a simple, unique password">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="login()" style="flex: 1; background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%);">Login</button>
                    <button onclick="register()" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">Register</button>
                </div>
                <button onclick="closeLoginModal()" style="width: 100%; margin-top: 10px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">Cancel</button>
                <div id="loginStatus"></div>
            </div>
        </div>

        <div id="bugReportModal" class="bug-report-modal" onclick="closeBugReportOnOverlay(event)">
            <div class="bug-report-content" onclick="event.stopPropagation()">
                <h2>🐛 Report a Bug</h2>
                <p style="color: #aaa; margin-bottom: 15px;">Help us improve Spider League! Describe the bug you encountered.</p>
                
                <div class="input-group">
                    <label>What happened?</label>
                    <textarea id="bugDescription" placeholder="Describe the bug in detail..."></textarea>
                </div>
                
                <div class="input-group">
                    <label>Steps to reproduce (optional):</label>
                    <textarea id="bugSteps" rows="4" placeholder="1. Go to...&#10;2. Click on...&#10;3. See error"></textarea>
                </div>
                
                <div class="input-group">
                    <label>Your username (optional):</label>
                    <input type="text" id="bugReporterName" placeholder="So we can follow up with you">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="submitBugReport()" style="flex: 1; background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%);">Submit Report</button>
                    <button onclick="closeBugReport()" style="flex: 1; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">Cancel</button>
                </div>
                
                <div id="bugReportStatus"></div>
            </div>
        </div>
    </div>

    <script>
        // HAT SYSTEM
        const HAT_EMOJIS = ['🎩', '👑', '🧢', '⛑️', '🎓', '👒', '🪖', '🎖️', '⛷️', '🏔️', '🌟', '💎', '🔮', '👾', '🎯', '🎪', '🎭', '🎨', '🎬', '🎤', '🎧', '🎼', '🎹', '🎺', '🎸', '🥁', '🎻', '🎲', '🎰', '🎳'];
        const HAT_ADJECTIVES = ['Crimson', 'Golden', 'Azure', 'Emerald', 'Obsidian', 'Crystal', 'Mystic', 'Ancient', 'Ethereal', 'Radiant', 'Shadow', 'Frost', 'Flame', 'Storm', 'Lunar', 'Solar', 'Cosmic', 'Arcane', 'Divine', 'Cursed', 'Blessed', 'Legendary', 'Epic', 'Royal', 'Imperial', 'Noble', 'Savage', 'Wild', 'Primal', 'Eternal'];
        const HAT_NOUNS = ['Crown', 'Helm', 'Cap', 'Hat', 'Tiara', 'Circlet', 'Diadem', 'Coronet', 'Headpiece', 'Topper', 'Beret', 'Hood', 'Bandana', 'Turban', 'Headdress'];
        const HAT_TYPES = ['of Power', 'of Wisdom', 'of Speed', 'of Strength', 'of Venom', 'of Size', 'of Dominance', 'of Glory', 'of Victory', 'of Legends', 'of Champions', 'of Heroes', 'of Kings', 'of Queens', 'of Warriors', 'of Assassins', 'of Titans', 'of Gods'];
        
        let dailyHats = [];
        let hatInventory = [];
        let currentHatFilter = 'all';
        
        function generateHat() {
            const roll = Math.random();
            let rarity, statCount, minBonus, maxBonus, priceMin, priceMax;
            
            if (roll < 0.50) { // 50% Common
                rarity = 'common';
                statCount = 1;
                minBonus = 5;
                maxBonus = 15;
                priceMin = 500;
                priceMax = 1000;
            } else if (roll < 0.75) { // 25% Uncommon
                rarity = 'uncommon';
                statCount = Math.random() < 0.7 ? 1 : 2;
                minBonus = 10;
                maxBonus = 20;
                priceMin = 1000;
                priceMax = 1500;
            } else if (roll < 0.90) { // 15% Rare
                rarity = 'rare';
                statCount = Math.random() < 0.5 ? 1 : 2;
                minBonus = 15;
                maxBonus = 30;
                priceMin = 1500;
                priceMax = 2000;
            } else if (roll < 0.97) { // 7% Epic
                rarity = 'epic';
                statCount = Math.floor(Math.random() * 2) + 2; // 2-3
                minBonus = 20;
                maxBonus = 40;
                priceMin = 2000;
                priceMax = 2500;
            } else if (roll < 0.999) { // 2.9% Legendary
                rarity = 'legendary';
                statCount = Math.floor(Math.random() * 2) + 3; // 3-4
                minBonus = 30;
                maxBonus = 60;
                priceMin = 2500;
                priceMax = 3000;
            } else { // 0.1% Mythic
                rarity = 'mythic';
                statCount = 5; // All stats
                minBonus = 50;
                maxBonus = 100;
                priceMin = 5000;
                priceMax = 10000;
            }
            
            const stats = { strength: 0, speed: 0, size: 0, venom: 0, toughness: 0 };
            const statNames = ['strength', 'speed', 'size', 'venom', 'toughness'];
            const selectedStats = [...statNames].sort(() => Math.random() - 0.5).slice(0, statCount);
            
            selectedStats.forEach(stat => {
                stats[stat] = Math.floor(Math.random() * (maxBonus - minBonus + 1)) + minBonus;
            });
            
            const emoji = HAT_EMOJIS[Math.floor(Math.random() * HAT_EMOJIS.length)];
            const adj = HAT_ADJECTIVES[Math.floor(Math.random() * HAT_ADJECTIVES.length)];
            const noun = HAT_NOUNS[Math.floor(Math.random() * HAT_NOUNS.length)];
            const type = HAT_TYPES[Math.floor(Math.random() * HAT_TYPES.length)];
            const name = `${adj} ${noun} ${type}`;
            
            const price = Math.floor(Math.random() * (priceMax - priceMin + 1)) + priceMin;
            
            return {
                id: `hat_${Date.now()}_${Math.random()}`,
                name,
                emoji,
                rarity,
                stats,
                price,
                purchasedBy: null,
                purchasedAt: null,
                pricePaid: null,
                equippedTo: null,
                createdAt: new Date().toISOString()
            };
        }
        
        function initializeDailyHats() {
            const now = new Date();
            const lastReset = window.localStorage.getItem('lastHatReset');
            const today = now.toISOString().split('T')[0];
            
            if (lastReset !== today) {
                // Reset time! Remove unpurchased hats older than 24 hours
                const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString();
                dailyHats = dailyHats.filter(hat => {
                    // Keep if purchased OR if created today
                    return hat.purchasedBy !== null || hat.createdAt >= yesterday;
                });
                
                // Generate new hats to fill empty slots (up to 3 total)
                while (dailyHats.length < 3) {
                    const newHat = generateHat();
                    newHat.createdAt = now.toISOString();
                    dailyHats.push(newHat);
                }
                
                window.localStorage.setItem('lastHatReset', today);
                saveData();
            } else if (dailyHats.length === 0) {
                // First time initialization
                const hat1 = generateHat();
                const hat2 = generateHat();
                const hat3 = generateHat();
                hat1.createdAt = now.toISOString();
                hat2.createdAt = now.toISOString();
                hat3.createdAt = now.toISOString();
                dailyHats = [hat1, hat2, hat3];
                saveData();
            }
        }
        
        function getTimeUntilMidnight() {
            const now = new Date();
            const utcNow = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 
                                    now.getUTCHours(), now.getUTCMinutes(), now.getUTCSeconds());
            const midnight = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + 1, 0, 0, 0);
            return midnight - utcNow;
        }
        
        function updateHatCountdown() {
            const timeLeft = getTimeUntilMidnight();
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            const countdownEl = document.getElementById('hatCountdown');
            if (countdownEl) {
                countdownEl.textContent = `Next hats in: ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                if (hours < 5) {
                    countdownEl.classList.add('warning');
                } else {
                    countdownEl.classList.remove('warning');
                }
            }
            
            // Check if we need to reset
            if (timeLeft <= 0) {
                const today = new Date().toISOString().split('T')[0];
                const lastReset = window.localStorage.getItem('lastHatReset');
                if (lastReset !== today) {
                    initializeDailyHats();
                    renderDailyHats();
                }
            }
        }
        
        async function purchaseHat(slotIndex) {
            if (!currentUser) {
                alert('Please login first!');
                return;
            }
            
            const hat = dailyHats[slotIndex];
            if (!hat) {
                alert('Hat not found!');
                return;
            }
            
            const user = users.find(u => u.username === currentUser);
            
            if (user.coins < hat.price) {
                alert(`Not enough coins! You need ${hat.price} coins.`);
                return;
            }
            
            if (!confirm(`Purchase ${hat.name} for ${hat.price} coins?`)) {
                return;
            }
            
            user.coins -= hat.price;
            hat.purchasedBy = currentUser;
            hat.purchasedAt = new Date().toISOString();
            hat.pricePaid = hat.price;
            
            hatInventory.push(hat);
            
            // Remove from daily hats, leaving the slot empty
            dailyHats.splice(slotIndex, 1);
            
            await saveData();
            updateCoins();
            renderDailyHats();
            renderHatInventory();
            
            alert(`You purchased ${hat.name}!`);
        }
        
        function renderDailyHats() {
            const container = document.getElementById('dailyHatSlots');
            if (!container) return;
            
            // Ensure we always show 3 slots
            const slotsToShow = [];
            for (let i = 0; i < 3; i++) {
                if (dailyHats[i]) {
                    slotsToShow.push({ hat: dailyHats[i], index: i });
                } else {
                    slotsToShow.push({ hat: null, index: i });
                }
            }
            
            container.innerHTML = slotsToShow.map(({ hat, index }) => {
                if (!hat) {
                    return `
                        <div class="hat-slot" style="border: 2px dashed rgba(255, 255, 255, 0.3); opacity: 0.5;">
                            <div class="hat-emoji" style="font-size: 3em;">❓</div>
                            <h3 style="color: #666;">Empty Slot</h3>
                            <p style="color: #888; margin: 10px 0;">Check back after reset!</p>
                        </div>
                    `;
                }
                
                const statList = Object.entries(hat.stats)
                    .filter(([stat, value]) => value > 0)
                    .map(([stat, value]) => `+${value} ${stat.charAt(0).toUpperCase() + stat.slice(1)}`)
                    .join(', ');
                
                return `
                    <div class="hat-slot rarity-${hat.rarity}">
                        <div class="hat-emoji">${hat.emoji}</div>
                        <h3 style="color: #4ecdc4;">${hat.name}</h3>
                        <p style="color: #ffa500; text-transform: uppercase; font-weight: bold; margin: 10px 0;">${hat.rarity}</p>
                        <p style="color: #ddd; margin: 10px 0;">${statList}</p>
                        <p style="color: #ffd700; font-size: 1.3em; font-weight: bold; margin: 15px 0;">💰 ${hat.price} coins</p>
                        <button onclick="purchaseHat(${index})">Buy Hat</button>
                    </div>
                `;
            }).join('');
        }
        
        function filterHats(filter) {
            currentHatFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.textContent.toLowerCase().includes(filter.toLowerCase()) || 
                    (filter === 'all' && btn.textContent === 'All Hats')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            renderHatInventory();
        }
        
        function renderHatInventory() {
            const container = document.getElementById('hatInventory');
            if (!container) return;
            
            if (!currentUser) {
                container.innerHTML = '<p style="color: #666;">Please login to see your hats!</p>';
                return;
            }
            
            const userHats = hatInventory.filter(h => h.purchasedBy === currentUser);
            
            let filtered = userHats;
            if (currentHatFilter === 'equipped') {
                filtered = userHats.filter(h => h.equippedTo !== null);
            } else if (currentHatFilter === 'unequipped') {
                filtered = userHats.filter(h => h.equippedTo === null);
            } else if (currentHatFilter !== 'all') {
                filtered = userHats.filter(h => h.rarity === currentHatFilter);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="color: #666;">No hats match this filter.</p>';
                return;
            }
            
            container.innerHTML = filtered.map(hat => {
                const equippedSpider = hat.equippedTo ? spiders.find(s => s.id === hat.equippedTo) : null;
                const statList = Object.entries(hat.stats)
                    .filter(([stat, value]) => value > 0)
                    .map(([stat, value]) => `+${value} ${stat.charAt(0).toUpperCase() + stat.slice(1)}`)
                    .join(', ');
                
                const purchaseDate = new Date(hat.purchasedAt).toLocaleDateString();
                
                return `
                    <div class="hat-inventory-item rarity-${hat.rarity}">
                        <div class="hat-emoji">${hat.emoji}</div>
                        <div style="flex: 1;">
                            <h3 style="color: #4ecdc4; margin-bottom: 5px;">${hat.name}</h3>
                            <p style="color: #ffa500; text-transform: uppercase; font-size: 0.9em; font-weight: bold;">${hat.rarity}</p>
                            <p style="color: #ddd; margin: 5px 0;">${statList}</p>
                            <p style="color: #aaa; font-size: 0.85em; margin-top: 8px;">
                                Purchased: ${purchaseDate} for ${hat.pricePaid} coins
                            </p>
                            ${equippedSpider ? 
                                `<p style="color: #4ecdc4; font-size: 0.9em; margin-top: 5px;">✓ Equipped to: ${equippedSpider.name}</p>
                                <button onclick="unequipHat('${hat.id}')" style="margin-top: 10px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">Remove Hat</button>` :
                                `<button onclick="openEquipHatModal('${hat.id}')" style="margin-top: 10px;">Equip to Spider</button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function openEquipHatModal(hatId) {
            const hat = hatInventory.find(h => h.id === hatId);
            const mySpiders = spiders.filter(s => s.owner === currentUser && s.verified);
            
            if (mySpiders.length === 0) {
                alert('You have no spiders to equip this hat to!');
                return;
            }
            
            const spiderList = mySpiders.map((s, i) => `${i + 1}. ${s.name}`).join('\n');
            const choice = prompt(`Equip ${hat.name} to which spider?\n\n${spiderList}\n\nEnter the number:`);
            
            if (!choice) return;
            
            const index = parseInt(choice) - 1;
            if (index < 0 || index >= mySpiders.length) {
                alert('Invalid choice!');
                return;
            }
            
            equipHatToSpider(hatId, mySpiders[index].id);
        }
        
        async function equipHatToSpider(hatId, spiderId) {
            const hat = hatInventory.find(h => h.id === hatId);
            const spider = spiders.find(s => s.id === spiderId);
            
            if (!hat || !spider) return;
            
            // Remove hat from any other spider
            if (spider.hatId) {
                const oldHat = hatInventory.find(h => h.id === spider.hatId);
                if (oldHat) oldHat.equippedTo = null;
            }
            
            // Unequip this hat from any spider
            if (hat.equippedTo) {
                const oldSpider = spiders.find(s => s.id === hat.equippedTo);
                if (oldSpider) oldSpider.hatId = null;
            }
            
            // Equip the hat
            hat.equippedTo = spiderId;
            spider.hatId = hatId;
            
            await saveData();
            renderHatInventory();
            renderSpiders();
            
            alert(`Equipped ${hat.name} to ${spider.name}!`);
        }
        
        async function unequipHat(hatId) {
            const hat = hatInventory.find(h => h.id === hatId);
            if (!hat) return;
            
            const spider = spiders.find(s => s.id === hat.equippedTo);
            
            hat.equippedTo = null;
            if (spider) spider.hatId = null;
            
            await saveData();
            renderHatInventory();
            renderSpiders();
            
            alert('Hat removed!');
        }
        
        function getSpiderWithHatStats(spider) {
            const baseStats = {
                strength: spider.strength,
                speed: spider.speed,
                size: spider.size,
                venom: spider.venom,
                toughness: spider.toughness,
                maxToughness: spider.maxToughness
            };
            
            if (!spider.hatId) return baseStats;
            
            const hat = hatInventory.find(h => h.id === spider.hatId);
            if (!hat) return baseStats;
            
            return {
                strength: baseStats.strength + (hat.stats.strength || 0),
                speed: baseStats.speed + (hat.stats.speed || 0),
                size: baseStats.size + (hat.stats.size || 0),
                venom: baseStats.venom + (hat.stats.venom || 0),
                toughness: baseStats.toughness + (hat.stats.toughness || 0),
                maxToughness: baseStats.maxToughness + (hat.stats.toughness || 0)
            };
        }

        document.addEventListener('DOMContentLoaded', function() {
            try {
                initializeDailyHats();
                renderDailyHats();
                renderHatInventory();
                updateHatCountdown();
                if (!window.__hatTimerStarted) {
                    window.__hatTimerStarted = true;
                    setInterval(updateHatCountdown, 1000);
                }
            } catch (e) { /* ignore bootstrap errors */ }
        });

        // Move list with stat-based scaling
        let MOVE_LIST = [
            // Strength-based moves
            { name: "Bite", stat: "strength", basePower: 50, effect: null },
            { name: "Venom Fang", stat: "strength", basePower: 60, effect: null },
            { name: "Reckless Charge", stat: "strength", basePower: 90, effect: { type: "recoil", percent: 0.25 } },
            { name: "Wild Tackle", stat: "strength", basePower: 70, effect: { type: "recoil", percent: 0.2 } },
            
            // Speed-based moves
            { name: "Quick Strike", stat: "speed", basePower: 35, effect: null },
            { name: "Agility", stat: "speed", basePower: 0, effect: { type: "boost", stat: "speed", amount: 15 } },
            { name: "Assassination", stat: "speed", basePower: 55, effect: { type: "guaranteed_crit" } },
            
            // Size-based moves
            { name: "Body Slam", stat: "size", basePower: 55, effect: null },
            { name: "Intimidate", stat: "size", basePower: 45, effect: { type: "accuracy_down", amount: 15, turns: 2 } },
            
            // Venom-based moves
            { name: "Poison Sting", stat: "venom", basePower: 30, effect: { type: "poison", chance: 0.5, damage: 8 } },
            { name: "Toxic Bite", stat: "venom", basePower: 40, effect: { type: "poison", chance: 0.8, damage: 12 } },
            { name: "Venom Drain", stat: "venom", basePower: 50, effect: { type: "drain", percent: 0.6 } },
            
            // Multi-stat moves
            { name: "Web Barrage", stat: "speed", basePower: 25, effect: { type: "multihit", hits: 3 } },
            { name: "Fury Swipes", stat: "strength", basePower: 18, effect: { type: "multihit", hits: 4 } },
            { name: "Silk Trap", stat: "size", basePower: 20, effect: { type: "trap", damage: 10, turns: 2 } },
            { name: "Sticky Web", stat: "venom", basePower: 0, effect: { type: "slow", amount: 10, turns: 3 } },
            { name: "Web Shot", stat: "speed", basePower: 40, effect: { type: "slow", amount: 5, turns: 2 } }
        ];

        let config = { githubToken: '', gistId: '' };
        let spiders = [];
        let users = [];
        let shopPrices = { potion: 15, superPotion: 30, fullRestore: 50 };
        let currentUser = '';
        let currentFilter = 'all';
        let battleState = null;
        let selectedBattleSpider = null;
        let tradeOffers = [];
        let customFieldsCount = 0;
        let uploadedImageData = null;
        let bugReports = [];
        let activeBattles = [];
        let taglines = [
            "Spider League: Because Therapy Was Booked",
            "Eight Legs, Zero Thoughts",
            "Your Mom's Favorite",
            "Locally Sourced, Free-Range Spiders",
            "We Have Spiders at Home",
            "Spider League: It's Giving Arachnid",
            "No Thoughts, Just Spiders",
            "Spider League: Unhinged Since Tuesday",
            "POV You are a Spider",
            "Spiders But Make It Your Entire Personality"
        ];

        function initBattleEffects() {
            return {
                poison: { active: false, damage: 0 },
                trapped: { active: false, damage: 0, turns: 0 },
                speedMod: 0,
                strengthMod: 0,
                sizeMod: 0,
                venomMod: 0,
                toughnessMod: 0,
                accuracyMod: 0,
                charging: { active: false, move: null }
            };
        }
        
        function getDailyTagline() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            const index = dayOfYear % taglines.length;
            return taglines[index];
        }
        
        function updateTagline() {
            const taglineElement = document.getElementById('tagline');
            if (taglineElement) {
                taglineElement.textContent = getDailyTagline();
            }
        }

        function calculateXpForLevel(level) {
            return Math.floor(100 * Math.pow(level, 1.5));
        }
        
        function calculateXpReward(enemyLevel, won) {
            const xpForNextLevel = calculateXpForLevel(enemyLevel);
            const baseXp = Math.floor(xpForNextLevel * 0.05);
            return won ? baseXp : Math.floor(baseXp * 0.5);
        }
        
        function levelUpSpider(spider) {
            spider.level++;
            spider.xp = 0;
            
            const strengthGain = Math.min(5, Math.floor(Math.random() * 3) + 1);
            const speedGain = Math.min(5, Math.floor(Math.random() * 3) + 1);
            const sizeGain = Math.min(5, Math.floor(Math.random() * 3) + 1);
            const venomGain = Math.min(5, Math.floor(Math.random() * 3) + 1);
            const toughnessGain = Math.min(20, Math.floor(Math.random() * 15) + 5);
            
            spider.strength += strengthGain;
            spider.speed += speedGain;
            spider.size += sizeGain;
            spider.venom += venomGain;
            spider.maxToughness += toughnessGain;
            spider.toughness += toughnessGain;
            
            return {
                strengthGain,
                speedGain,
                sizeGain,
                venomGain,
                toughnessGain
            };
        }
        
        function addXpToSpider(spider, xp) {
            if (!spider.xp) spider.xp = 0;
            
            spider.xp += xp;
            const xpNeeded = calculateXpForLevel(spider.level);
            
            const levelUps = [];
            while (spider.xp >= xpNeeded) {
                const gains = levelUpSpider(spider);
                levelUps.push({
                    level: spider.level,
                    gains: gains
                });
                
                if (spider.xp >= calculateXpForLevel(spider.level)) {
                    continue;
                } else {
                    break;
                }
            }
            
            return levelUps;
        }

        function changeStat(statName, delta) {
            const statInput = document.getElementById(statName);
            const currentValue = parseInt(statInput.value);
            const newValue = currentValue + delta;
            
            const pointsCount = document.getElementById('pointsCount');
            const currentPoints = parseInt(pointsCount.textContent);
            
            if (delta > 0 && currentPoints <= 0) return;
            if (delta < 0 && newValue < 0) return;
            if (newValue > 100) return;
            
            statInput.value = newValue;
            pointsCount.textContent = currentPoints - delta;
            
            const remaining = parseInt(pointsCount.textContent);
            const pointsDisplay = document.getElementById('pointsRemaining');
            if (remaining === 0) {
                pointsDisplay.style.borderColor = 'rgba(78, 205, 196, 0.6)';
                pointsDisplay.style.background = 'rgba(78, 205, 196, 0.2)';
            } else {
                pointsDisplay.style.borderColor = 'rgba(255, 165, 0, 0.6)';
                pointsDisplay.style.background = 'rgba(255, 165, 0, 0.2)';
            }
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                uploadedImageData = null;
                document.getElementById('imagePreview').style.display = 'none';
                return;
            }

            if (file.size > 2 * 1024 * 1024) {
                alert('Image too large! Please use an image under 2MB.');
                event.target.value = '';
                uploadedImageData = null;
                document.getElementById('imagePreview').style.display = 'none';
                return;
            }

            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file!');
                event.target.value = '';
                uploadedImageData = null;
                document.getElementById('imagePreview').style.display = 'none';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImageData = e.target.result;
                
                const preview = document.getElementById('imagePreview');
                const previewImg = document.getElementById('previewImg');
                previewImg.src = uploadedImageData;
                preview.style.display = 'block';

                document.getElementById('spiderImage').value = '';
            };
            reader.readAsDataURL(file);
        }
        
        function addCustomField() {
            customFieldsCount++;
            const container = document.getElementById('customFieldsContainer');
            const fieldId = `customField_${customFieldsCount}`;
            
            const fieldHTML = `
                <div id="${fieldId}" style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <label style="font-size: 0.9em;">Field Name:</label>
                            <input type="text" class="custom-field-name" placeholder="e.g., Cuteness, Mood" style="margin-top: 5px;">
                        </div>
                        <div style="flex: 1;">
                            <label style="font-size: 0.9em;">Value:</label>
                            <input type="text" class="custom-field-value" placeholder="Any value" style="margin-top: 5px;">
                        </div>
                    </div>
                    <button onclick="removeCustomField('${fieldId}')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 8px 16px; font-size: 0.9em;">Remove</button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', fieldHTML);
        }
        
        function removeCustomField(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) field.remove();
        }
        
        function getCustomFields() {
            const container = document.getElementById('customFieldsContainer');
            const fields = [];
            
            const fieldDivs = container.querySelectorAll('[id^="customField_"]');
            fieldDivs.forEach(div => {
                const name = div.querySelector('.custom-field-name').value.trim();
                const value = div.querySelector('.custom-field-value').value.trim();
                
                if (name && value) {
                    fields.push({ name, value });
                }
            });
            
            return fields;
        }
        
        function clearCustomFields() {
            document.getElementById('customFieldsContainer').innerHTML = '';
            customFieldsCount = 0;
        }

        function toggleConfig() {
            document.getElementById('configSection').classList.toggle('hidden');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'collection') {
                document.getElementById('collectionTab').classList.add('active');
            } else if (tab === 'add') {
                document.getElementById('addTab').classList.add('active');
            } else if (tab === 'battle') {
                document.getElementById('battleTab').classList.add('active');
                renderBattleSelect();
            } else if (tab === 'trade') {
                document.getElementById('tradeTab').classList.add('active');
                renderTradeTab();
                updateTradeTabIndicator();
            } else if (tab === 'hats') {
                document.getElementById('hatsTab').classList.add('active');
                try {
                    initializeDailyHats();
                    renderDailyHats();
                    renderHatInventory();
                } catch (e) { /* no-op if not loaded yet */ }
            } else if (tab === 'shop') {
                document.getElementById('shopTab').classList.add('active');
                updateShopPrices();
                renderInventory();
            } else if (tab === 'admin') {
                document.getElementById('adminTabContent').classList.add('active');
                checkAdminAccess();
            }
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderSpiders();
        }

        function showStatus(id, msg, type) {
            const el = document.getElementById(id);
            if (!el) return;
            el.textContent = msg;
            el.className = `status ${type}`;
            setTimeout(() => el.className = 'status hidden', 3000);
        }

        function showUserInfo() {
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            if (currentUser === 'admin') {
                document.getElementById('adminTab').classList.remove('hidden');
            }
            updateCoins();
            closeLoginModal();
        }

        function updateCoins() {
            const user = users.find(u => u.username === currentUser);
            const coins = user ? user.coins || 0 : 0;
            const coinsDisplay = document.getElementById('userCoins');
            
            if (currentUser) {
                coinsDisplay.textContent = `💰 ${coins} coins`;
                coinsDisplay.title = `Logged in as ${currentUser}`;
            } else {
                coinsDisplay.textContent = '💰 Login';
                coinsDisplay.title = 'Click to login';
            }
        }

        function openLoginModal() {
            document.getElementById('loginModal').classList.add('active');
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginStatus').innerHTML = '';
        }

        function closeLoginModalOnOverlay(event) {
            if (event.target.id === 'loginModal') {
                closeLoginModal();
            }
        }

        function getUserInventory() {
            const user = users.find(u => u.username === currentUser);
            if (!user) return {};
            if (!user.inventory) {
                user.inventory = {};
            }
            return user.inventory;
        }

        function setUserInventory(inventory) {
            const user = users.find(u => u.username === currentUser);
            if (user) {
                user.inventory = inventory;
            }
        }

        function generateMoves(spider) {
            const shuffled = [...MOVE_LIST].sort(() => Math.random() - 0.5);
            const moves = shuffled.slice(0, 4).map(move => ({
                ...move,
                power: move.basePower + Math.floor(spider.level * 3)
            }));
            return moves;
        }
        
        function updateMovePower(spider) {
            if (spider.moves) {
                spider.moves = spider.moves.map(move => ({
                    ...move,
                    power: move.basePower + Math.floor(spider.level * 3)
                }));
            }
        }

        function loadConfig() {
            const saved = window.localStorage.getItem('spiderConfig');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('githubToken').value = config.githubToken || '';
                document.getElementById('gistId').value = config.gistId || '';
            }

            const savedUser = window.localStorage.getItem('spiderUser');
            if (savedUser) {
                currentUser = savedUser;
                showUserInfo();
            }

            loadData();
        }

        function saveConfig() {
            config.githubToken = document.getElementById('githubToken').value.trim();
            config.gistId = document.getElementById('gistId').value.trim();
            window.localStorage.setItem('spiderConfig', JSON.stringify(config));
            showStatus('configStatus', 'Configuration saved!', 'success');
            if (config.gistId) loadData();
        }

        async function register() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showStatus('loginStatus', 'Enter username and password!', 'error');
                return;
            }

            if (username.length < 3) {
                showStatus('loginStatus', 'Username must be 3+ characters', 'error');
                return;
            }
            
            if (password.length < 4) {
                showStatus('loginStatus', 'Password must be 4+ characters', 'error');
                return;
            }

            if (users.find(u => u.username === username)) {
                showStatus('loginStatus', 'Username already taken!', 'error');
                return;
            }
            
            const confirmed = confirm(
                '⚠️ SECURITY WARNING ⚠️\n\n' +
                'Your password will be hashed and stored in a GitHub Gist.\n\n' +
                'DO NOT use a password you use for any other account!\n\n' +
                'Only use a simple, unique password for this game.\n\n' +
                'Click OK to confirm you understand and want to register.'
            );
            
            if (!confirmed) {
                return;
            }

            users.push({
                username,
                password,
                coins: 100,
                inventory: {},
                createdAt: new Date().toISOString()
            });

            if (await saveData()) {
                currentUser = username;
                window.localStorage.setItem('spiderUser', username);
                showUserInfo();
                showStatus('loginStatus', 'Registered! You start with 100 coins!', 'success');
            }
        }

        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showStatus('loginStatus', 'Enter username and password!', 'error');
                return;
            }

            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                currentUser = username;
                window.localStorage.setItem('spiderUser', username);
                showUserInfo();
                showStatus('loginStatus', 'Logged in successfully!', 'success');
                renderSpiders();
                renderHatInventory();
            } else {
                showStatus('loginStatus', 'Invalid username or password!', 'error');
            }
        }

        function logout() {
            if (!confirm('Logout?')) return;
            currentUser = '';
            window.localStorage.removeItem('spiderUser');
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('adminTab').classList.add('hidden');
            updateCoins();
            renderSpiders();
            renderHatInventory();
        }

        let saveTimeout = null;
        let pendingSave = false;

        async function loadData() {
            if (!config.githubToken || !config.gistId) return;

            try {
                const response = await fetch(`https://api.github.com/gists/${config.gistId}`, {
                    headers: {
                        'Authorization': `token ${config.githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) return;

                const data = await response.json();
                const content = JSON.parse(data.files['spider-league.json'].content);
                
                spiders = content.spiders || [];
                users = content.users || [];
                shopPrices = content.shopPrices || shopPrices;
                MOVE_LIST = content.moveList || MOVE_LIST;
                taglines = content.taglines || taglines;
                tradeOffers = content.tradeOffers || [];
                bugReports = content.bugReports || [];
                activeBattles = content.activeBattles || [];
                dailyHats = content.dailyHats || [];
                hatInventory = content.hatInventory || [];
                
                renderSpiders();
                updateCoins();
                updateShopPrices();
                renderInventory();
                updateTagline();
                updateTradeTabIndicator();
                renderDailyHats();
                renderHatInventory();
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        function debouncedSave() {
            pendingSave = true;
            
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            
            saveTimeout = setTimeout(async () => {
                await saveDataNow();
                pendingSave = false;
            }, 2000);
        }

        async function saveData() {
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            return await saveDataNow();
        }

        async function saveDataNow() {
            if (!config.githubToken) {
                console.error('No GitHub token configured');
                return false;
            }

            const data = { spiders, users, shopPrices, moveList: MOVE_LIST, taglines, tradeOffers, bugReports, activeBattles, dailyHats, hatInventory };

            try {
                if (!config.gistId) {
                    const response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${config.githubToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            description: 'Spider League Data',
                            public: false,
                            files: {
                                'spider-league.json': {
                                    content: JSON.stringify(data, null, 2)
                                }
                            }
                        })
                    });

                    if (!response.ok) return false;

                    const result = await response.json();
                    config.gistId = result.id;
                    document.getElementById('gistId').value = config.gistId;
                    window.localStorage.setItem('spiderConfig', JSON.stringify(config));
                    alert(`Gist created! ID: ${config.gistId}\n\nShare this with friends!`);
                } else {
                    const response = await fetch(`https://api.github.com/gists/${config.gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${config.githubToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            files: {
                                'spider-league.json': {
                                    content: JSON.stringify(data, null, 2)
                                }
                            }
                        })
                    });

                    if (!response.ok) return false;
                }

                return true;
            } catch (error) {
                console.error('Save error:', error);
                return false;
            }
        }
