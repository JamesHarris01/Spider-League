<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>Spider League</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 15px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto;
            width: 100%;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
        }
        
        h1 { 
            font-size: clamp(2em, 8vw, 3em);
            margin-bottom: 10px;
            word-break: break-word;
        }
        
        h2 {
            font-size: clamp(1.3em, 5vw, 1.8em);
        }
        
        h3 {
            font-size: clamp(1.1em, 4vw, 1.3em);
        }
        
        .nav-tabs {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            padding: 0 5px;
        }
        
        .tab-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: clamp(14px, 3.5vw, 16px);
            font-weight: bold;
            transition: all 0.3s;
            touch-action: manipulation;
            min-height: 44px;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%);
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .config-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px 15px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        
        .config-section h2 { margin-bottom: 15px; color: #4ecdc4; }
        
        .input-group { margin-bottom: 15px; }
        
        label { 
            display: block; 
            margin-bottom: 8px; 
            color: #aaa;
            font-size: clamp(14px, 3.5vw, 16px);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
            min-height: 44px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: 2px solid #4ecdc4;
            outline-offset: 2px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: clamp(14px, 3.5vw, 16px);
            font-weight: bold;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
            touch-action: manipulation;
            min-height: 44px;
        }
        
        button:active { transform: scale(0.95); }
        button:hover { transform: translateY(-2px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .spider-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        @media (max-width: 640px) {
            .spider-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .spider-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .spider-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.3);
            touch-action: manipulation;
        }
        
        .spider-name {
            font-size: clamp(1.2em, 4vw, 1.5em);
            margin-bottom: 10px;
            color: #4ecdc4;
            word-break: break-word;
        }
        
        .stat {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            font-size: clamp(13px, 3.2vw, 15px);
        }
        
        .user-coins {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            font-size: clamp(14px, 3.5vw, 16px);
            margin: 10px 5px;
        }
        
        .hidden { display: none; }
        
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-size: clamp(14px, 3.5vw, 16px);
        }
        
        .status.success {
            background: rgba(78, 205, 196, 0.2);
            border: 1px solid #4ecdc4;
        }
        
        .status.error {
            background: rgba(245, 87, 108, 0.2);
            border: 1px solid #f5576c;
        }

        .hp-bar {
            width: 100%;
            height: 28px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a6a0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(12px, 3vw, 14px);
            font-weight: bold;
            transition: width 0.5s;
        }

        .hp-fill.low {
            background: linear-gradient(90deg, #ff6b6b, #ee5a6f);
        }

        .battle-arena {
            background: rgba(0, 0, 0, 0.6);
            padding: 20px 15px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .battle-field {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        @media (min-width: 768px) {
            .battle-field {
                flex-direction: row;
                justify-content: space-between;
                gap: 30px;
            }
        }

        .fighter {
            flex: 1;
            min-width: 0;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
        }

        .fighter-image {
            width: 120px;
            height: 120px;
            border-radius: 10px;
            margin: 0 auto 15px;
            object-fit: cover;
            display: block;
        }
        
        @media (min-width: 768px) {
            .fighter-image {
                width: 150px;
                height: 150px;
            }
        }

        .battle-log {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            margin: 20px 0;
            border: 2px solid rgba(78, 205, 196, 0.3);
        }

        .battle-log-entry {
            padding: 6px;
            margin: 5px 0;
            border-left: 3px solid #4ecdc4;
            padding-left: 10px;
            animation: slideIn 0.3s;
            font-size: clamp(13px, 3.2vw, 15px);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .battle-actions {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        @media (min-width: 768px) {
            .battle-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .action-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
        }

        .action-section h3 {
            color: #4ecdc4;
            margin-bottom: 12px;
        }

        .move-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        @media (min-width: 480px) {
            .move-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .move-btn {
            background: rgba(102, 126, 234, 0.8);
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid rgba(102, 126, 234, 1);
            transition: all 0.3s;
            text-align: left;
            touch-action: manipulation;
            min-height: 44px;
        }

        .move-btn:active:not(:disabled) {
            background: rgba(102, 126, 234, 1);
            transform: scale(0.98);
        }

        .move-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .move-name {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: clamp(14px, 3.5vw, 16px);
        }

        .move-type {
            font-size: 11px;
            color: #ffa500;
            text-transform: uppercase;
        }

        .move-power {
            font-size: 12px;
            color: #aaa;
        }

        .item-btn {
            background: rgba(255, 165, 0, 0.8);
            padding: 12px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid rgba(255, 165, 0, 1);
            width: 100%;
            text-align: left;
            touch-action: manipulation;
            min-height: 44px;
        }

        .item-btn:active:not(:disabled) {
            background: rgba(255, 165, 0, 1);
            transform: scale(0.98);
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            min-height: 44px;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%);
        }

        .owner-history {
            font-size: 0.85em;
            color: #aaa;
            margin-top: 5px;
            font-style: italic;
        }

        .move-list {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 10px;
        }

        .inventory-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .inventory-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            font-size: clamp(14px, 3.5vw, 16px);
        }
        
        /* Prevent iOS zoom on input focus */
        @media screen and (max-width: 767px) {
            input[type="text"],
            input[type="password"],
            input[type="number"],
            select,
            textarea {
                font-size: 16px !important;
            }
        }
        
        /* Safe area support for notched devices */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(15px, env(safe-area-inset-left));
                padding-right: max(15px, env(safe-area-inset-right));
                padding-bottom: max(15px, env(safe-area-inset-bottom));
            }
        }
        
        /* Battle tab pulse animation */
        @keyframes pulse {
            0%, 100% { 
                background: rgba(255, 255, 255, 0.1);
            }
            50% { 
                background: rgba(255, 87, 108, 0.3);
                box-shadow: 0 0 20px rgba(255, 87, 108, 0.5);
            }
        }
        
        /* Bug report button */
        .bug-report-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .bug-report-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        .bug-report-btn:active {
            transform: translateY(0);
        }
        
        .bug-report-modal, .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .bug-report-modal.active, .login-modal.active {
            display: flex;
        }
        
        .bug-report-content, .login-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid #4ecdc4;
        }
        
        .bug-report-content h2, .login-content h2 {
            color: #4ecdc4;
            margin-bottom: 20px;
        }
        
        .bug-report-content textarea {
            width: 100%;
            min-height: 150px;
            margin-bottom: 15px;
            font-family: inherit;
        }
        
        @media (max-width: 640px) {
            .bug-report-btn {
                bottom: 15px;
                right: 15px;
                padding: 12px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üï∑Ô∏è Spider League üï∑Ô∏è</h1>
            <p id="tagline">Pokemon-Style Spider Battles!</p>
        </header>

        <div style="text-align: center; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap;">
            <button onclick="toggleConfig()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">‚öôÔ∏è Settings</button>
            <span class="user-coins" id="userCoins" style="cursor: pointer;" onclick="openLoginModal()">üí∞ 0 coins</span>
            <button onclick="openLoginModal()" id="loginBtn" style="background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%);">üë§ Login / Register</button>
            <button onclick="logout()" id="logoutBtn" class="hidden" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">üö™ Logout</button>
        </div>

        <div id="configSection" class="config-section hidden">
            <h2>‚öôÔ∏è GitHub Configuration</h2>
            <div class="input-group">
                <label>GitHub Token:</label>
                <input type="password" id="githubToken" placeholder="ghp_...">
            </div>
            <div class="input-group">
                <label>Gist ID:</label>
                <input type="text" id="gistId" placeholder="Leave empty for first time">
            </div>
            <button onclick="saveConfig()">Save Configuration</button>
            <button onclick="loadData()">Refresh Data</button>
            <div id="configStatus"></div>
        </div>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('collection')">üï∏Ô∏è Collection</button>
            <button class="tab-btn" onclick="switchTab('add')">‚ûï Add Spider</button>
            <button class="tab-btn" onclick="switchTab('battle')" id="battleTabBtn">‚öîÔ∏è Battle</button>
            <button class="tab-btn" onclick="switchTab('trade')" id="tradeTabBtn">üîÑ Trade</button>
            <button class="tab-btn" onclick="switchTab('shop')">üõí Shop & Inventory</button>
            <button class="tab-btn hidden" onclick="switchTab('admin')" id="adminTab">üëë Admin</button>
        </div>

        <!-- Collection Tab -->
        <div id="collectionTab" class="tab-content active">
            <div class="config-section">
                <h2>üï∏Ô∏è Spider Collection</h2>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="setFilter('all')">All Spiders</button>
                    <button class="filter-btn" onclick="setFilter('mine')">My Spiders</button>
                </div>
                <div class="spider-grid" id="spiderGrid">
                    <p style="color: #666;">Loading spiders...</p>
                </div>
            </div>
        </div>

        <!-- Add Spider Tab -->
        <div id="addTab" class="tab-content">
            <div class="config-section">
                <h2>‚ûï Add New Spider</h2>
                <div class="input-group">
                    <label>Spider Name:</label>
                    <input type="text" id="spiderName" placeholder="e.g., Sir Websworth">
                </div>
                <div class="input-group">
                    <label>Latin Name (Scientific):</label>
                    <input type="text" id="spiderLatinName" placeholder="e.g., Araneus diadematus">
                </div>
                <div class="input-group">
                    <label>Spider Image:</label>
                    <div style="display: flex; gap: 10px; flex-direction: column;">
                        <input type="file" id="spiderImageFile" accept="image/*" onchange="handleImageUpload(event)" style="padding: 8px;">
                        <p style="color: #aaa; font-size: 0.85em; margin: 5px 0;">OR</p>
                        <input type="text" id="spiderImage" placeholder="Image URL (if not uploading)">
                    </div>
                    <div id="imagePreview" style="margin-top: 10px; display: none;">
                        <img id="previewImg" style="max-width: 200px; max-height: 200px; border-radius: 10px; border: 2px solid rgba(78, 205, 196, 0.5);">
                        <p style="color: #4ecdc4; font-size: 0.9em; margin-top: 5px;">‚úì Image ready to upload</p>
                    </div>
                </div>
                <div class="input-group">
                    <label>Strength (1-100):</label>
                    <input type="number" id="strength" min="1" max="100" value="50">
                </div>
                <div class="input-group">
                    <label>Speed (1-100):</label>
                    <input type="number" id="speed" min="1" max="100" value="50">
                </div>
                
                <h3 style="color: #4ecdc4; margin-top: 20px;">Custom Fields</h3>
                <p style="color: #aaa; font-size: 0.9em; margin-bottom: 10px;">Add your own custom stats and information!</p>
                <div id="customFieldsContainer"></div>
                <button onclick="addCustomField()" style="background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%); margin-bottom: 15px;">+ Add Custom Field</button>
                
                <button onclick="addSpider()">Submit Spider for Approval</button>
                <div id="addStatus"></div>
            </div>
        </div>

        <!-- Battle Tab -->
        <div id="battleTab" class="tab-content">
            <div class="config-section">
                <h2>‚öîÔ∏è Battle Arena</h2>
                <div id="battleSelectPhase">
                    <p style="color: #aaa; margin-bottom: 15px;">Select your spider to challenge an opponent:</p>
                    <div class="spider-grid" id="battleSelectSpiders"></div>
                </div>
                <div id="battleOpponentPhase" class="hidden">
                    <button onclick="backToBattleSelect()">‚Üê Back</button>
                    <p style="color: #aaa; margin: 15px 0;">Choose your opponent:</p>
                    <div class="spider-grid" id="battleOpponents"></div>
                </div>
                <div id="battleArenaPhase" class="hidden"></div>
            </div>
        </div>

        <!-- Trade Tab -->
        <div id="tradeTab" class="tab-content">
            <div class="config-section">
                <h2>üîÑ Trade Center</h2>
                
                <!-- Incoming Trade Offers -->
                <div style="background: rgba(78, 205, 196, 0.1); border: 2px solid rgba(78, 205, 196, 0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #4ecdc4; margin-bottom: 10px;">üì• Incoming Trade Offers</h3>
                    <div id="incomingTrades"></div>
                </div>

                <!-- Outgoing Trade Offers -->
                <div style="background: rgba(255, 165, 0, 0.1); border: 2px solid rgba(255, 165, 0, 0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #ffa500; margin-bottom: 10px;">üì§ Outgoing Trade Offers</h3>
                    <div id="outgoingTrades"></div>
                </div>

                <!-- Make New Trade Offer -->
                <div>
                    <h3 style="color: #4ecdc4; margin-bottom: 15px;">‚ú® Create Trade Offer</h3>
                    <p style="color: #aaa; margin-bottom: 15px;">Select one of your spiders to offer in trade:</p>
                    <div class="spider-grid" id="tradeMySpiders"></div>
                </div>
            </div>
        </div>

        <!-- Shop & Inventory Tab -->
        <div id="shopTab" class="tab-content">
            <div class="config-section">
                <h2>üéí Your Inventory</h2>
                <div id="inventoryDisplay" class="inventory-display">
                    <p style="color: #666;">Your items will appear here</p>
                </div>
            </div>
            <div class="config-section">
                <h2>üõí Shop</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 3em;">‚ö°</div>
                        <h3>Potion</h3>
                        <p style="color: #aaa;">Restore 20 HP in battle</p>
                        <div style="color: #ffd700; font-weight: bold; margin: 10px 0; font-size: 1.2em;">üí∞ <span id="pricePotion">15</span> coins</div>
                        <button onclick="buyShopItem('potion')">Buy</button>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 3em;">üíä</div>
                        <h3>Super Potion</h3>
                        <p style="color: #aaa;">Restore 50 HP in battle</p>
                        <div style="color: #ffd700; font-weight: bold; margin: 10px 0; font-size: 1.2em;">üí∞ <span id="priceSuperPotion">30</span> coins</div>
                        <button onclick="buyShopItem('superPotion')">Buy</button>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 3em;">‚ú®</div>
                        <h3>Full Restore</h3>
                        <p style="color: #aaa;">Restore all HP in battle</p>
                        <div style="color: #ffd700; font-weight: bold; margin: 10px 0; font-size: 1.2em;">üí∞ <span id="priceFullRestore">50</span> coins</div>
                        <button onclick="buyShopItem('fullRestore')">Buy</button>
                    </div>
                </div>
                <div id="shopStatus"></div>
            </div>
        </div>

        <!-- Admin Tab -->
        <div id="adminTabContent" class="tab-content">
            <div class="config-section">
                <h2>üëë Admin Panel</h2>
                
                <div id="adminAccessDenied">
                    <p style="color: #f5576c;">‚õî Access Denied - Admin login required</p>
                </div>

                <div id="adminContent" class="hidden">
                    <div style="background: rgba(78, 205, 196, 0.1); border: 2px solid rgba(78, 205, 196, 0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #4ecdc4; margin-bottom: 10px;">üìù Direct Gist Access</h3>
                        <p style="color: #aaa; margin-bottom: 10px; font-size: 0.95em;">Edit the raw data directly on GitHub for advanced modifications:</p>
                        <a id="adminGistLink" href="#" target="_blank" style="display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%); color: white; text-decoration: none; border-radius: 25px; font-weight: bold;">
                            Open Gist in GitHub ‚Üí
                        </a>
                        <p style="color: #ffa500; margin-top: 10px; font-size: 0.9em;">‚ö†Ô∏è Be careful when editing directly - invalid JSON will break the game!</p>
                    </div>

                    <h3 style="color: #4ecdc4;">üîç Spider Verification Queue</h3>
                    <div id="verificationQueue" style="margin-bottom: 30px;"></div>

                    <h3 style="color: #4ecdc4;">‚öîÔ∏è Move List Editor</h3>
                    <p style="color: #aaa; margin-bottom: 10px;">Edit the list of moves available in the game (JSON format):</p>
                    <textarea id="adminMoves" rows="10" style="font-family: monospace; font-size: 12px;"></textarea>
                    <button onclick="saveMoveList()">Save Move List</button>

                    <h3 style="color: #4ecdc4; margin-top: 30px;">üõí Shop Prices</h3>
                    <div class="input-group">
                        <label>Potion Price:</label>
                        <input type="number" id="adminPricePotion" min="0" value="15">
                    </div>
                    <div class="input-group">
                        <label>Super Potion Price:</label>
                        <input type="number" id="adminPriceSuperPotion" min="0" value="30">
                    </div>
                    <div class="input-group">
                        <label>Full Restore Price:</label>
                        <input type="number" id="adminPriceFullRestore" min="0" value="50">
                    </div>
                    <button onclick="saveShopPrices()">Save Shop Prices</button>

                    <h3 style="color: #4ecdc4; margin-top: 30px;">üí¨ Daily Taglines</h3>
                    <p style="color: #aaa; margin-bottom: 10px;">Edit the rotating taglines that appear in the header (one per line):</p>
                    <textarea id="adminTaglines" rows="8" style="font-family: inherit; font-size: 14px;" placeholder="Enter one tagline per line..."></textarea>
                    <button onclick="saveTaglines()">Save Taglines</button>

                    <div style="margin-top: 30px;" id="adminBugReports"></div>

                    <h3 style="color: #4ecdc4; margin-top: 30px;">üë• User Management</h3>
                    <div id="usersList" style="background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 5px;"></div>
                    
                    <div id="adminStatus"></div>
                </div>
            </div>
        </div>

        <!-- Bug Report Button -->
        <button class="bug-report-btn" onclick="openBugReport()">
            üêõ Report Bug
        </button>

        <!-- Login Modal -->
        <div id="loginModal" class="login-modal" onclick="closeLoginModalOnOverlay(event)">
            <div class="login-content" onclick="event.stopPropagation()">
                <h2>üë§ Login / Register</h2>
                <div style="background: rgba(255, 165, 0, 0.2); border: 2px solid rgba(255, 165, 0, 0.6); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <strong style="color: #ffa500;">‚ö†Ô∏è Security Warning:</strong>
                    <p style="color: #ffcc00; margin-top: 8px; font-size: 0.95em;">
                        Your password will be hashed and stored in a GitHub Gist. <strong>DO NOT use a password you use anywhere else!</strong> This is a casual game - use a simple, unique password.
                    </p>
                </div>
                <div class="input-group">
                    <label>Username:</label>
                    <input type="text" id="username" placeholder="Enter username">
                </div>
                <div class="input-group">
                    <label>Password (use a unique password!):</label>
                    <input type="password" id="password" placeholder="Enter a simple, unique password">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="login()" style="flex: 1; background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%);">Login</button>
                    <button onclick="register()" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">Register</button>
                </div>
                <button onclick="closeLoginModal()" style="width: 100%; margin-top: 10px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">Cancel</button>
                <div id="loginStatus"></div>
            </div>
        </div>

        <!-- Bug Report Modal -->
        <div id="bugReportModal" class="bug-report-modal" onclick="closeBugReportOnOverlay(event)">
            <div class="bug-report-content" onclick="event.stopPropagation()">
                <h2>üêõ Report a Bug</h2>
                <p style="color: #aaa; margin-bottom: 15px;">Help us improve Spider League! Describe the bug you encountered.</p>
                
                <div class="input-group">
                    <label>What happened?</label>
                    <textarea id="bugDescription" placeholder="Describe the bug in detail..."></textarea>
                </div>
                
                <div class="input-group">
                    <label>Steps to reproduce (optional):</label>
                    <textarea id="bugSteps" rows="4" placeholder="1. Go to...&#10;2. Click on...&#10;3. See error"></textarea>
                </div>
                
                <div class="input-group">
                    <label>Your username (optional):</label>
                    <input type="text" id="bugReporterName" placeholder="So we can follow up with you">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="submitBugReport()" style="flex: 1; background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%);">Submit Report</button>
                    <button onclick="closeBugReport()" style="flex: 1; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">Cancel</button>
                </div>
                
                <div id="bugReportStatus"></div>
            </div>
        </div>
    </div>

    <script>
        // ===== MOVE LIST (EDITABLE BY ADMIN) =====
        let MOVE_LIST = [
            // Damage moves
            { name: "Bite", type: "physical", basePower: 50, effect: null },
            { name: "Venom Fang", type: "physical", basePower: 60, effect: null },
            { name: "Quick Strike", type: "speed", basePower: 35, effect: null },
            
            // Status moves with poison
            { name: "Poison Sting", type: "physical", basePower: 30, effect: { type: "poison", chance: 0.5, damage: 8 } },
            { name: "Toxic Bite", type: "physical", basePower: 40, effect: { type: "poison", chance: 0.8, damage: 12 } },
            
            // Draining/healing moves
            { name: "Leech Life", type: "physical", basePower: 40, effect: { type: "drain", percent: 0.5 } },
            { name: "Spider Drain", type: "web", basePower: 50, effect: { type: "drain", percent: 0.6 } },
            
            // Multi-hit moves
            { name: "Web Barrage", type: "web", basePower: 25, effect: { type: "multihit", hits: 3 } },
            { name: "Fury Swipes", type: "physical", basePower: 18, effect: { type: "multihit", hits: 4 } },
            
            // Stat boosting moves
            { name: "Agility", type: "speed", basePower: 0, effect: { type: "boost", stat: "speed", amount: 15 } },
            { name: "Harden", type: "physical", basePower: 0, effect: { type: "boost", stat: "defense", amount: 12 } },
            { name: "Focus Energy", type: "speed", basePower: 0, effect: { type: "boost", stat: "strength", amount: 10 } },
            
            // Web/trap moves
            { name: "Silk Trap", type: "web", basePower: 20, effect: { type: "trap", damage: 10, turns: 2 } },
            { name: "Sticky Web", type: "web", basePower: 0, effect: { type: "slow", amount: 10, turns: 3 } },
            { name: "Web Shot", type: "web", basePower: 40, effect: { type: "slow", amount: 5, turns: 2 } },
            
            // Recoil moves (high risk, high reward)
            { name: "Reckless Charge", type: "physical", basePower: 90, effect: { type: "recoil", percent: 0.25 } },
            { name: "Wild Tackle", type: "physical", basePower: 70, effect: { type: "recoil", percent: 0.2 } },
            
            // Accuracy/evasion moves
            { name: "Sand Attack", type: "speed", basePower: 0, effect: { type: "accuracy_down", amount: 15, turns: 2 } },
            
            // Guaranteed crit moves
            { name: "Assassination", type: "speed", basePower: 55, effect: { type: "guaranteed_crit" } },
            
            // Charge moves (wait 1 turn, big damage)
            { name: "Solar Beam", type: "web", basePower: 120, effect: { type: "charge", turns: 1 } }
        ];

        // ===== GAME STATE =====
        let config = { githubToken: '', gistId: '' };
        let spiders = [];
        let users = [];
        let shopPrices = { potion: 15, superPotion: 30, fullRestore: 50 };
        let currentUser = '';
        let currentFilter = 'all';
        let battleState = null;
        let selectedBattleSpider = null;
        let tradeOffers = [];
        let customFieldsCount = 0;
        let uploadedImageData = null; // Store uploaded image as base64
        let bugReports = [];
        let activeBattles = []; // Track ongoing battles
        let taglines = [
            "Spider League: Because Therapy Was Booked",
            "Eight Legs, Zero Thoughts",
            "Your Mom's Favorite",
            "Locally Sourced, Free-Range Spiders",
            "We Have Spiders at Home",
            "Spider League: It's Giving Arachnid",
            "No Thoughts, Just Spiders",
            "Spider League: Unhinged Since Tuesday",
            "POV You are a Spider",
            "Spiders But Make It Your Entire Personality",
            "The Vibes Are Rancid",
            "Chronically Online Spiders",
            "This Could Have Been an Email",
            "Eight Legs, No Brain Cells",
            "It's Corn",
            "Spiders fucking suck",
            "We're All Just Raw-Dogging Reality",
            "The Spiders Are Not Okay",
            "Touch Grass? No, Touch Web",
            "Screaming, Crying, Throwing Up",
            "Vibes Are Immaculate and Also Terrible",
            "An Existential Crisis Simulator",
            "No Context, Just Vibes",
            "For People Who Peak at Being Mid",
            "Your K/D Is Embarrassing",
            "You're the Reason We Can't Have Nice Things",
            "Skill Issue, Honestly",
            "Imagine Being This Bad at Spiders",
            "Spider League: Unemployed Behavior",
            "You've Been Playing for HOW Long?",
            "This REALLY Fell Off",
            "This Is Why No One Invites You to Parties",
            "Your Duos Partner Carries You",
            "Uninstall Challenge (Impossible)",
            "You Can't Even Blame Lag",
            "Touch Grass Speedrun Any%",
            "Spider League: This Could've Been Sleep"
        ];

        // Battle status effects
        function initBattleEffects() {
            return {
                poison: { active: false, damage: 0 },
                trapped: { active: false, damage: 0, turns: 0 },
                speedMod: 0,
                strengthMod: 0,
                defenseMod: 0,
                accuracyMod: 0,
                charging: { active: false, move: null }
            };
        }
        
        // Get daily tagline
        function getDailyTagline() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            const index = dayOfYear % taglines.length;
            return taglines[index];
        }
        
        // Update tagline display
        function updateTagline() {
            const taglineElement = document.getElementById('tagline');
            if (taglineElement) {
                taglineElement.textContent = getDailyTagline();
            }
        }

        // ===== UTILITY FUNCTIONS =====
        function calculateXpForLevel(level) {
            // Exponential growth: 100 * (level ^ 1.5)
            return Math.floor(100 * Math.pow(level, 1.5));
        }
        
        function calculateXpReward(enemyLevel, won) {
            const xpForNextLevel = calculateXpForLevel(enemyLevel);
            const baseXp = Math.floor(xpForNextLevel * 0.05);
            return won ? baseXp : Math.floor(baseXp * 0.5);
        }
        
        function levelUpSpider(spider) {
            spider.level++;
            spider.xp = 0;
            
            // Random stat increases (1-3 points each)
            const strengthGain = Math.floor(Math.random() * 3) + 1;
            const speedGain = Math.floor(Math.random() * 3) + 1;
            const hpGain = Math.floor(Math.random() * 15) + 5; // 5-20 HP gain
            
            spider.strength += strengthGain;
            spider.speed += speedGain;
            spider.maxHp += hpGain;
            spider.hp += hpGain; // Also increase current HP
            
            return {
                strengthGain,
                speedGain,
                hpGain
            };
        }
        
        function addXpToSpider(spider, xp) {
            if (!spider.xp) spider.xp = 0;
            
            spider.xp += xp;
            const xpNeeded = calculateXpForLevel(spider.level);
            
            const levelUps = [];
            while (spider.xp >= xpNeeded) {
                const gains = levelUpSpider(spider);
                levelUps.push({
                    level: spider.level,
                    gains: gains
                });
                
                // Recalculate for next level
                if (spider.xp >= calculateXpForLevel(spider.level)) {
                    continue;
                } else {
                    break;
                }
            }
            
            return levelUps;
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                uploadedImageData = null;
                document.getElementById('imagePreview').style.display = 'none';
                return;
            }

            // Check file size (max 2MB to keep gist reasonable)
            if (file.size > 2 * 1024 * 1024) {
                alert('Image too large! Please use an image under 2MB.');
                event.target.value = '';
                uploadedImageData = null;
                document.getElementById('imagePreview').style.display = 'none';
                return;
            }

            // Check if it's an image
            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file!');
                event.target.value = '';
                uploadedImageData = null;
                document.getElementById('imagePreview').style.display = 'none';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImageData = e.target.result; // Store as base64
                
                // Show preview
                const preview = document.getElementById('imagePreview');
                const previewImg = document.getElementById('previewImg');
                previewImg.src = uploadedImageData;
                preview.style.display = 'block';

                // Clear URL input if they uploaded a file
                document.getElementById('spiderImage').value = '';
            };
            reader.readAsDataURL(file);
        }

        function calculateTotalPower(spider) {
            let sum = spider.strength + spider.speed;
            let count = 2;
            
            // Add custom numeric fields to power calculation
            if (spider.customFields) {
                for (const field of spider.customFields) {
                    const value = parseFloat(field.value);
                    if (!isNaN(value)) {
                        sum += value;
                        count++;
                    }
                }
            }
            
            return Math.round(sum / count);
        }
        
        function addCustomField() {
            customFieldsCount++;
            const container = document.getElementById('customFieldsContainer');
            const fieldId = `customField_${customFieldsCount}`;
            
            const fieldHTML = `
                <div id="${fieldId}" style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <label style="font-size: 0.9em;">Field Name:</label>
                            <input type="text" class="custom-field-name" placeholder="e.g., Venom Level, Agility, Cuteness" style="margin-top: 5px;">
                        </div>
                        <div style="flex: 1;">
                            <label style="font-size: 0.9em;">Value:</label>
                            <input type="text" class="custom-field-value" placeholder="Any value (text or number)" style="margin-top: 5px;">
                        </div>
                    </div>
                    <button onclick="removeCustomField('${fieldId}')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 8px 16px; font-size: 0.9em;">Remove</button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', fieldHTML);
        }
        
        function removeCustomField(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) field.remove();
        }
        
        function getCustomFields() {
            const container = document.getElementById('customFieldsContainer');
            const fields = [];
            
            const fieldDivs = container.querySelectorAll('[id^="customField_"]');
            fieldDivs.forEach(div => {
                const name = div.querySelector('.custom-field-name').value.trim();
                const value = div.querySelector('.custom-field-value').value.trim();
                
                if (name && value) {
                    fields.push({ name, value });
                }
            });
            
            return fields;
        }
        
        function clearCustomFields() {
            document.getElementById('customFieldsContainer').innerHTML = '';
            customFieldsCount = 0;
        }

        function toggleConfig() {
            document.getElementById('configSection').classList.toggle('hidden');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'collection') {
                document.getElementById('collectionTab').classList.add('active');
            } else if (tab === 'add') {
                document.getElementById('addTab').classList.add('active');
            } else if (tab === 'battle') {
                document.getElementById('battleTab').classList.add('active');
                renderBattleSelect();
            } else if (tab === 'trade') {
                document.getElementById('tradeTab').classList.add('active');
                renderTradeTab();
                updateTradeTabIndicator();
            } else if (tab === 'shop') {
                document.getElementById('shopTab').classList.add('active');
                updateShopPrices();
                renderInventory();
            } else if (tab === 'admin') {
                document.getElementById('adminTabContent').classList.add('active');
                checkAdminAccess();
            }
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderSpiders();
        }

        function showStatus(id, msg, type) {
            const el = document.getElementById(id);
            if (!el) return;
            el.textContent = msg;
            el.className = `status ${type}`;
            setTimeout(() => el.className = 'status hidden', 3000);
        }

        function showUserInfo() {
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            if (currentUser === 'admin') {
                document.getElementById('adminTab').classList.remove('hidden');
            }
            updateCoins();
            closeLoginModal();
        }

        function updateCoins() {
            const user = users.find(u => u.username === currentUser);
            const coins = user ? user.coins || 0 : 0;
            const coinsDisplay = document.getElementById('userCoins');
            
            if (currentUser) {
                coinsDisplay.textContent = `üí∞ ${coins} coins`;
                coinsDisplay.title = `Logged in as ${currentUser}`;
            } else {
                coinsDisplay.textContent = 'üí∞ Login';
                coinsDisplay.title = 'Click to login';
            }
        }

        function openLoginModal() {
            document.getElementById('loginModal').classList.add('active');
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginStatus').innerHTML = '';
        }

        function closeLoginModalOnOverlay(event) {
            if (event.target.id === 'loginModal') {
                closeLoginModal();
            }
        }

        function getUserInventory() {
            const user = users.find(u => u.username === currentUser);
            if (!user) return {};
            if (!user.inventory) {
                user.inventory = {};
            }
            return user.inventory;
        }

        function setUserInventory(inventory) {
            const user = users.find(u => u.username === currentUser);
            if (user) {
                user.inventory = inventory;
            }
        }

        // ===== MOVE GENERATION =====
        function generateMoves(spider) {
            const shuffled = [...MOVE_LIST].sort(() => Math.random() - 0.5);
            const moves = shuffled.slice(0, 4).map(move => ({
                ...move,
                power: move.basePower + Math.floor(spider.level * 3) // Level scaling: +3 power per level
            }));
            return moves;
        }
        
        function updateMovePower(spider) {
            // Update move power when spider levels up
            if (spider.moves) {
                spider.moves = spider.moves.map(move => ({
                    ...move,
                    power: move.basePower + Math.floor(spider.level * 3)
                }));
            }
        }

        // ===== CONFIG & AUTH =====
        function loadConfig() {
            const saved = window.localStorage.getItem('spiderConfig');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('githubToken').value = config.githubToken || '';
                document.getElementById('gistId').value = config.gistId || '';
            }

            const savedUser = window.localStorage.getItem('spiderUser');
            if (savedUser) {
                currentUser = savedUser;
                showUserInfo();
            }

            loadData();
        }

        function saveConfig() {
            config.githubToken = document.getElementById('githubToken').value.trim();
            config.gistId = document.getElementById('gistId').value.trim();
            window.localStorage.setItem('spiderConfig', JSON.stringify(config));
            showStatus('configStatus', 'Configuration saved!', 'success');
            if (config.gistId) loadData();
        }

        async function register() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showStatus('loginStatus', 'Enter username and password!', 'error');
                return;
            }

            if (username.length < 3) {
                showStatus('loginStatus', 'Username must be 3+ characters', 'error');
                return;
            }
            
            if (password.length < 4) {
                showStatus('loginStatus', 'Password must be 4+ characters', 'error');
                return;
            }

            if (users.find(u => u.username === username)) {
                showStatus('loginStatus', 'Username already taken!', 'error');
                return;
            }
            
            // Additional warning before registration
            const confirmed = confirm(
                '‚ö†Ô∏è SECURITY WARNING ‚ö†Ô∏è\n\n' +
                'Your password will be hashed and stored in a GitHub Gist.\n\n' +
                'DO NOT use a password you use for any other account!\n\n' +
                'Only use a simple, unique password for this game.\n\n' +
                'Click OK to confirm you understand and want to register.'
            );
            
            if (!confirmed) {
                return;
            }

            users.push({
                username,
                password,
                coins: 100,
                inventory: {},
                createdAt: new Date().toISOString()
            });

            if (await saveData()) {
                currentUser = username;
                window.localStorage.setItem('spiderUser', username);
                showUserInfo();
                showStatus('loginStatus', 'Registered! You start with 100 coins!', 'success');
            }
        }

        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showStatus('loginStatus', 'Enter username and password!', 'error');
                return;
            }

            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                currentUser = username;
                window.localStorage.setItem('spiderUser', username);
                showUserInfo();
                showStatus('loginStatus', 'Logged in successfully!', 'success');
                renderSpiders();
            } else {
                showStatus('loginStatus', 'Invalid username or password!', 'error');
            }
        }

        function logout() {
            if (!confirm('Logout?')) return;
            currentUser = '';
            window.localStorage.removeItem('spiderUser');
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('adminTab').classList.add('hidden');
            updateCoins();
            renderSpiders();
        }

        // ===== DATA PERSISTENCE =====
        let saveTimeout = null;
        let pendingSave = false;

        async function loadData() {
            if (!config.githubToken || !config.gistId) return;

            try {
                const response = await fetch(`https://api.github.com/gists/${config.gistId}`, {
                    headers: {
                        'Authorization': `token ${config.githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) return;

                const data = await response.json();
                const content = JSON.parse(data.files['spider-league.json'].content);
                
                spiders = content.spiders || [];
                users = content.users || [];
                shopPrices = content.shopPrices || shopPrices;
                MOVE_LIST = content.moveList || MOVE_LIST;
                taglines = content.taglines || taglines;
                tradeOffers = content.tradeOffers || [];
                bugReports = content.bugReports || [];
                activeBattles = content.activeBattles || [];
                
                renderSpiders();
                updateCoins();
                updateShopPrices();
                renderInventory();
                updateTagline();
                updateTradeTabIndicator();
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        // Debounced save - waits 2 seconds of inactivity before saving
        function debouncedSave() {
            pendingSave = true;
            
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            
            saveTimeout = setTimeout(async () => {
                await saveDataNow();
                pendingSave = false;
            }, 2000);
        }

        // Immediate save for critical operations
        async function saveData() {
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            return await saveDataNow();
        }

        async function saveDataNow() {
            if (!config.githubToken) {
                console.error('No GitHub token configured');
                return false;
            }

            const data = { spiders, users, shopPrices, moveList: MOVE_LIST, taglines, tradeOffers, bugReports, activeBattles };

            try {
                if (!config.gistId) {
                    const response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${config.githubToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            description: 'Spider League Data',
                            public: false,
                            files: {
                                'spider-league.json': {
                                    content: JSON.stringify(data, null, 2)
                                }
                            }
                        })
                    });

                    if (!response.ok) return false;

                    const result = await response.json();
                    config.gistId = result.id;
                    document.getElementById('gistId').value = config.gistId;
                    window.localStorage.setItem('spiderConfig', JSON.stringify(config));
                    alert(`Gist created! ID: ${config.gistId}\n\nShare this with friends!`);
                } else {
                    const response = await fetch(`https://api.github.com/gists/${config.gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${config.githubToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            files: {
                                'spider-league.json': {
                                    content: JSON.stringify(data, null, 2)
                                }
                            }
                        })
                    });

                    if (!response.ok) return false;
                }

                return true;
            } catch (error) {
                console.error('Save error:', error);
                return false;
            }
        }

        // ===== SPIDER MANAGEMENT =====
        async function addSpider() {
            if (!currentUser) {
                showStatus('addStatus', 'Please login first!', 'error');
                return;
            }

            const name = document.getElementById('spiderName').value.trim();
            const latinName = document.getElementById('spiderLatinName').value.trim();
            const imageUrl = document.getElementById('spiderImage').value.trim();
            const strength = parseInt(document.getElementById('strength').value);
            const speed = parseInt(document.getElementById('speed').value);
            const customFields = getCustomFields();

            if (!name) {
                showStatus('addStatus', 'Please enter a spider name!', 'error');
                return;
            }

            // Use uploaded image if available, otherwise use URL or placeholder
            let finalImage;
            if (uploadedImageData) {
                finalImage = uploadedImageData; // Base64 data
            } else if (imageUrl) {
                finalImage = imageUrl;
            } else {
                finalImage = 'https://via.placeholder.com/300x200?text=Spider';
            }

            const spider = {
                id: Date.now(),
                name,
                latinName: latinName || null,
                image: finalImage,
                owner: currentUser,
                ownerHistory: [currentUser],
                strength,
                speed,
                customFields: customFields,
                level: 1,
                xp: 0,
                hp: 100,
                maxHp: 100,
                wins: 0,
                losses: 0,
                moves: null,
                verified: false,
                pending: true
            };

            spiders.push(spider);

            if (await saveData()) {
                showStatus('addStatus', 'Spider submitted for admin approval!', 'success');
                document.getElementById('spiderName').value = '';
                document.getElementById('spiderLatinName').value = '';
                document.getElementById('spiderImage').value = '';
                document.getElementById('spiderImageFile').value = '';
                document.getElementById('strength').value = 50;
                document.getElementById('speed').value = 50;
                document.getElementById('imagePreview').style.display = 'none';
                uploadedImageData = null;
                clearCustomFields();
            }
        }

        async function deleteSpider(id) {
            if (!confirm('Delete this spider?')) return;
            
            const spider = spiders.find(s => s.id === id);
            if (spider && spider.owner !== currentUser && currentUser !== 'admin') {
                alert('You can only delete your own spiders!');
                return;
            }

            spiders = spiders.filter(s => s.id !== id);
            
            // Update UI immediately
            renderSpiders();
            
            // Save in background
            debouncedSave();
        }

        function renderSpiders() {
            const grid = document.getElementById('spiderGrid');
            
            let filtered = spiders.filter(s => s.verified);
            if (currentFilter === 'mine') {
                filtered = filtered.filter(s => s.owner === currentUser);
            }

            const pendingSpiders = spiders.filter(s => s.pending && !s.verified && s.owner === currentUser);

            if (filtered.length === 0 && pendingSpiders.length === 0) {
                grid.innerHTML = '<p style="color: #666;">No spiders to display.</p>';
                return;
            }

            let html = '';

            if (pendingSpiders.length > 0) {
                html += pendingSpiders.map(spider => `
                    <div class="spider-card" style="border: 2px solid rgba(255, 165, 0, 0.8);">
                        <div style="background: rgba(255, 165, 0, 0.9); padding: 5px 10px; border-radius: 15px; display: inline-block; margin-bottom: 10px; font-size: 12px;">‚è≥ Pending Approval</div>
                        <img src="${spider.image}" class="spider-image" alt="${spider.name}">
                        <div class="spider-name">${spider.name}</div>
                        ${spider.latinName ? `<div style="font-style: italic; color: #aaa; font-size: 0.9em; margin-bottom: 8px;">${spider.latinName}</div>` : ''}
                        <div class="stat"><span>Strength:</span><span>${spider.strength}</span></div>
                        <div class="stat"><span>Speed:</span><span>${spider.speed}</span></div>
                        ${spider.customFields && spider.customFields.length > 0 ? spider.customFields.map(field => `
                            <div class="stat"><span>${field.name}:</span><span>${field.value}</span></div>
                        `).join('') : ''}
                        <div class="stat" style="background: rgba(78, 205, 196, 0.2); border: 1px solid #4ecdc4;"><span>Total Power:</span><span>${calculateTotalPower(spider)}</span></div>
                    </div>
                `).join('');
            }

            html += filtered.map(spider => {
                const ownerHistory = spider.ownerHistory || [spider.owner];
                const historyText = ownerHistory.length > 1 ? 
                    `Previous owners: ${ownerHistory.slice(0, -1).join(' ‚Üí ')}` : '';

                const moveNames = spider.moves ? spider.moves.map(m => m.name).join(', ') : 'Moves will be assigned';
                const isDead = spider.hp <= 0;
                
                // XP System
                const currentXp = spider.xp || 0;
                const xpNeeded = calculateXpForLevel(spider.level);
                const xpPercent = (currentXp / xpNeeded) * 100;

                return `
                    <div class="spider-card" style="${isDead ? 'opacity: 0.6; border: 2px solid rgba(255, 87, 108, 0.5);' : ''}">
                        ${isDead ? '<div style="background: rgba(255, 87, 108, 0.9); padding: 5px 10px; border-radius: 15px; display: inline-block; margin-bottom: 10px; font-size: 12px;">üíÄ FAINTED</div>' : ''}
                        <img src="${spider.image}" class="spider-image" alt="${spider.name}" style="${isDead ? 'filter: grayscale(100%);' : ''}">
                        <div class="spider-name">${spider.name}</div>
                        ${spider.latinName ? `<div style="font-style: italic; color: #aaa; font-size: 0.9em; margin-bottom: 8px;">${spider.latinName}</div>` : ''}
                        <div class="stat"><span>Level:</span><span>${spider.level}</span></div>
                        <div style="margin: 8px 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                <span style="font-size: 0.85em; color: #aaa;">XP to Next Level:</span>
                                <span style="font-size: 0.85em; color: #4ecdc4;">${currentXp} / ${xpNeeded}</span>
                            </div>
                            <div style="width: 100%; height: 8px; background: rgba(0, 0, 0, 0.5); border-radius: 10px; overflow: hidden;">
                                <div style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: ${xpPercent}%; transition: width 0.5s;"></div>
                            </div>
                        </div>
                        <div class="stat ${isDead ? 'style="background: rgba(255, 87, 108, 0.2);"' : ''}"><span>HP:</span><span>${spider.hp}/${spider.maxHp}</span></div>
                        <div class="stat"><span>Strength:</span><span>${spider.strength}</span></div>
                        <div class="stat"><span>Speed:</span><span>${spider.speed}</span></div>
                        ${spider.customFields && spider.customFields.length > 0 ? spider.customFields.map(field => `
                            <div class="stat"><span>${field.name}:</span><span>${field.value}</span></div>
                        `).join('') : ''}
                        <div class="stat" style="background: rgba(78, 205, 196, 0.2); border: 1px solid #4ecdc4;"><span>Total Power:</span><span>${calculateTotalPower(spider)}</span></div>
                        <div class="stat"><span>Record:</span><span>${spider.wins || 0}W - ${spider.losses || 0}L</span></div>
                        <div class="stat"><span>Owner:</span><span>${spider.owner}</span></div>
                        ${historyText ? `<div class="owner-history">${historyText}</div>` : ''}
                        <div class="move-list">Moves: ${moveNames}</div>
                        ${(spider.owner === currentUser && isDead) ? `
                            <div style="background: rgba(255, 165, 0, 0.2); padding: 10px; border-radius: 8px; margin-top: 10px;">
                                <p style="color: #ffa500; font-size: 0.9em; margin-bottom: 8px;">üíä Revive Spider:</p>
                                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    <button onclick="useItemOnSpider(${spider.id}, 'potion', 20)" style="flex: 1; padding: 8px; font-size: 0.85em;">Potion (+20)</button>
                                    <button onclick="useItemOnSpider(${spider.id}, 'superPotion', 50)" style="flex: 1; padding: 8px; font-size: 0.85em;">Super (+50)</button>
                                    <button onclick="useItemOnSpider(${spider.id}, 'fullRestore', 999)" style="flex: 1; padding: 8px; font-size: 0.85em;">Full Restore</button>
                                </div>
                            </div>
                        ` : ''}
                        ${spider.owner === currentUser || currentUser === 'admin' ? `<button onclick="deleteSpider(${spider.id})" style="width: 100%; margin-top: 10px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">Delete</button>` : ''}
                    </div>
                `;
            }).join('');

            grid.innerHTML = html;
        }

        // ===== BATTLE SYSTEM =====
        function isSpiderInBattle(spiderId) {
            // Check if spider is in any active battle
            return activeBattles.some(battle => 
                battle.playerSpiderId === spiderId || battle.enemySpiderId === spiderId
            );
        }

        function renderBattleSelect() {
            const grid = document.getElementById('battleSelectSpiders');
            const mySpiders = spiders.filter(s => s.owner === currentUser && s.verified && s.hp > 0);

            if (mySpiders.length === 0) {
                grid.innerHTML = '<p style="color: #666;">You have no healthy verified spiders to battle!</p>';
                return;
            }

            grid.innerHTML = mySpiders.map(spider => {
                const inBattle = isSpiderInBattle(spider.id);
                return `
                    <div class="spider-card" style="cursor: ${inBattle ? 'not-allowed' : 'pointer'}; opacity: ${inBattle ? '0.5' : '1'};" ${!inBattle ? `onclick="selectBattleSpider(${spider.id})"` : ''}>
                        ${inBattle ? '<div style="background: rgba(255, 87, 108, 0.9); padding: 5px 10px; border-radius: 15px; display: inline-block; margin-bottom: 10px; font-size: 12px;">‚öîÔ∏è In Battle</div>' : ''}
                        <img src="${spider.image}" class="spider-image" alt="${spider.name}">
                        <div class="spider-name">${spider.name}</div>
                        <div class="stat"><span>Level:</span><span>${spider.level}</span></div>
                        <div class="hp-bar">
                            <div class="hp-fill ${spider.hp < spider.maxHp * 0.3 ? 'low' : ''}" style="width: ${(spider.hp / spider.maxHp) * 100}%">
                                HP: ${spider.hp}/${spider.maxHp}
                            </div>
                        </div>
                        ${!inBattle ? '<button>Select for Battle</button>' : '<button disabled>Spider is Busy</button>'}
                    </div>
                `;
            }).join('');
        }

        function selectBattleSpider(spiderId) {
            const spider = spiders.find(s => s.id === spiderId);
            
            if (isSpiderInBattle(spiderId)) {
                alert('This spider is already in a battle!');
                return;
            }
            
            selectedBattleSpider = spider;
            if (!selectedBattleSpider.moves) {
                selectedBattleSpider.moves = generateMoves(selectedBattleSpider);
            }
            
            document.getElementById('battleSelectPhase').classList.add('hidden');
            document.getElementById('battleOpponentPhase').classList.remove('hidden');
            renderOpponents();
        }

        function renderOpponents() {
            const grid = document.getElementById('battleOpponents');
            const opponents = spiders.filter(s => s.verified && s.owner !== currentUser && s.hp > 0);

            if (opponents.length === 0) {
                grid.innerHTML = '<p style="color: #666;">No opponents available!</p>';
                return;
            }

            grid.innerHTML = opponents.map(spider => {
                const inBattle = isSpiderInBattle(spider.id);
                return `
                    <div class="spider-card" style="cursor: ${inBattle ? 'not-allowed' : 'pointer'}; opacity: ${inBattle ? '0.5' : '1'};" ${!inBattle ? `onclick="proposeWager(${spider.id})"` : ''}>
                        ${inBattle ? '<div style="background: rgba(255, 87, 108, 0.9); padding: 5px 10px; border-radius: 15px; display: inline-block; margin-bottom: 10px; font-size: 12px;">‚öîÔ∏è In Battle</div>' : ''}
                        <img src="${spider.image}" class="spider-image" alt="${spider.name}">
                        <div class="spider-name">${spider.name}</div>
                        <div class="stat"><span>Level:</span><span>${spider.level}</span></div>
                        <div class="stat"><span>Owner:</span><span>${spider.owner}</span></div>
                        <div class="stat"><span>Record:</span><span>${spider.wins || 0}W - ${spider.losses || 0}L</span></div>
                        ${!inBattle ? '<button>Challenge!</button>' : '<button disabled>Spider is Busy</button>'}
                    </div>
                `;
            }).join('');
        }

        function proposeWager(opponentId) {
            const opponent = spiders.find(s => s.id === opponentId);
            
            if (isSpiderInBattle(opponentId)) {
                alert('This spider is already in a battle!');
                return;
            }
            
            const userCoins = users.find(u => u.username === currentUser).coins || 0;
            
            const wager = prompt(`Battle wager?\n\nYou have ${userCoins} coins.\nEnter amount to wager (0 for no wager):`);
            
            if (wager === null) return;
            
            const wagerAmount = parseInt(wager) || 0;
            
            if (wagerAmount > userCoins) {
                alert('You don\'t have enough coins!');
                return;
            }
            
            if (wagerAmount < 0) {
                alert('Invalid wager amount!');
                return;
            }
            
            startBattle(opponent, wagerAmount);
        }

        function startBattle(opponent, wager) {
            if (!opponent.moves) {
                opponent.moves = generateMoves(opponent);
            }

            battleState = {
                player: {
                    spider: { ...selectedBattleSpider },
                    currentHp: selectedBattleSpider.hp || selectedBattleSpider.maxHp
                },
                enemy: {
                    spider: { ...opponent },
                    currentHp: opponent.hp || opponent.maxHp
                },
                wager: wager,
                turn: 'enemy',
                log: [],
                canUseItems: true
            };
            
            // Add to active battles
            activeBattles.push({
                id: `battle_${Date.now()}`,
                playerSpiderId: selectedBattleSpider.id,
                enemySpiderId: opponent.id,
                startedAt: new Date().toISOString()
            });
            
            // Ensure effects are initialized
            battleState.player.effects = initBattleEffects();
            battleState.enemy.effects = initBattleEffects();
            
            // Ensure spiders have proper stats
            battleState.player.spider.strength = battleState.player.spider.strength || 50;
            battleState.player.spider.speed = battleState.player.spider.speed || 50;
            battleState.player.spider.maxHp = battleState.player.spider.maxHp || 100;
            battleState.enemy.spider.strength = battleState.enemy.spider.strength || 50;
            battleState.enemy.spider.speed = battleState.enemy.spider.speed || 50;
            battleState.enemy.spider.maxHp = battleState.enemy.spider.maxHp || 100;

            battleState.log.push(`‚öîÔ∏è Battle started! Wager: ${wager} coins`);
            battleState.log.push(`${battleState.player.spider.name} (Lvl ${battleState.player.spider.level}) vs ${battleState.enemy.spider.name} (Lvl ${battleState.enemy.spider.level})`);

            document.getElementById('battleOpponentPhase').classList.add('hidden');
            document.getElementById('battleArenaPhase').classList.remove('hidden');
            
            // Update battle tab indicator
            updateBattleTabIndicator();
            
            // Save active battles
            debouncedSave();
            
            renderBattle();
            
            if (battleState.turn === 'enemy') {
                setTimeout(() => enemyTurn(), 2000);
            }
        }

        function renderBattle() {
            const arena = document.getElementById('battleArenaPhase');
            const battle = battleState;

            arena.innerHTML = `
                <button onclick="backToBattleSelect()">‚Üê Back to Selection</button>
                <div class="battle-arena">
                    <div class="battle-field">
                        <div class="fighter">
                            <h3 style="color: #f5576c;">${battle.enemy.spider.name} (Enemy)</h3>
                            <p style="color: #aaa;">Owner: ${battle.enemy.spider.owner} | Lvl ${battle.enemy.spider.level}</p>
                            <img src="${battle.enemy.spider.image}" class="fighter-image" alt="${battle.enemy.spider.name}">
                            <div class="hp-bar">
                                <div class="hp-fill ${battle.enemy.currentHp < battle.enemy.spider.maxHp * 0.3 ? 'low' : ''}" style="width: ${(battle.enemy.currentHp / battle.enemy.spider.maxHp) * 100}%">
                                    HP: ${Math.max(0, battle.enemy.currentHp)}/${battle.enemy.spider.maxHp}
                                </div>
                            </div>
                        </div>
                        <div style="text-align: center; align-self: center; font-size: 3em;">‚öîÔ∏è</div>
                        <div class="fighter">
                            <h3 style="color: #4ecdc4;">${battle.player.spider.name} (You)</h3>
                            <p style="color: #aaa;">Lvl ${battle.player.spider.level}</p>
                            <img src="${battle.player.spider.image}" class="fighter-image" alt="${battle.player.spider.name}">
                            <div class="hp-bar">
                                <div class="hp-fill ${battle.player.currentHp < battle.player.spider.maxHp * 0.3 ? 'low' : ''}" style="width: ${(battle.player.currentHp / battle.player.spider.maxHp) * 100}%">
                                    HP: ${Math.max(0, battle.player.currentHp)}/${battle.player.spider.maxHp}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="battle-log">
                        ${battle.log.map(entry => `<div class="battle-log-entry">${entry}</div>`).join('')}
                    </div>

                    ${battle.turn === 'player' ? `
                        <div class="battle-actions">
                            <div class="action-section">
                                <h3>‚öîÔ∏è Moves</h3>
                                <div class="move-grid">
                                    ${battle.player.spider.moves.map((move, i) => `
                                        <button class="move-btn" onclick="useMove(${i})">
                                            <div class="move-name">${move.name}</div>
                                            <div class="move-type">${move.type}</div>
                                            <div class="move-power">Power: ${move.power}</div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="action-section">
                                <h3>üéí Items</h3>
                                ${renderBattleItems()}
                                <h3 style="margin-top: 15px;">üè≥Ô∏è Options</h3>
                                <button onclick="forfeitBattle()" style="width: 100%; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">Forfeit Battle</button>
                            </div>
                        </div>
                    ` : `
                        <p style="text-align: center; color: #ffa500; font-size: 1.2em; margin: 20px 0;">
                            ${battle.turn === 'enemy' ? 'Enemy is choosing their move...' : 'Processing...'}
                        </p>
                    `}
                </div>
            `;

            const logElement = arena.querySelector('.battle-log');
            if (logElement) {
                logElement.scrollTop = logElement.scrollHeight;
            }
        }

        function renderBattleItems() {
            const inventory = getUserInventory();
            const items = [
                { key: 'potion', name: 'Potion', heal: 20 },
                { key: 'superPotion', name: 'Super Potion', heal: 50 },
                { key: 'fullRestore', name: 'Full Restore', heal: 999 }
            ];

            const html = items.map(item => {
                const count = inventory[item.key] || 0;
                return `
                    <button class="item-btn" onclick="useItem('${item.key}', ${item.heal})" ${count === 0 ? 'disabled' : ''}>
                        ${item.name} (${count})
                    </button>
                `;
            }).join('');

            return html || '<p style="color: #666;">No items</p>';
        }

        async function useMove(moveIndex) {
            const move = battleState.player.spider.moves[moveIndex];
            const attacker = battleState.player;
            const defender = battleState.enemy;
            
            // Check if charging
            if (attacker.effects.charging.active) {
                battleState.log.push(`${attacker.spider.name} must recharge!`);
                battleState.turn = 'enemy';
                renderBattle();
                setTimeout(() => enemyTurn(), 2000);
                return;
            }
            
            // Handle charge moves
            if (move.effect && move.effect.type === 'charge') {
                attacker.effects.charging.active = true;
                attacker.effects.charging.move = move;
                battleState.log.push(`${attacker.spider.name} is charging ${move.name}!`);
                battleState.turn = 'enemy';
                renderBattle();
                setTimeout(() => enemyTurn(), 2000);
                return;
            }
            
            // Apply move effects
            applyMoveEffects(move, attacker, defender, 'player');
            
            await checkBattleEnd();
        }
        
        async function applyMoveEffects(move, attacker, defender, side) {
            const attackerName = attacker.spider.name;
            const defenderName = defender.spider.name;
            
            // Stat boost moves
            if (move.effect && move.effect.type === 'boost') {
                if (move.effect.stat === 'speed') {
                    attacker.effects.speedMod += move.effect.amount;
                    battleState.log.push(`${attackerName} used ${move.name}! Speed increased!`);
                } else if (move.effect.stat === 'strength') {
                    attacker.effects.strengthMod += move.effect.amount;
                    battleState.log.push(`${attackerName} used ${move.name}! Strength increased!`);
                } else if (move.effect.stat === 'defense') {
                    attacker.effects.defenseMod += move.effect.amount;
                    battleState.log.push(`${attackerName} used ${move.name}! Defense increased!`);
                }
            }
            // Accuracy down moves
            else if (move.effect && move.effect.type === 'accuracy_down') {
                defender.effects.accuracyMod -= move.effect.amount;
                battleState.log.push(`${attackerName} used ${move.name}! ${defenderName}'s accuracy fell!`);
            }
            // Slow/web moves
            else if (move.effect && move.effect.type === 'slow') {
                const damage = calculateDamage(move, attacker, defender);
                if (damage > 0) {
                    defender.currentHp -= damage;
                    battleState.log.push(`${attackerName} used ${move.name}! Dealt ${damage} damage!`);
                }
                defender.effects.speedMod -= move.effect.amount;
                battleState.log.push(`${defenderName} was slowed by webs!`);
            }
            // Trap moves
            else if (move.effect && move.effect.type === 'trap') {
                const damage = calculateDamage(move, attacker, defender);
                if (damage > 0) {
                    defender.currentHp -= damage;
                    battleState.log.push(`${attackerName} used ${move.name}! Dealt ${damage} damage!`);
                }
                defender.effects.trapped = { active: true, damage: move.effect.damage, turns: move.effect.turns };
                battleState.log.push(`${defenderName} was trapped in webs!`);
            }
            // Multi-hit moves
            else if (move.effect && move.effect.type === 'multihit') {
                let totalDamage = 0;
                for (let i = 0; i < move.effect.hits; i++) {
                    const damage = calculateDamage(move, attacker, defender);
                    totalDamage += damage;
                    defender.currentHp -= damage;
                }
                battleState.log.push(`${attackerName} used ${move.name}! Hit ${move.effect.hits} times for ${totalDamage} total damage!`);
            }
            // Drain moves
            else if (move.effect && move.effect.type === 'drain') {
                const damage = calculateDamage(move, attacker, defender);
                defender.currentHp -= damage;
                const healed = Math.floor(damage * move.effect.percent);
                attacker.currentHp = Math.min(attacker.currentHp + healed, attacker.spider.maxHp);
                battleState.log.push(`${attackerName} used ${move.name}! Dealt ${damage} damage and restored ${healed} HP!`);
            }
            // Recoil moves
            else if (move.effect && move.effect.type === 'recoil') {
                const damage = calculateDamage(move, attacker, defender);
                defender.currentHp -= damage;
                const recoil = Math.floor(damage * move.effect.percent);
                attacker.currentHp -= recoil;
                battleState.log.push(`${attackerName} used ${move.name}! Dealt ${damage} damage but took ${recoil} recoil damage!`);
            }
            // Poison moves
            else if (move.effect && move.effect.type === 'poison') {
                const damage = calculateDamage(move, attacker, defender);
                defender.currentHp -= damage;
                battleState.log.push(`${attackerName} used ${move.name}! Dealt ${damage} damage!`);
                
                if (Math.random() < move.effect.chance && !defender.effects.poison.active) {
                    defender.effects.poison = { active: true, damage: move.effect.damage };
                    battleState.log.push(`${defenderName} was poisoned!`);
                }
            }
            // Regular damage moves
            else {
                const damage = calculateDamage(move, attacker, defender);
                defender.currentHp -= damage;
                
                const critMessage = (move.effect && move.effect.type === 'guaranteed_crit') ? ' Critical hit!' : '';
                battleState.log.push(`${attackerName} used ${move.name}! Dealt ${damage} damage!${critMessage}`);
            }
        }
        
        async function checkBattleEnd() {
            if (battleState.enemy.currentHp <= 0) {
                await endBattle(true);
                return true;
            }
            if (battleState.player.currentHp <= 0) {
                await endBattle(false);
                return true;
            }
            
            battleState.turn = 'enemy';
            renderBattle();
            setTimeout(() => enemyTurn(), 2000);
            return false;
        }
        
        function applyEndOfTurnEffects(fighter, name) {
            // Poison damage
            if (fighter.effects.poison.active) {
                fighter.currentHp -= fighter.effects.poison.damage;
                battleState.log.push(`${name} took ${fighter.effects.poison.damage} poison damage!`);
            }
            
            // Trap damage
            if (fighter.effects.trapped.active) {
                fighter.currentHp -= fighter.effects.trapped.damage;
                battleState.log.push(`${name} took ${fighter.effects.trapped.damage} damage from webs!`);
                fighter.effects.trapped.turns--;
                if (fighter.effects.trapped.turns <= 0) {
                    fighter.effects.trapped.active = false;
                    battleState.log.push(`${name} broke free from the webs!`);
                }
            }
            
            // Clear charging
            if (fighter.effects.charging.active) {
                const chargeMove = fighter.effects.charging.move;
                fighter.effects.charging.active = false;
                fighter.effects.charging.move = null;
                return chargeMove; // Return the charged move to use
            }
            
            return null;
        }

        async function useItem(itemKey, healAmount) {
            if (!battleState.canUseItems) return;

            const inventory = getUserInventory();
            if (!inventory[itemKey] || inventory[itemKey] <= 0) {
                return;
            }

            inventory[itemKey]--;
            setUserInventory(inventory);

            const actualHeal = Math.min(healAmount, battleState.player.spider.maxHp - battleState.player.currentHp);
            battleState.player.currentHp += actualHeal;

            battleState.log.push(`Used ${itemKey}! Restored ${actualHeal} HP!`);

            battleState.turn = 'enemy';
            renderBattle();
            setTimeout(() => enemyTurn(), 2000);
        }

        async function enemyTurn() {
            const attacker = battleState.enemy;
            const defender = battleState.player;
            
            // Apply end of turn effects and check for charged move
            const chargedMove = applyEndOfTurnEffects(attacker, attacker.spider.name);
            applyEndOfTurnEffects(defender, defender.spider.name);
            
            // Check if battle ended from effects
            if (defender.currentHp <= 0) {
                await endBattle(false);
                return;
            }
            if (attacker.currentHp <= 0) {
                await endBattle(true);
                return;
            }
            
            // Use charged move if available, otherwise pick random
            const move = chargedMove || attacker.spider.moves[Math.floor(Math.random() * attacker.spider.moves.length)];
            
            // Apply move effects
            applyMoveEffects(move, attacker, defender, 'enemy');
            
            if (defender.currentHp <= 0) {
                await endBattle(false);
                return;
            }

            battleState.turn = 'player';
            renderBattle();
        }

        function calculateDamage(move, attacker, defender) {
            let damage = move.power;
            
            // Get base stats, defaulting to 50 if undefined
            const attackerStrength = (attacker.strength || 50) + (attacker.effects ? attacker.effects.strengthMod : 0);
            const attackerSpeed = (attacker.speed || 50) + (attacker.effects ? attacker.effects.speedMod : 0);
            const defenderDefense = (defender.strength || 50) + (defender.effects ? defender.effects.defenseMod : 0);
            
            if (move.type === 'physical') {
                damage += Math.floor(attackerStrength / 5);
            } else if (move.type === 'speed') {
                damage += Math.floor(attackerSpeed / 5);
            }
            
            // Apply defense
            damage = Math.max(5, damage - Math.floor(defenderDefense / 10));
            
            // Critical hit check
            const isCrit = (move.effect && move.effect.type === 'guaranteed_crit') || Math.random() < 0.1;
            if (isCrit && move.power > 0) {
                damage = Math.floor(damage * 1.5);
            }
            
            // Random variance
            damage += Math.floor(Math.random() * 10) - 5;
            
            return Math.max(1, damage);
        }

        async function endBattle(playerWon) {
            const playerSpider = spiders.find(s => s.id === battleState.player.spider.id);
            const enemySpider = spiders.find(s => s.id === battleState.enemy.spider.id);

            playerSpider.hp = Math.max(0, battleState.player.currentHp);
            enemySpider.hp = Math.max(0, battleState.enemy.currentHp);

            const playerUser = users.find(u => u.username === currentUser);
            const enemyUser = users.find(u => u.username === enemySpider.owner);

            // Calculate XP rewards
            const playerXp = calculateXpReward(enemySpider.level, playerWon);
            const enemyXp = calculateXpReward(playerSpider.level, !playerWon);

            if (playerWon) {
                playerSpider.wins++;
                enemySpider.losses++;
                playerUser.coins += 50 + battleState.wager;
                if (battleState.wager > 0) {
                    enemyUser.coins = Math.max(0, enemyUser.coins - battleState.wager);
                }
                
                battleState.log.push(`üéâ VICTORY! ${battleState.player.spider.name} wins!`);
                battleState.log.push(`Earned 50 coins${battleState.wager > 0 ? ` + ${battleState.wager} wager` : ''}!`);
            } else {
                playerSpider.losses++;
                enemySpider.wins++;
                if (battleState.wager > 0) {
                    playerUser.coins = Math.max(0, playerUser.coins - battleState.wager);
                    enemyUser.coins += battleState.wager;
                }
                
                battleState.log.push(`üíî DEFEAT! ${battleState.player.spider.name} fainted!`);
                if (battleState.wager > 0) {
                    battleState.log.push(`Lost ${battleState.wager} coins in wager.`);
                }
            }

            // Award XP and check for level ups
            const playerLevelUps = addXpToSpider(playerSpider, playerXp);
            const enemyLevelUps = addXpToSpider(enemySpider, enemyXp);

            battleState.log.push(`${playerSpider.name} gained ${playerXp} XP!`);
            if (playerLevelUps.length > 0) {
                playerLevelUps.forEach(lu => {
                    battleState.log.push(`üéä ${playerSpider.name} leveled up to Level ${lu.level}!`);
                    battleState.log.push(`  +${lu.gains.strengthGain} STR, +${lu.gains.speedGain} SPD, +${lu.gains.hpGain} HP!`);
                });
            }

            battleState.log.push(`${enemySpider.name} gained ${enemyXp} XP!`);
            if (enemyLevelUps.length > 0) {
                enemyLevelUps.forEach(lu => {
                    battleState.log.push(`${enemySpider.name} leveled up to Level ${lu.level}!`);
                });
            }

            // Remove from active battles
            activeBattles = activeBattles.filter(b => 
                b.playerSpiderId !== battleState.player.spider.id && 
                b.enemySpiderId !== battleState.enemy.spider.id
            );

            await saveData();
            renderBattle();

            setTimeout(() => {
                let message = playerWon ? 'üéâ You won the battle!' : 'üíî You lost the battle!';
                if (playerLevelUps.length > 0) {
                    message += `\n\nüéä ${playerSpider.name} leveled up to Level ${playerSpider.level}!`;
                    const lastLevelUp = playerLevelUps[playerLevelUps.length - 1];
                    message += `\n+${lastLevelUp.gains.strengthGain} STR, +${lastLevelUp.gains.speedGain} SPD, +${lastLevelUp.gains.hpGain} HP!`;
                }
                alert(message);
                backToBattleSelect();
            }, 3000);
        }

        async function forfeitBattle() {
            if (!confirm('Forfeit this battle? You will lose!')) return;
            await endBattle(false);
        }

        function backToBattleSelect() {
            document.getElementById('battleSelectPhase').classList.remove('hidden');
            document.getElementById('battleOpponentPhase').classList.add('hidden');
            document.getElementById('battleArenaPhase').classList.add('hidden');
            battleState = null;
            selectedBattleSpider = null;
            
            // Update battle tab indicator
            updateBattleTabIndicator();
            
            renderBattleSelect();
        }
        
        function updateBattleTabIndicator() {
            const battleBtn = document.getElementById('battleTabBtn');
            if (battleState) {
                // Battle in progress
                battleBtn.innerHTML = '‚öîÔ∏è Battle üî¥';
                battleBtn.style.position = 'relative';
                battleBtn.style.animation = 'pulse 2s infinite';
            } else {
                // No battle
                battleBtn.innerHTML = '‚öîÔ∏è Battle';
                battleBtn.style.animation = 'none';
            }
        }

        // ===== TRADING SYSTEM =====
        function updateTradeTabIndicator() {
            const tradeBtn = document.getElementById('tradeTabBtn');
            if (!currentUser) {
                tradeBtn.innerHTML = 'üîÑ Trade';
                tradeBtn.style.animation = 'none';
                return;
            }
            
            const incomingTrades = tradeOffers.filter(offer => offer.toUser === currentUser && offer.status === 'pending');
            
            if (incomingTrades.length > 0) {
                // Has incoming trades
                tradeBtn.innerHTML = `üîÑ Trade üü¢ ${incomingTrades.length}`;
                tradeBtn.style.position = 'relative';
                tradeBtn.style.animation = 'pulse 2s infinite';
            } else {
                // No incoming trades
                tradeBtn.innerHTML = 'üîÑ Trade';
                tradeBtn.style.animation = 'none';
            }
        }

        function renderTradeTab() {
            if (!currentUser) {
                document.getElementById('incomingTrades').innerHTML = '<p style="color: #666;">Please login to trade!</p>';
                document.getElementById('outgoingTrades').innerHTML = '<p style="color: #666;">Please login to trade!</p>';
                document.getElementById('tradeMySpiders').innerHTML = '<p style="color: #666;">Please login to trade!</p>';
                return;
            }

            renderIncomingTrades();
            renderOutgoingTrades();
            renderMyTradableSpiders();
        }

        function renderIncomingTrades() {
            const incoming = tradeOffers.filter(offer => offer.toUser === currentUser && offer.status === 'pending');
            const container = document.getElementById('incomingTrades');

            if (incoming.length === 0) {
                container.innerHTML = '<p style="color: #666;">No incoming trade offers</p>';
                return;
            }

            container.innerHTML = incoming.map(offer => {
                const offeredSpider = spiders.find(s => s.id === offer.spiderId);
                if (!offeredSpider) return '';

                const requestedSpider = offer.requestedSpiderId ? spiders.find(s => s.id === offer.requestedSpiderId) : null;

                return `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <h4 style="color: #4ecdc4; margin-bottom: 10px;">üì• Offering You:</h4>
                                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                    <img src="${offeredSpider.image}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                                    <div>
                                        <p style="color: #4ecdc4; font-weight: bold;">${offeredSpider.name}</p>
                                        <p style="color: #aaa; font-size: 0.9em;">Level ${offeredSpider.level} | ${offeredSpider.wins}W - ${offeredSpider.losses}L</p>
                                    </div>
                                </div>
                                ${offer.coins > 0 ? `<p style="color: #ffd700; font-size: 0.9em;">+ üí∞ ${offer.coins} coins</p>` : ''}
                                
                                ${requestedSpider ? `
                                    <h4 style="color: #ffa500; margin-top: 15px; margin-bottom: 10px;">üì§ Requesting From You:</h4>
                                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                        <img src="${requestedSpider.image}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                                        <div>
                                            <p style="color: #ffa500; font-weight: bold;">${requestedSpider.name}</p>
                                            <p style="color: #aaa; font-size: 0.9em;">Level ${requestedSpider.level} | ${requestedSpider.wins}W - ${requestedSpider.losses}L</p>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <p style="color: #aaa; font-size: 0.9em; margin-top: 10px;">From: <strong>${offer.fromUser}</strong></p>
                                ${offer.message ? `<p style="color: #bbb; font-size: 0.85em; font-style: italic; margin-top: 5px;">"${offer.message}"</p>` : ''}
                            </div>
                            <div style="display: flex; gap: 10px; flex-direction: column;">
                                <button onclick="acceptTrade('${offer.id}')" style="background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%); margin: 0;">‚úì Accept</button>
                                <button onclick="rejectTrade('${offer.id}')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); margin: 0;">‚úï Reject</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderOutgoingTrades() {
            const outgoing = tradeOffers.filter(offer => offer.fromUser === currentUser && offer.status === 'pending');
            const container = document.getElementById('outgoingTrades');

            if (outgoing.length === 0) {
                container.innerHTML = '<p style="color: #666;">No outgoing trade offers</p>';
                return;
            }

            container.innerHTML = outgoing.map(offer => {
                const offeredSpider = spiders.find(s => s.id === offer.spiderId);
                if (!offeredSpider) return '';

                const requestedSpider = offer.requestedSpiderId ? spiders.find(s => s.id === offer.requestedSpiderId) : null;

                return `
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <h4 style="color: #ffa500; margin-bottom: 10px;">üì§ You're Offering:</h4>
                                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                    <img src="${offeredSpider.image}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                                    <div>
                                        <p style="color: #ffa500; font-weight: bold;">${offeredSpider.name}</p>
                                        <p style="color: #aaa; font-size: 0.9em;">Level ${offeredSpider.level} | ${offeredSpider.wins}W - ${offeredSpider.losses}L</p>
                                    </div>
                                </div>
                                ${offer.coins > 0 ? `<p style="color: #ffd700; font-size: 0.9em;">+ üí∞ ${offer.coins} coins</p>` : ''}
                                
                                ${requestedSpider ? `
                                    <h4 style="color: #4ecdc4; margin-top: 15px; margin-bottom: 10px;">üì• Requesting:</h4>
                                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                                        <img src="${requestedSpider.image}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                                        <div>
                                            <p style="color: #4ecdc4; font-weight: bold;">${requestedSpider.name}</p>
                                            <p style="color: #aaa; font-size: 0.9em;">Level ${requestedSpider.level} | ${requestedSpider.wins}W - ${requestedSpider.losses}L</p>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <p style="color: #aaa; font-size: 0.9em; margin-top: 10px;">To: <strong>${offer.toUser}</strong></p>
                                ${offer.message ? `<p style="color: #bbb; font-size: 0.85em; font-style: italic; margin-top: 5px;">"${offer.message}"</p>` : ''}
                                <p style="color: #888; font-size: 0.8em; margin-top: 5px;">‚è≥ Waiting for response...</p>
                            </div>
                            <button onclick="cancelTrade('${offer.id}')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); margin: 0;">Cancel</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderMyTradableSpiders() {
            const mySpiders = spiders.filter(s => s.owner === currentUser && s.verified);
            const container = document.getElementById('tradeMySpiders');

            if (mySpiders.length === 0) {
                container.innerHTML = '<p style="color: #666;">You have no spiders to trade!</p>';
                return;
            }

            container.innerHTML = mySpiders.map(spider => `
                <div class="spider-card" style="cursor: pointer;" onclick="initiateTradeOffer(${spider.id})">
                    <img src="${spider.image}" class="spider-image" alt="${spider.name}">
                    <div class="spider-name">${spider.name}</div>
                    <div class="stat"><span>Level:</span><span>${spider.level}</span></div>
                    <div class="stat"><span>HP:</span><span>${spider.hp}/${spider.maxHp}</span></div>
                    <div class="stat"><span>Record:</span><span>${spider.wins || 0}W - ${spider.losses || 0}L</span></div>
                    <button>Offer in Trade</button>
                </div>
            `).join('');
        }

        function initiateTradeOffer(spiderId) {
            const spider = spiders.find(s => s.id === spiderId);
            if (!spider || spider.owner !== currentUser) {
                alert('Cannot trade this spider!');
                return;
            }

            const allUsers = users.map(u => u.username).filter(u => u !== currentUser);
            if (allUsers.length === 0) {
                alert('No other users to trade with!');
                return;
            }

            const recipient = prompt(`Trade ${spider.name} to which user?\n\nAvailable users:\n${allUsers.join(', ')}`);
            if (!recipient) return;

            if (!users.find(u => u.username === recipient)) {
                alert('User not found!');
                return;
            }

            if (recipient === currentUser) {
                alert('Cannot trade with yourself!');
                return;
            }

            // Ask what they want in return
            const tradeType = confirm('Click OK to request a specific spider in return\nClick Cancel to just send your spider (with optional coins)');
            
            let requestedSpiderId = null;
            if (tradeType) {
                // Show available spiders from recipient
                const recipientSpiders = spiders.filter(s => s.owner === recipient && s.verified);
                if (recipientSpiders.length === 0) {
                    alert('This user has no spiders to trade!');
                    return;
                }
                
                const spiderList = recipientSpiders.map((s, i) => `${i + 1}. ${s.name} (Lvl ${s.level})`).join('\n');
                const spiderChoice = prompt(`Which spider do you want in return?\n\n${spiderList}\n\nEnter the number:`);
                
                if (!spiderChoice) return;
                
                const choiceIndex = parseInt(spiderChoice) - 1;
                if (choiceIndex < 0 || choiceIndex >= recipientSpiders.length) {
                    alert('Invalid choice!');
                    return;
                }
                
                requestedSpiderId = recipientSpiders[choiceIndex].id;
            }

            const coinsInput = prompt(`Add coins to the trade? (0 for no coins)\n\nYour balance: ${users.find(u => u.username === currentUser).coins} coins`);
            const coins = parseInt(coinsInput) || 0;

            if (coins < 0) {
                alert('Invalid coin amount!');
                return;
            }

            if (coins > users.find(u => u.username === currentUser).coins) {
                alert('Not enough coins!');
                return;
            }

            const message = prompt('Add a message? (optional)') || '';

            createTradeOffer(spiderId, recipient, coins, message, requestedSpiderId);
        }

        async function createTradeOffer(spiderId, toUser, coins, message, requestedSpiderId = null) {
            const offer = {
                id: `trade_${Date.now()}`,
                fromUser: currentUser,
                toUser: toUser,
                spiderId: spiderId,
                requestedSpiderId: requestedSpiderId,
                coins: coins,
                message: message,
                status: 'pending',
                createdAt: new Date().toISOString()
            };

            tradeOffers.push(offer);

            // Update UI immediately
            renderTradeTab();
            
            // Update trade indicator
            updateTradeTabIndicator();
            
            // Save in background
            if (await saveData()) {
                showStatus('shopStatus', 'Trade offer sent!', 'success');
            }
        }

        async function acceptTrade(offerId) {
            const offer = tradeOffers.find(o => o.id === offerId);
            if (!offer || offer.toUser !== currentUser) {
                alert('Invalid trade offer!');
                return;
            }

            const offeredSpider = spiders.find(s => s.id === offer.spiderId);
            if (!offeredSpider) {
                alert('Spider not found!');
                return;
            }

            // Check if this is a spider-for-spider trade
            if (offer.requestedSpiderId) {
                const requestedSpider = spiders.find(s => s.id === offer.requestedSpiderId);
                if (!requestedSpider) {
                    alert('Requested spider not found!');
                    return;
                }
                
                if (requestedSpider.owner !== currentUser) {
                    alert('You no longer own the requested spider!');
                    return;
                }

                const confirmMsg = `Accept trade?\n\nYou give: ${requestedSpider.name}\nYou receive: ${offeredSpider.name}${offer.coins > 0 ? ` + ${offer.coins} coins` : ''}`;
                if (!confirm(confirmMsg)) {
                    return;
                }

                // Transfer both spiders
                offeredSpider.ownerHistory = offeredSpider.ownerHistory || [offeredSpider.owner];
                offeredSpider.ownerHistory.push(currentUser);
                offeredSpider.owner = currentUser;

                requestedSpider.ownerHistory = requestedSpider.ownerHistory || [requestedSpider.owner];
                requestedSpider.ownerHistory.push(offer.fromUser);
                requestedSpider.owner = offer.fromUser;
            } else {
                // Just receiving a spider (+ maybe coins)
                if (!confirm(`Accept trade for ${offeredSpider.name}${offer.coins > 0 ? ` + ${offer.coins} coins` : ''}?`)) {
                    return;
                }

                // Transfer spider
                offeredSpider.ownerHistory = offeredSpider.ownerHistory || [offeredSpider.owner];
                offeredSpider.ownerHistory.push(currentUser);
                offeredSpider.owner = currentUser;
            }

            // Transfer coins
            if (offer.coins > 0) {
                const fromUser = users.find(u => u.username === offer.fromUser);
                const toUser = users.find(u => u.username === offer.toUser);
                fromUser.coins -= offer.coins;
                toUser.coins += offer.coins;
            }

            // Mark offer as accepted
            offer.status = 'accepted';

            // Update UI immediately
            renderTradeTab();
            updateCoins();
            
            // Update trade indicator
            updateTradeTabIndicator();
            
            // Save in background
            if (await saveData()) {
                alert('Trade accepted!');
            }
        }

        async function rejectTrade(offerId) {
            const offer = tradeOffers.find(o => o.id === offerId);
            if (!offer || offer.toUser !== currentUser) {
                alert('Invalid trade offer!');
                return;
            }

            offer.status = 'rejected';

            // Update UI immediately
            renderTradeTab();
            
            // Update trade indicator
            updateTradeTabIndicator();
            
            // Save in background
            debouncedSave();
        }

        async function cancelTrade(offerId) {
            const offer = tradeOffers.find(o => o.id === offerId);
            if (!offer || offer.fromUser !== currentUser) {
                alert('Invalid trade offer!');
                return;
            }

            if (!confirm('Cancel this trade offer?')) return;

            offer.status = 'cancelled';

            // Update UI immediately
            renderTradeTab();
            
            // Update trade indicator
            updateTradeTabIndicator();
            
            // Save in background
            debouncedSave();
        }

        // ===== SHOP & INVENTORY =====
        let isProcessingPurchase = false; // Prevent double-clicks

        async function useItemOnSpider(spiderId, itemKey, healAmount) {
            if (!currentUser) {
                alert('Please login first!');
                return;
            }

            const spider = spiders.find(s => s.id === spiderId);
            if (!spider || spider.owner !== currentUser) {
                alert('You can only use items on your own spiders!');
                return;
            }

            const inventory = getUserInventory();
            if (!inventory[itemKey] || inventory[itemKey] <= 0) {
                alert(`You don't have any ${itemKey}! Buy some from the shop.`);
                return;
            }

            // Use the item
            inventory[itemKey]--;
            setUserInventory(inventory);

            // Heal the spider
            const actualHeal = Math.min(healAmount, spider.maxHp - spider.hp);
            spider.hp = Math.min(spider.hp + healAmount, spider.maxHp);

            if (await saveData()) {
                alert(`Used ${itemKey}! ${spider.name} restored ${actualHeal} HP and is now at ${spider.hp}/${spider.maxHp} HP!`);
                renderSpiders();
                renderInventory();
            }
        }

        function updateShopPrices() {
            document.getElementById('pricePotion').textContent = shopPrices.potion;
            document.getElementById('priceSuperPotion').textContent = shopPrices.superPotion;
            document.getElementById('priceFullRestore').textContent = shopPrices.fullRestore;
        }

        function renderInventory() {
            const inventory = getUserInventory();
            const display = document.getElementById('inventoryDisplay');
            
            const items = [
                { key: 'potion', name: 'Potion' },
                { key: 'superPotion', name: 'Super Potion' },
                { key: 'fullRestore', name: 'Full Restore' }
            ];

            const html = items.map(item => {
                const count = inventory[item.key] || 0;
                return `
                    <div class="inventory-item">
                        <span>${item.name}</span>
                        <span>x${count}</span>
                    </div>
                `;
            }).join('');

            display.innerHTML = html || '<p style="color: #666;">No items yet</p>';
        }

        async function buyShopItem(itemKey) {
            // Prevent rapid clicking
            if (isProcessingPurchase) {
                showStatus('shopStatus', 'Please wait, processing...', 'error');
                return;
            }

            if (!currentUser) {
                showStatus('shopStatus', 'Please login first!', 'error');
                return;
            }

            const user = users.find(u => u.username === currentUser);
            if (!user) {
                showStatus('shopStatus', 'User not found! Please login again.', 'error');
                return;
            }

            const price = shopPrices[itemKey];
            if (!price) {
                showStatus('shopStatus', 'Invalid item!', 'error');
                return;
            }

            // Check if user has enough coins
            const currentCoins = user.coins || 0;
            if (currentCoins < price) {
                showStatus('shopStatus', `Not enough coins! You have ${currentCoins}, need ${price} coins.`, 'error');
                return;
            }

            // Lock purchasing
            isProcessingPurchase = true;

            try {
                // Deduct coins
                user.coins = currentCoins - price;
                
                // Initialize inventory if it doesn't exist
                if (!user.inventory) {
                    user.inventory = {};
                }
                
                // Add item to inventory
                user.inventory[itemKey] = (user.inventory[itemKey] || 0) + 1;

                // Save data
                const saveSuccess = await saveData();
                
                if (saveSuccess) {
                    showStatus('shopStatus', `Successfully purchased ${itemKey}!`, 'success');
                    updateCoins();
                    renderInventory();
                } else {
                    // Rollback on save failure
                    user.coins = currentCoins;
                    user.inventory[itemKey]--;
                    if (user.inventory[itemKey] <= 0) {
                        delete user.inventory[itemKey];
                    }
                    showStatus('shopStatus', 'Purchase failed - please try again', 'error');
                }
            } catch (error) {
                console.error('Purchase error:', error);
                // Rollback on any error
                user.coins = currentCoins;
                if (user.inventory[itemKey]) {
                    user.inventory[itemKey]--;
                    if (user.inventory[itemKey] <= 0) {
                        delete user.inventory[itemKey];
                    }
                }
                showStatus('shopStatus', 'Purchase failed - please try again', 'error');
            } finally {
                // Unlock purchasing after a short delay
                setTimeout(() => {
                    isProcessingPurchase = false;
                }, 500);
            }
        }

        // ===== ADMIN FUNCTIONS =====
        function checkAdminAccess() {
            if (currentUser === 'admin') {
                document.getElementById('adminAccessDenied').classList.add('hidden');
                document.getElementById('adminContent').classList.remove('hidden');
                renderAdminPanel();
            } else {
                document.getElementById('adminAccessDenied').classList.remove('hidden');
                document.getElementById('adminContent').classList.add('hidden');
            }
        }

        function renderAdminPanel() {
            if (currentUser !== 'admin') return;

            // Update Gist link in admin panel
            if (config.gistId) {
                const gistUrl = `https://gist.github.com/${config.gistId}`;
                const adminGistLink = document.getElementById('adminGistLink');
                if (adminGistLink) {
                    adminGistLink.href = gistUrl;
                }
            }

            const pendingSpiders = spiders.filter(s => s.pending && !s.verified);
            const queueDiv = document.getElementById('verificationQueue');

            if (pendingSpiders.length === 0) {
                queueDiv.innerHTML = '<p style="color: #666;">No pending spiders</p>';
            } else {
                queueDiv.innerHTML = pendingSpiders.map(spider => `
                    <div style="background: rgba(255, 165, 0, 0.1); border: 2px solid rgba(255, 165, 0, 0.5); padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                        <img src="${spider.image}" style="max-width: 300px; max-height: 300px; border-radius: 10px; margin-bottom: 15px;" alt="${spider.name}">
                        <h3>${spider.name}</h3>
                        ${spider.latinName ? `<p style="font-style: italic; color: #aaa;">${spider.latinName}</p>` : ''}
                        <p style="color: #aaa;">By: ${spider.owner}</p>
                        <div class="stat"><span>Strength:</span><span>${spider.strength}</span></div>
                        <div class="stat"><span>Speed:</span><span>${spider.speed}</span></div>
                        ${spider.customFields && spider.customFields.length > 0 ? spider.customFields.map(field => `
                            <div class="stat"><span>${field.name}:</span><span>${field.value}</span></div>
                        `).join('') : ''}
                        <div class="stat" style="background: rgba(78, 205, 196, 0.2); border: 1px solid #4ecdc4;"><span>Total Power:</span><span>${calculateTotalPower(spider)}</span></div>
                        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 15px;">
                            <button onclick="verifySpider(${spider.id}, true)" style="background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%); padding: 12px 40px;">‚úì Approve</button>
                            <button onclick="verifySpider(${spider.id}, false)" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 12px 40px;">‚úï Deny</button>
                        </div>
                    </div>
                `).join('');
            }

            document.getElementById('adminMoves').value = JSON.stringify(MOVE_LIST, null, 2);
            document.getElementById('adminPricePotion').value = shopPrices.potion;
            document.getElementById('adminPriceSuperPotion').value = shopPrices.superPotion;
            document.getElementById('adminPriceFullRestore').value = shopPrices.fullRestore;
            document.getElementById('adminTaglines').value = taglines.join('\n');

            // Render bug reports
            document.getElementById('adminBugReports').innerHTML = renderBugReports();

            const usersList = document.getElementById('usersList');
            usersList.innerHTML = users.map(user => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: rgba(255, 255, 255, 0.05); border-radius: 5px;">
                    <div>
                        <strong>${user.username}</strong>
                        <div style="color: #aaa; font-size: 0.9em;">
                            Coins: ${user.coins || 0} | 
                            Spiders: ${spiders.filter(s => s.owner === user.username && s.verified).length}
                        </div>
                    </div>
                    ${user.username !== 'admin' ? `<button onclick="deleteUser('${user.username}')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">Delete</button>` : ''}
                </div>
            `).join('');
        }

        async function verifySpider(spiderId, approved) {
            const spider = spiders.find(s => s.id === spiderId);
            if (!spider) return;

            if (approved) {
                spider.verified = true;
                spider.pending = false;
                spider.moves = generateMoves(spider);
                
                const owner = users.find(u => u.username === spider.owner);
                if (owner) owner.coins += 50;
                
                showStatus('adminStatus', `Spider approved! ${spider.owner} earned 50 coins.`, 'success');
            } else {
                spiders = spiders.filter(s => s.id !== spiderId);
                showStatus('adminStatus', 'Spider denied and removed.', 'error');
            }

            await saveData();
            renderAdminPanel();
        }

        async function saveMoveList() {
            try {
                MOVE_LIST = JSON.parse(document.getElementById('adminMoves').value);
                if (await saveData()) {
                    showStatus('adminStatus', 'Move list updated!', 'success');
                }
            } catch (e) {
                showStatus('adminStatus', 'Invalid JSON format!', 'error');
            }
        }

        async function saveShopPrices() {
            shopPrices.potion = parseInt(document.getElementById('adminPricePotion').value);
            shopPrices.superPotion = parseInt(document.getElementById('adminPriceSuperPotion').value);
            shopPrices.fullRestore = parseInt(document.getElementById('adminPriceFullRestore').value);

            if (await saveData()) {
                showStatus('adminStatus', 'Shop prices updated!', 'success');
                updateShopPrices();
            }
        }
        
        async function saveTaglines() {
            const taglinesText = document.getElementById('adminTaglines').value;
            const lines = taglinesText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            
            if (lines.length === 0) {
                showStatus('adminStatus', 'Please enter at least one tagline!', 'error');
                return;
            }
            
            taglines = lines;
            
            if (await saveData()) {
                showStatus('adminStatus', `Taglines updated! (${taglines.length} total)`, 'success');
                updateTagline();
            }
        }

        async function deleteUser(username) {
            if (!confirm(`Delete user ${username}?`)) return;
            users = users.filter(u => u.username !== username);
            spiders = spiders.filter(s => s.owner !== username);
            
            // Update UI immediately
            renderAdminPanel();
            
            // Save in background
            debouncedSave();
        }

        // ===== BUG REPORT SYSTEM =====
        function openBugReport() {
            document.getElementById('bugReportModal').classList.add('active');
            // Pre-fill username if logged in
            if (currentUser) {
                document.getElementById('bugReporterName').value = currentUser;
            }
        }

        function closeBugReport() {
            document.getElementById('bugReportModal').classList.remove('active');
            document.getElementById('bugDescription').value = '';
            document.getElementById('bugSteps').value = '';
            document.getElementById('bugReporterName').value = '';
            document.getElementById('bugReportStatus').innerHTML = '';
        }

        function closeBugReportOnOverlay(event) {
            if (event.target.id === 'bugReportModal') {
                closeBugReport();
            }
        }

        async function submitBugReport() {
            const description = document.getElementById('bugDescription').value.trim();
            const steps = document.getElementById('bugSteps').value.trim();
            const reporterName = document.getElementById('bugReporterName').value.trim() || 'Anonymous';

            if (!description) {
                showStatus('bugReportStatus', 'Please describe the bug!', 'error');
                return;
            }

            const report = {
                id: `bug_${Date.now()}`,
                description: description,
                steps: steps,
                reportedBy: reporterName,
                timestamp: new Date().toISOString(),
                status: 'open'
            };

            bugReports.push(report);

            if (await saveData()) {
                showStatus('bugReportStatus', 'Bug report submitted! Thank you!', 'success');
                setTimeout(() => {
                    closeBugReport();
                }, 2000);
            } else {
                showStatus('bugReportStatus', 'Failed to submit. Please try again.', 'error');
            }
        }

        function renderBugReports() {
            if (currentUser !== 'admin') return '';

            const openReports = bugReports.filter(r => r.status === 'open');
            const closedReports = bugReports.filter(r => r.status === 'closed');

            let html = '<h3 style="color: #4ecdc4; margin-bottom: 15px;">üêõ Bug Reports</h3>';
            
            html += `
                <div style="background: rgba(78, 205, 196, 0.1); border: 2px solid rgba(78, 205, 196, 0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div>
                            <p style="color: #4ecdc4; font-size: 1.1em;"><strong>Total Reports:</strong> ${bugReports.length}</p>
                            <p style="color: #ffa500; font-size: 0.95em;">Open: ${openReports.length} | Closed: ${closedReports.length}</p>
                        </div>
                        ${bugReports.length > 0 ? `
                            <button onclick="clearAllBugReports()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 10px 20px;">
                                üóëÔ∏è Clear All Reports
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;

            if (openReports.length === 0 && closedReports.length === 0) {
                html += '<p style="color: #666; margin-bottom: 20px;">No bug reports yet</p>';
                return html;
            }

            if (openReports.length > 0) {
                html += '<div style="margin-bottom: 30px;">';
                html += '<h4 style="color: #ffa500; margin-bottom: 10px;">üì• Open Reports (${openReports.length}):</h4>';
                openReports.forEach((report, index) => {
                    const date = new Date(report.timestamp).toLocaleString();
                    html += `
                        <div style="background: rgba(255, 165, 0, 0.1); border: 2px solid rgba(255, 165, 0, 0.5); padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <p style="color: #aaa; font-size: 0.85em;">
                                    <strong style="color: #ffa500;">#${bugReports.length - index}</strong> | 
                                    Reported by: <strong>${report.reportedBy}</strong>
                                </p>
                                <p style="color: #888; font-size: 0.8em;">${date}</p>
                            </div>
                            <div style="background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 5px; margin: 10px 0;">
                                <p style="color: #fff;"><strong>Description:</strong></p>
                                <p style="color: #ddd; margin-top: 5px;">${report.description}</p>
                            </div>
                            ${report.steps ? `
                                <div style="background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 5px; margin: 10px 0;">
                                    <p style="color: #fff;"><strong>Steps to Reproduce:</strong></p>
                                    <p style="color: #ddd; margin-top: 5px; white-space: pre-wrap;">${report.steps}</p>
                                </div>
                            ` : ''}
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button onclick="closeBugReport_admin('${report.id}')" style="background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%); flex: 1;">
                                    ‚úì Mark as Resolved
                                </button>
                                <button onclick="deleteBugReport('${report.id}')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 10px 20px;">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            if (closedReports.length > 0) {
                html += `
                    <details style="margin-top: 20px;">
                        <summary style="color: #4ecdc4; cursor: pointer; margin-bottom: 10px; font-size: 1.1em; padding: 10px; background: rgba(78, 205, 196, 0.1); border-radius: 5px;">
                            ‚úì Resolved Reports (${closedReports.length})
                        </summary>
                        <div style="margin-top: 10px;">
                `;
                closedReports.forEach((report, index) => {
                    const date = new Date(report.timestamp).toLocaleString();
                    html += `
                        <div style="background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 5px; margin-bottom: 8px; opacity: 0.7; border-left: 3px solid #4ecdc4;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <p style="color: #aaa; font-size: 0.85em;">
                                    <strong style="color: #4ecdc4;">#${bugReports.length - bugReports.indexOf(report)}</strong> | 
                                    ${report.reportedBy} - ${date}
                                </p>
                                <button onclick="deleteBugReport('${report.id}')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 6px 12px; font-size: 0.85em;">
                                    üóëÔ∏è
                                </button>
                            </div>
                            <p style="color: #ccc; font-size: 0.9em;">${report.description}</p>
                            ${report.steps ? `<p style="color: #888; font-size: 0.85em; margin-top: 5px; font-style: italic;">Steps: ${report.steps.substring(0, 100)}${report.steps.length > 100 ? '...' : ''}</p>` : ''}
                        </div>
                    `;
                });
                html += '</div></details>';
            }

            return html;
        }

        async function closeBugReport_admin(reportId) {
            const report = bugReports.find(r => r.id === reportId);
            if (report) {
                report.status = 'closed';
                await saveData();
                renderAdminPanel();
                showStatus('adminStatus', 'Bug report marked as resolved!', 'success');
            }
        }

        async function deleteBugReport(reportId) {
            if (!confirm('Delete this bug report permanently?')) return;
            
            bugReports = bugReports.filter(r => r.id !== reportId);
            await saveData();
            renderAdminPanel();
            showStatus('adminStatus', 'Bug report deleted!', 'success');
        }

        async function clearAllBugReports() {
            const confirmed = confirm(
                `‚ö†Ô∏è WARNING ‚ö†Ô∏è\n\nThis will permanently delete ALL ${bugReports.length} bug reports (both open and closed).\n\nThis action cannot be undone!\n\nAre you sure?`
            );
            
            if (!confirmed) return;
            
            const doubleCheck = confirm(
                `Really clear all ${bugReports.length} reports?\n\nLast chance to cancel!`
            );
            
            if (!doubleCheck) return;
            
            bugReports = [];
            await saveData();
            renderAdminPanel();
            showStatus('adminStatus', 'All bug reports cleared!', 'success');
        }

        // ===== INITIALIZATION =====
        loadConfig();
        updateTagline();
        
        // Auto-save any pending changes when user leaves
        window.addEventListener('beforeunload', () => {
            if (pendingSave) {
                saveDataNow();
            }
        });
    </script>
</body>
</html>
