<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>Spider League</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 15px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto;
            width: 100%;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
        }
        
        h1 { 
            font-size: clamp(2em, 8vw, 3em);
            margin-bottom: 10px;
            word-break: break-word;
        }
        
        h2 {
            font-size: clamp(1.3em, 5vw, 1.8em);
        }
        
        h3 {
            font-size: clamp(1.1em, 4vw, 1.3em);
        }
        
        .nav-tabs {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            padding: 0 5px;
        }
        
        .tab-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: clamp(14px, 3.5vw, 16px);
            font-weight: bold;
            transition: all 0.3s;
            touch-action: manipulation;
            min-height: 44px;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%);
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .config-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px 15px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        
        .config-section h2 { margin-bottom: 15px; color: #4ecdc4; }
        
        .input-group { margin-bottom: 15px; }
        
        label { 
            display: block; 
            margin-bottom: 8px; 
            color: #aaa;
            font-size: clamp(14px, 3.5vw, 16px);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
            min-height: 44px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: 2px solid #4ecdc4;
            outline-offset: 2px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: clamp(14px, 3.5vw, 16px);
            font-weight: bold;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
            touch-action: manipulation;
            min-height: 44px;
        }
        
        button:active { transform: scale(0.95); }
        button:hover { transform: translateY(-2px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .spider-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .rarity-common { border-color: rgba(158, 158, 158, 0.8) !important; }
        .rarity-uncommon { border-color: rgba(30, 255, 0, 0.8) !important; }
        .rarity-rare { border-color: rgba(0, 112, 221, 0.8) !important; }
        .rarity-epic { border-color: rgba(163, 53, 238, 0.8) !important; }
        .rarity-legendary { border-color: rgba(255, 128, 0, 0.8) !important; }
        .rarity-mythic { 
            border-color: rgba(255, 0, 0, 0.8) !important;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
            animation: mythicGlow 2s infinite;
        }
        
        @keyframes mythicGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.5); }
            50% { box-shadow: 0 0 30px rgba(255, 0, 0, 0.8); }
        }
        
        .countdown-timer {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin: 20px 0;
            font-size: 1.5em;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .countdown-timer.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            font-size: 2em;
            animation: shake 0.5s infinite;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .hat-slot {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            position: relative;
            text-align: center;
        }
        
        .hat-emoji {
            font-size: 4em;
            margin: 10px 0;
        }
        
        .hat-inventory-item {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 15px;
            align-items: center;
        }
        
        .hat-inventory-item .hat-emoji {
            font-size: 3em;
            margin: 0;
        }

        .spider-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .spider-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 15px;
            background: rgba(0, 0, 0, 0.3);
            touch-action: manipulation;
        }
        
        .spider-name {
            font-size: clamp(1.2em, 4vw, 1.5em);
            margin-bottom: 10px;
            color: #4ecdc4;
            word-break: break-word;
        }
        
        .stat {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
            font-size: clamp(13px, 3.2vw, 15px);
        }
        
        .stat-allocator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .stat-allocator button {
            padding: 8px 16px;
            min-height: 40px;
            margin: 0;
        }
        
        .stat-allocator input {
            width: 60px;
            text-align: center;
            padding: 8px;
            min-height: 40px;
        }
        
        .points-remaining {
            background: rgba(255, 165, 0, 0.2);
            border: 2px solid rgba(255, 165, 0, 0.6);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin: 15px 0;
            font-size: 1.1em;
            color: #ffa500;
        }
        
        .user-coins {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            font-size: clamp(14px, 3.5vw, 16px);
            margin: 10px 5px;
        }
        
        .hidden { display: none; }
        
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-size: clamp(14px, 3.5vw, 16px);
        }
        
        .status.success {
            background: rgba(78, 205, 196, 0.2);
            border: 1px solid #4ecdc4;
        }
        
        .status.error {
            background: rgba(245, 87, 108, 0.2);
            border: 1px solid #f5576c;
        }

        .hp-bar {
            width: 100%;
            height: 28px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a6a0);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(12px, 3vw, 14px);
            font-weight: bold;
            transition: width 0.5s;
        }

        .hp-fill.low {
            background: linear-gradient(90deg, #ff6b6b, #ee5a6f);
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            min-height: 44px;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%);
        }

        .owner-history {
            font-size: 0.85em;
            color: #aaa;
            margin-top: 5px;
            font-style: italic;
        }

        .move-list {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 10px;
        }

        .inventory-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .inventory-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            font-size: clamp(14px, 3.5vw, 16px);
        }
        
        @media screen and (max-width: 767px) {
            input[type="text"],
            input[type="password"],
            input[type="number"],
            select,
            textarea {
                font-size: 16px !important;
            }
        }
        
        @supports (padding: max(0px)) {
            body {
                padding-left: max(15px, env(safe-area-inset-left));
                padding-right: max(15px, env(safe-area-inset-right));
                padding-bottom: max(15px, env(safe-area-inset-bottom));
            }
        }
        
        @keyframes pulse {
            0%, 100% { 
                background: rgba(255, 255, 255, 0.1);
            }
            50% { 
                background: rgba(255, 87, 108, 0.3);
                box-shadow: 0 0 20px rgba(255, 87, 108, 0.5);
            }
        }
        
        .bug-report-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .bug-report-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }
        
        .bug-report-btn:active {
            transform: translateY(0);
        }
        
        .bug-report-modal, .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .bug-report-modal.active, .login-modal.active {
            display: flex;
        }
        
        .bug-report-content, .login-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid #4ecdc4;
        }
        
        .bug-report-content h2, .login-content h2 {
            color: #4ecdc4;
            margin-bottom: 20px;
        }
        
        .bug-report-content textarea {
            width: 100%;
            min-height: 150px;
            margin-bottom: 15px;
            font-family: inherit;
        }
        
        @media (max-width: 640px) {
            .bug-report-btn {
                bottom: 15px;
                right: 15px;
                padding: 12px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üï∑Ô∏è Spider League üï∑Ô∏è</h1>
            <p id="tagline">Pokemon-Style Spider Battles!</p>
        </header>

        <div style="text-align: center; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap;">
            <button onclick="toggleConfig()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">‚öôÔ∏è Settings</button>
            <div class="user-coins" id="userCoins">üí∞ 0 coins</div>
            <button onclick="openLoginModal()" id="loginBtn" style="background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%);">üë§ Login / Register</button>
            <button onclick="logout()" id="logoutBtn" class="hidden" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">üö™ Logout</button>
        </div>

        <div id="configSection" class="config-section hidden">
            <h2>‚öôÔ∏è GitHub Configuration</h2>
            <div class="input-group">
                <label>GitHub Token:</label>
                <input type="password" id="githubToken" placeholder="ghp_...">
            </div>
            <div class="input-group">
                <label>Gist ID:</label>
                <input type="text" id="gistId" placeholder="Leave empty for first time">
            </div>
            <button onclick="saveConfig()">Save Configuration</button>
            <button onclick="loadData()">Refresh Data</button>
            <div id="configStatus"></div>
        </div>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('collection')">üï∏Ô∏è Collection</button>
            <button class="tab-btn" onclick="switchTab('add')">‚ûï Add Spider</button>
            <button class="tab-btn" onclick="switchTab('battle')" id="battleTabBtn">‚öîÔ∏è Battle</button>
            <button class="tab-btn" onclick="switchTab('trade')" id="tradeTabBtn">üîÑ Trade</button>
            <button class="tab-btn" onclick="switchTab('shop')">üõí Shop & Inventory</button>
            <button class="tab-btn" onclick="switchTab('hats')">üé© Hats</button>
            <button class="tab-btn hidden" onclick="switchTab('admin')" id="adminTab">üëë Admin</button>
        </div>

        <div id="collectionTab" class="tab-content active">
            <div class="config-section">
                <h2>üï∏Ô∏è Spider Collection</h2>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="setFilter('all')">All Spiders</button>
                    <button class="filter-btn" onclick="setFilter('mine')">My Spiders</button>
                </div>
                <div class="spider-grid" id="spiderGrid">
                    <p style="color: #666;">Loading spiders...</p>
                </div>
            </div>
        </div>

        <div id="addTab" class="tab-content">
            <div class="config-section">
                <h2>‚ûï Add New Spider</h2>
                <div class="input-group">
                    <label>Spider Name:</label>
                    <input type="text" id="spiderName" placeholder="e.g., Sir Websworth">
                </div>
                <div class="input-group">
                    <label>Latin Name (Scientific):</label>
                    <input type="text" id="spiderLatinName" placeholder="e.g., Araneus diadematus">
                </div>
                <div class="input-group">
                    <label>Spider Image:</label>
                    <div style="display: flex; gap: 10px; flex-direction: column;">
                        <input type="file" id="spiderImageFile" accept="image/*" onchange="handleImageUpload(event)" style="padding: 8px;">
                        <p style="color: #aaa; font-size: 0.85em; margin: 5px 0;">OR</p>
                        <input type="text" id="spiderImage" placeholder="Image URL (if not uploading)">
                    </div>
                    <div id="imagePreview" style="margin-top: 10px; display: none;">
                        <img id="previewImg" style="max-width: 200px; max-height: 200px; border-radius: 10px; border: 2px solid rgba(78, 205, 196, 0.5);">
                        <p style="color: #4ecdc4; font-size: 0.9em; margin-top: 5px;">‚úì Image ready to upload</p>
                    </div>
                </div>
                
                <div class="points-remaining" id="pointsRemaining">
                    <strong>Points Remaining: <span id="pointsCount">95</span>/95</strong>
                </div>
                
                <div class="input-group">
                    <label>Strength:</label>
                    <div class="stat-allocator">
                        <button onclick="changeStat('strength', -1)">‚àí</button>
                        <input type="number" id="strength" value="1" min="1" max="100" readonly>
                        <button onclick="changeStat('strength', 1)">+</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Speed:</label>
                    <div class="stat-allocator">
                        <button onclick="changeStat('speed', -1)">‚àí</button>
                        <input type="number" id="speed" value="1" min="1" max="100" readonly>
                        <button onclick="changeStat('speed', 1)">+</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Size:</label>
                    <div class="stat-allocator">
                        <button onclick="changeStat('size', -1)">‚àí</button>
                        <input type="number" id="size" value="1" min="1" max="100" readonly>
                        <button onclick="changeStat('size', 1)">+</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Venom:</label>
                    <div class="stat-allocator">
                        <button onclick="changeStat('venom', -1)">‚àí</button>
                        <input type="number" id="venom" value="1" min="1" max="100" readonly>
                        <button onclick="changeStat('venom', 1)">+</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Toughness:</label>
                    <div class="stat-allocator">
                        <button onclick="changeStat('toughness', -1)">‚àí</button>
                        <input type="number" id="toughness" value="1" min="1" max="100" readonly>
                        <button onclick="changeStat('toughness', 1)">+</button>
                    </div>
                </div>
                
                <h3 style="color: #4ecdc4; margin-top: 20px;">Custom Fields (Optional)</h3>
                <p style="color: #aaa; font-size: 0.9em; margin-bottom: 10px;">Add fun custom info (won't affect battles)</p>
                <div id="customFieldsContainer"></div>
                <button onclick="addCustomField()" style="background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%); margin-bottom: 15px;">+ Add Custom Field</button>
                
                <button onclick="addSpider()">Submit Spider for Approval</button>
                <div id="addStatus"></div>
            </div>
        </div>

        <div id="battleTab" class="tab-content">
            <div class="config-section">
                <h2>‚öîÔ∏è Battle Arena</h2>
                <div id="battleSelectPhase">
                    <p style="color: #aaa; margin-bottom: 15px;">Select your spider to challenge an opponent:</p>
                    <div class="spider-grid" id="battleSelectSpiders"></div>
                </div>
                <div id="battleOpponentPhase" class="hidden">
                    <button onclick="backToBattleSelect()">‚Üê Back</button>
                    <p style="color: #aaa; margin: 15px 0;">Choose your opponent:</p>
                    <div class="spider-grid" id="battleOpponents"></div>
                </div>
                <div id="battleArenaPhase" class="hidden"></div>
            </div>
        </div>

        <div id="tradeTab" class="tab-content">
            <div class="config-section">
                <h2>üîÑ Trade Center</h2>
                
                <div style="background: rgba(78, 205, 196, 0.1); border: 2px solid rgba(78, 205, 196, 0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #4ecdc4; margin-bottom: 10px;">üì• Incoming Trade Offers</h3>
                    <div id="incomingTrades"></div>
                </div>

                <div style="background: rgba(255, 165, 0, 0.1); border: 2px solid rgba(255, 165, 0, 0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #ffa500; margin-bottom: 10px;">üì§ Outgoing Trade Offers</h3>
                    <div id="outgoingTrades"></div>
                </div>

                <div>
                    <h3 style="color: #4ecdc4; margin-bottom: 15px;">‚ú® Create Trade Offer</h3>
                    <p style="color: #aaa; margin-bottom: 15px;">Select one of your spiders to offer in trade:</p>
                    <div class="spider-grid" id="tradeMySpiders"></div>
                </div>
            </div>
        </div>

        <div id="hatsTab" class="tab-content">
            <div class="config-section">
                <h2>üé© Hat Shop</h2>
                
                <div class="countdown-timer" id="hatCountdown">
                    Next hats in: --:--:--
                </div>
                
                <div class="spider-grid" id="dailyHatSlots"></div>
            </div>
            
            <div class="config-section">
                <h2>üéí Your Hat Collection</h2>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center;">
                    <button class="filter-btn active" onclick="filterHats('all')">All Hats</button>
                    <button class="filter-btn" onclick="filterHats('equipped')">Equipped</button>
                    <button class="filter-btn" onclick="filterHats('unequipped')">Unequipped</button>
                    <button class="filter-btn" onclick="filterHats('common')">Common</button>
                    <button class="filter-btn" onclick="filterHats('uncommon')">Uncommon</button>
                    <button class="filter-btn" onclick="filterHats('rare')">Rare</button>
                    <button class="filter-btn" onclick="filterHats('epic')">Epic</button>
                    <button class="filter-btn" onclick="filterHats('legendary')">Legendary</button>
                    <button class="filter-btn" onclick="filterHats('mythic')">Mythic</button>
                </div>
                
                <div id="hatInventory"></div>
            </div>
        </div>

        <div id="shopTab" class="tab-content">
            <div class="config-section">
                <h2>üéí Your Inventory</h2>
                <div id="inventoryDisplay" class="inventory-display">
                    <p style="color: #666;">Your items will appear here</p>
                </div>
            </div>
            <div class="config-section">
                <h2>üõí Shop</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;">
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 3em;">‚ö°</div>
                        <h3>Potion</h3>
                        <p style="color: #aaa;">Restore 20 Toughness in battle</p>
                        <div style="color: #ffd700; font-weight: bold; margin: 10px 0; font-size: 1.2em;">üí∞ <span id="pricePotion">15</span> coins</div>
                        <button onclick="buyShopItem('potion')">Buy</button>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 3em;">üíä</div>
                        <h3>Super Potion</h3>
                        <p style="color: #aaa;">Restore 50 Toughness in battle</p>
                        <div style="color: #ffd700; font-weight: bold; margin: 10px 0; font-size: 1.2em;">üí∞ <span id="priceSuperPotion">30</span> coins</div>
                        <button onclick="buyShopItem('superPotion')">Buy</button>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 3em;">‚ú®</div>
                        <h3>Full Restore</h3>
                        <p style="color: #aaa;">Restore all Toughness in battle</p>
                        <div style="color: #ffd700; font-weight: bold; margin: 10px 0; font-size: 1.2em;">üí∞ <span id="priceFullRestore">50</span> coins</div>
                        <button onclick="buyShopItem('fullRestore')">Buy</button>
                    </div>
                </div>
                <div id="shopStatus"></div>
            </div>
        </div>

        <div id="adminTabContent" class="tab-content">
            <div class="config-section">
                <h2>üëë Admin Panel</h2>
                
                <div id="adminAccessDenied">
                    <p style="color: #f5576c;">‚õî Access Denied - Admin login required</p>
                </div>

                <div id="adminContent" class="hidden">
                    <div style="background: rgba(78, 205, 196, 0.1); border: 2px solid rgba(78, 205, 196, 0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h3 style="color: #4ecdc4; margin-bottom: 10px;">üìù Direct Gist Access</h3>
                        <p style="color: #aaa; margin-bottom: 10px; font-size: 0.95em;">Edit the raw data directly on GitHub for advanced modifications:</p>
                        <a id="adminGistLink" href="#" target="_blank" style="display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%); color: white; text-decoration: none; border-radius: 25px; font-weight: bold;">
                            Open Gist in GitHub ‚Üí
                        </a>
                        <p style="color: #ffa500; margin-top: 10px; font-size: 0.9em;">‚ö†Ô∏è Be careful when editing directly - invalid JSON will break the game!</p>
                    </div>

                    <h3 style="color: #4ecdc4;">üìã Spider Verification Queue</h3>
                    <div id="verificationQueue" style="margin-bottom: 30px;"></div>

                    <h3 style="color: #4ecdc4;">‚öîÔ∏è Move List Editor</h3>
                    <p style="color: #aaa; margin-bottom: 10px;">Edit the list of moves available in the game (JSON format):</p>
                    <textarea id="adminMoves" rows="10" style="font-family: monospace; font-size: 12px;"></textarea>
                    <button onclick="saveMoveList()">Save Move List</button>

                    <h3 style="color: #4ecdc4; margin-top: 30px;">üõí Shop Prices</h3>
                    <div class="input-group">
                        <label>Potion Price:</label>
                        <input type="number" id="adminPricePotion" min="0" value="15">
                    </div>
                    <div class="input-group">
                        <label>Super Potion Price:</label>
                        <input type="number" id="adminPriceSuperPotion" min="0" value="30">
                    </div>
                    <div class="input-group">
                        <label>Full Restore Price:</label>
                        <input type="number" id="adminPriceFullRestore" min="0" value="50">
                    </div>
                    <button onclick="saveShopPrices()">Save Shop Prices</button>

                    <h3 style="color: #4ecdc4; margin-top: 30px;">üí¨ Daily Taglines</h3>
                    <p style="color: #aaa; margin-bottom: 10px;">Edit the rotating taglines that appear in the header (one per line):</p>
                    <textarea id="adminTaglines" rows="8" style="font-family: inherit; font-size: 14px;" placeholder="Enter one tagline per line..."></textarea>
                    <button onclick="saveTaglines()">Save Taglines</button>

                    <h3 style="color: #4ecdc4; margin-top: 30px;">üë• User Management</h3>
                    <div id="usersList" style="background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 5px;"></div>
                    
                    <div id="adminStatus"></div>
                </div>
            </div>
        </div>

        <button class="bug-report-btn" onclick="openBugReport()">
            üêõ Report Bug
        </button>

        <div id="loginModal" class="login-modal" onclick="closeLoginModalOnOverlay(event)">
            <div class="login-content" onclick="event.stopPropagation()">
                <h2>üë§ Login / Register</h2>
                <div style="background: rgba(255, 165, 0, 0.2); border: 2px solid rgba(255, 165, 0, 0.6); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <strong style="color: #ffa500;">‚ö†Ô∏è Security Warning:</strong>
                    <p style="color: #ffcc00; margin-top: 8px; font-size: 0.95em;">
                        Your password will be hashed and stored in a GitHub Gist. <strong>DO NOT use a password you use anywhere else!</strong> This is a casual game - use a simple, unique password.
                    </p>
                </div>
                <div class="input-group">
                    <label>Username:</label>
                    <input type="text" id="username" placeholder="Enter username">
                </div>
                <div class="input-group">
                    <label>Password (use a unique password!):</label>
                    <input type="password" id="password" placeholder="Enter a simple, unique password">
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="login()" style="flex: 1; background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%);">Login</button>
                    <button onclick="register()" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">Register</button>
                </div>
                <button onclick="closeLoginModal()" style="width: 100%; margin-top: 10px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">Cancel</button>
                <div id="loginStatus"></div>
            </div>
        </div>

        <div id="bugReportModal" class="bug-report-modal" onclick="closeBugReportOnOverlay(event)">
            <div class="bug-report-content" onclick="event.stopPropagation()">
                <h2>üêõ Report a Bug</h2>
                <p style="color: #aaa; margin-bottom: 15px;">Help us improve Spider League! Describe the bug you encountered.</p>
                
                <div class="input-group">
                    <label>What happened?</label>
                    <textarea id="bugDescription" placeholder="Describe the bug in detail..."></textarea>
                </div>
                
                <div class="input-group">
                    <label>Steps to reproduce (optional):</label>
                    <textarea id="bugSteps" rows="4" placeholder="1. Go to...&#10;2. Click on...&#10;3. See error"></textarea>
                </div>
                
                <div class="input-group">
                    <label>Your username (optional):</label>
                    <input type="text" id="bugReporterName" placeholder="So we can follow up with you">
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="submitBugReport()" style="flex: 1; background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%);">Submit Report</button>
                    <button onclick="closeBugReport()" style="flex: 1; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">Cancel</button>
                </div>
                
                <div id="bugReportStatus"></div>
            </div>
        </div>
    </div>

    <script>
        // HAT SYSTEM
        const HAT_EMOJIS = ['üé©', 'üëë', 'üß¢', '‚õëÔ∏è', 'üéì', 'üëí', 'ü™ñ', 'üéñÔ∏è', '‚õ∑Ô∏è', 'üèîÔ∏è', 'üåü', 'üíé', 'üîÆ', 'üëæ', 'üéØ', 'üé™', 'üé≠', 'üé®', 'üé¨', 'üé§', 'üéß', 'üéº', 'üéπ', 'üé∫', 'üé∏', 'ü•Å', 'üéª', 'üé≤', 'üé∞', 'üé≥'];
        const HAT_ADJECTIVES = ['Crimson', 'Golden', 'Azure', 'Emerald', 'Obsidian', 'Crystal', 'Mystic', 'Ancient', 'Ethereal', 'Radiant', 'Shadow', 'Frost', 'Flame', 'Storm', 'Lunar', 'Solar', 'Cosmic', 'Arcane', 'Divine', 'Cursed', 'Blessed', 'Legendary', 'Epic', 'Royal', 'Imperial', 'Noble', 'Savage', 'Wild', 'Primal', 'Eternal'];
        const HAT_NOUNS = ['Crown', 'Helm', 'Cap', 'Hat', 'Tiara', 'Circlet', 'Diadem', 'Coronet', 'Headpiece', 'Topper', 'Beret', 'Hood', 'Bandana', 'Turban', 'Headdress'];
        const HAT_TYPES = ['of Power', 'of Wisdom', 'of Speed', 'of Strength', 'of Venom', 'of Size', 'of Dominance', 'of Glory', 'of Victory', 'of Legends', 'of Champions', 'of Heroes', 'of Kings', 'of Queens', 'of Warriors', 'of Assassins', 'of Titans', 'of Gods'];
        
        let dailyHats = [];
        let hatInventory = [];
        let currentHatFilter = 'all';
        
        function generateHat() {
            const roll = Math.random();
            let rarity, statCount, minBonus, maxBonus, priceMin, priceMax;
            
            if (roll < 0.50) {
                rarity = 'common';
                statCount = 1;
                minBonus = 5;
                maxBonus = 15;
                priceMin = 500;
                priceMax = 1000;
            } else if (roll < 0.75) {
                rarity = 'uncommon';
                statCount = Math.random() < 0.7 ? 1 : 2;
                minBonus = 10;
                maxBonus = 20;
                priceMin = 1000;
                priceMax = 1500;
            } else if (roll < 0.90) {
                rarity = 'rare';
                statCount = Math.random() < 0.5 ? 1 : 2;
                minBonus = 15;
                maxBonus = 30;
                priceMin = 1500;
                priceMax = 2000;
            } else if (roll < 0.97) {
                rarity = 'epic';
                statCount = Math.floor(Math.random() * 2) + 2;
                minBonus = 20;
                maxBonus = 40;
                priceMin = 2000;
                priceMax = 2500;
            } else if (roll < 0.999) {
                rarity = 'legendary';
                statCount = Math.floor(Math.random() * 2) + 3;
                minBonus = 30;
                maxBonus = 60;
                priceMin = 2500;
                priceMax = 3000;
            } else {
                rarity = 'mythic';
                statCount = 5;
                minBonus = 50;
                maxBonus = 100;
                priceMin = 5000;
                priceMax = 10000;
            }
            
            const stats = { strength: 0, speed: 0, size: 0, venom: 0, toughness: 0 };
            const statNames = ['strength', 'speed', 'size', 'venom', 'toughness'];
            const selectedStats = [...statNames].sort(() => Math.random() - 0.5).slice(0, statCount);
            
            selectedStats.forEach(stat => {
                stats[stat] = Math.floor(Math.random() * (maxBonus - minBonus + 1)) + minBonus;
            });
            
            const emoji = HAT_EMOJIS[Math.floor(Math.random() * HAT_EMOJIS.length)];
            const adj = HAT_ADJECTIVES[Math.floor(Math.random() * HAT_ADJECTIVES.length)];
            const noun = HAT_NOUNS[Math.floor(Math.random() * HAT_NOUNS.length)];
            const type = HAT_TYPES[Math.floor(Math.random() * HAT_TYPES.length)];
            const name = `${adj} ${noun} ${type}`;
            
            const price = Math.floor(Math.random() * (priceMax - priceMin + 1)) + priceMin;
            
            return {
                id: `hat_${Date.now()}_${Math.random()}`,
                name,
                emoji,
                rarity,
                stats,
                price,
                purchasedBy: null,
                purchasedAt: null,
                pricePaid: null,
                equippedTo: null,
                createdAt: new Date().toISOString()
            };
        }
        
        function initializeDailyHats() {
            const now = new Date();
            const lastReset = window.localStorage.getItem('lastHatReset');
            const today = now.toISOString().split('T')[0];
            
            if (lastReset !== today) {
                const yesterday = new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString();
                dailyHats = dailyHats.filter(hat => {
                    return hat.purchasedBy !== null || hat.createdAt >= yesterday;
                });
                
                while (dailyHats.length < 3) {
                    const newHat = generateHat();
                    newHat.createdAt = now.toISOString();
                    dailyHats.push(newHat);
                }
                
                window.localStorage.setItem('lastHatReset', today);
                saveData();
            } else if (dailyHats.length === 0) {
                const hat1 = generateHat();
                const hat2 = generateHat();
                const hat3 = generateHat();
                hat1.createdAt = now.toISOString();
                hat2.createdAt = now.toISOString();
                hat3.createdAt = now.toISOString();
                dailyHats = [hat1, hat2, hat3];
                saveData();
            }
        }
        
        function getTimeUntilMidnight() {
            const now = new Date();
            const utcNow = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 
                                    now.getUTCHours(), now.getUTCMinutes(), now.getUTCSeconds());
            const midnight = Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + 1, 0, 0, 0);
            return midnight - utcNow;
        }
        
        function updateHatCountdown() {
            const timeLeft = getTimeUntilMidnight();
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            const countdownEl = document.getElementById('hatCountdown');
            if (countdownEl) {
                countdownEl.textContent = `Next hats in: ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                if (hours < 5) {
                    countdownEl.classList.add('warning');
                } else {
                    countdownEl.classList.remove('warning');
                }
            }
            
            if (timeLeft <= 0) {
                const today = new Date().toISOString().split('T')[0];
                const lastReset = window.localStorage.getItem('lastHatReset');
                if (lastReset !== today) {
                    initializeDailyHats();
                    renderDailyHats();
                }
            }
        }
        
        async function purchaseHat(slotIndex) {
            if (!currentUser) {
                alert('Please login first!');
                return;
            }
            
            const hat = dailyHats[slotIndex];
            if (!hat) {
                alert('Hat not found!');
                return;
            }
            
            const user = users.find(u => u.username === currentUser);
            
            if (user.coins < hat.price) {
                alert(`Not enough coins! You need ${hat.price} coins.`);
                return;
            }
            
            if (!confirm(`Purchase ${hat.name} for ${hat.price} coins?`)) {
                return;
            }
            
            user.coins -= hat.price;
            hat.purchasedBy = currentUser;
            hat.purchasedAt = new Date().toISOString();
            hat.pricePaid = hat.price;
            
            hatInventory.push(hat);
            dailyHats.splice(slotIndex, 1);
            
            await saveData();
            updateCoins();
            renderDailyHats();
            renderHatInventory();
            
            alert(`You purchased ${hat.name}!`);
        }
        
        function renderDailyHats() {
            const container = document.getElementById('dailyHatSlots');
            if (!container) return;
            
            const slotsToShow = [];
            for (let i = 0; i < 3; i++) {
                if (dailyHats[i]) {
                    slotsToShow.push({ hat: dailyHats[i], index: i });
                } else {
                    slotsToShow.push({ hat: null, index: i });
                }
            }
            
            container.innerHTML = slotsToShow.map(({ hat, index }) => {
                if (!hat) {
                    return `
                        <div class="hat-slot" style="border: 2px dashed rgba(255, 255, 255, 0.3); opacity: 0.5;">
                            <div class="hat-emoji" style="font-size: 3em;">‚ùì</div>
                            <h3 style="color: #666;">Empty Slot</h3>
                            <p style="color: #888; margin: 10px 0;">Check back after reset!</p>
                        </div>
                    `;
                }
                
                const statList = Object.entries(hat.stats)
                    .filter(([stat, value]) => value > 0)
                    .map(([stat, value]) => `+${value} ${stat.charAt(0).toUpperCase() + stat.slice(1)}`)
                    .join(', ');
                
                return `
                    <div class="hat-slot rarity-${hat.rarity}">
                        <div class="hat-emoji">${hat.emoji}</div>
                        <h3 style="color: #4ecdc4;">${hat.name}</h3>
                        <p style="color: #ffa500; text-transform: uppercase; font-weight: bold; margin: 10px 0;">${hat.rarity}</p>
                        <p style="color: #ddd; margin: 10px 0;">${statList}</p>
                        <p style="color: #ffd700; font-size: 1.3em; font-weight: bold; margin: 15px 0;">üí∞ ${hat.price} coins</p>
                        <button onclick="purchaseHat(${index})">Buy Hat</button>
                    </div>
                `;
            }).join('');
        }
        
        function filterHats(filter) {
            currentHatFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.textContent.toLowerCase().includes(filter.toLowerCase()) || 
                    (filter === 'all' && btn.textContent === 'All Hats')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            renderHatInventory();
        }
        
        function renderHatInventory() {
            const container = document.getElementById('hatInventory');
            if (!container) return;
            
            if (!currentUser) {
                container.innerHTML = '<p style="color: #666;">Please login to see your hats!</p>';
                return;
            }
            
            const userHats = hatInventory.filter(h => h.purchasedBy === currentUser);
            
            let filtered = userHats;
            if (currentHatFilter === 'equipped') {
                filtered = userHats.filter(h => h.equippedTo !== null);
            } else if (currentHatFilter === 'unequipped') {
                filtered = userHats.filter(h => h.equippedTo === null);
            } else if (currentHatFilter !== 'all') {
                filtered = userHats.filter(h => h.rarity === currentHatFilter);
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="color: #666;">No hats match this filter.</p>';
                return;
            }
            
            container.innerHTML = filtered.map(hat => {
                const equippedSpider = hat.equippedTo ? spiders.find(s => s.id === hat.equippedTo) : null;
                const statList = Object.entries(hat.stats)
                    .filter(([stat, value]) => value > 0)
                    .map(([stat, value]) => `+${value} ${stat.charAt(0).toUpperCase() + stat.slice(1)}`)
                    .join(', ');
                
                const purchaseDate = new Date(hat.purchasedAt).toLocaleDateString();
                
                return `
                    <div class="hat-inventory-item rarity-${hat.rarity}">
                        <div class="hat-emoji">${hat.emoji}</div>
                        <div style="flex: 1;">
                            <h3 style="color: #4ecdc4; margin-bottom: 5px;">${hat.name}</h3>
                            <p style="color: #ffa500; text-transform: uppercase; font-size: 0.9em; font-weight: bold;">${hat.rarity}</p>
                            <p style="color: #ddd; margin: 5px 0;">${statList}</p>
                            <p style="color: #aaa; font-size: 0.85em; margin-top: 8px;">
                                Purchased: ${purchaseDate} for ${hat.pricePaid} coins
                            </p>
                            ${equippedSpider ? 
                                `<p style="color: #4ecdc4; font-size: 0.9em; margin-top: 5px;">‚úì Equipped to: ${equippedSpider.name}</p>
                                <button onclick="unequipHat('${hat.id}')" style="margin-top: 10px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">Remove Hat</button>` :
                                `<button onclick="openEquipHatModal('${hat.id}')" style="margin-top: 10px;">Equip to Spider</button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function openEquipHatModal(hatId) {
            const hat = hatInventory.find(h => h.id === hatId);
            const mySpiders = spiders.filter(s => s.owner === currentUser && s.verified);
            
            if (mySpiders.length === 0) {
                alert('You have no spiders to equip this hat to!');
                return;
            }
            
            const spiderList = mySpiders.map((s, i) => `${i + 1}. ${s.name}`).join('\n');
            const choice = prompt(`Equip ${hat.name} to which spider?\n\n${spiderList}\n\nEnter the number:`);
            
            if (!choice) return;
            
            const index = parseInt(choice) - 1;
            if (index < 0 || index >= mySpiders.length) {
                alert('Invalid choice!');
                return;
            }
            
            equipHatToSpider(hatId, mySpiders[index].id);
        }
        
        async function equipHatToSpider(hatId, spiderId) {
            const hat = hatInventory.find(h => h.id === hatId);
            const spider = spiders.find(s => s.id === spiderId);
            
            if (!hat || !spider) return;
            
            if (spider.hatId) {
                const oldHat = hatInventory.find(h => h.id === spider.hatId);
                if (oldHat) oldHat.equippedTo = null;
            }
            
            if (hat.equippedTo) {
                const oldSpider = spiders.find(s => s.id === hat.equippedTo);
                if (oldSpider) oldSpider.hatId = null;
            }
            
            hat.equippedTo = spiderId;
            spider.hatId = hatId;
            
            await saveData();
            renderHatInventory();
            renderSpiders();
            
            alert(`Equipped ${hat.name} to ${spider.name}!`);
        }
        
        async function unequipHat(hatId) {
            const hat = hatInventory.find(h => h.id === hatId);
            if (!hat) return;
            
            const spider = spiders.find(s => s.id === hat.equippedTo);
            
            hat.equippedTo = null;
            if (spider) spider.hatId = null;
            
            await saveData();
            renderHatInventory();
            renderSpiders();
            
            alert('Hat removed!');
        }
        
        function getSpiderWithHatStats(spider) {
            const baseStats = {
                strength: spider.strength,
                speed: spider.speed,
                size: spider.size,
                venom: spider.venom,
                toughness: spider.toughness,
                maxToughness: spider.maxToughness
            };
            
            if (!spider.hatId) return baseStats;
            
            const hat = hatInventory.find(h => h.id === spider.hatId);
            if (!hat) return baseStats;
            
            return {
                strength: baseStats.strength + (hat.stats.strength || 0),
                speed: baseStats.speed + (hat.stats.speed || 0),
                size: baseStats.size + (hat.stats.size || 0),
                venom: baseStats.venom + (hat.stats.venom || 0),
                toughness: baseStats.toughness + (hat.stats.toughness || 0),
                maxToughness: baseStats.maxToughness + (hat.stats.toughness || 0)
            };
        }

        document.addEventListener('DOMContentLoaded', function() {
            try {
                initializeDailyHats();
                renderDailyHats();
                renderHatInventory();
                updateHatCountdown();
                if (!window.__hatTimerStarted) {
                    window.__hatTimerStarted = true;
                    setInterval(updateHatCountdown, 1000);
                }
            } catch (e) { }
        });

        // MAIN GAME VARIABLES
        let MOVE_LIST = [
            { name: "Bite", stat: "strength", basePower: 3, effect: null },
            { name: "Venom Fang", stat: "strength", basePower: 6, effect: null },
            { name: "Reckless Charge", stat: "strength", basePower: 8, effect: { type: "recoil", percent: 0.25 } },
            { name: "Wild Tackle", stat: "strength", basePower: 7, effect: { type: "recoil", percent: 0.2 } },
            { name: "Quick Strike", stat: "speed", basePower: 3, effect: null },
            { name: "Agility", stat: "speed", basePower: 0, effect: { type: "boost", stat: "speed", amount: 15 } },
			{ name: "Assassination", stat: "speed", basePower: 5, effect: { type: "guaranteed_crit" } },
            { name: "Body Slam", stat: "size", basePower: 5, effect: null },
            { name: "Intimidate", stat: "size", basePower: 4, effect: { type: "accuracy_down", amount: 15, turns: 2 } },
            { name: "Poison Sting", stat: "venom", basePower: 3, effect: { type: "poison", chance: 0.5, damage: 8 } },
            { name: "Toxic Bite", stat: "venom", basePower: 4, effect: { type: "poison", chance: 0.8, damage: 12 } },
            { name: "Venom Drain", stat: "venom", basePower: 5, effect: { type: "drain", percent: 0.6 } },
            { name: "Web Barrage", stat: "speed", basePower: 3, effect: { type: "multihit", hits: 3 } },
            { name: "Fury Swipes", stat: "strength", basePower: 2, effect: { type: "multihit", hits: 4 } },
            { name: "Silk Trap", stat: "size", basePower: 2, effect: { type: "trap", damage: 10, turns: 2 } },
            { name: "Sticky Web", stat: "venom", basePower: 0, effect: { type: "slow", amount: 10, turns: 3 } },
            { name: "Web Shot", stat: "speed", basePower: 40, effect: { type: "slow", amount: 5, turns: 2 } }
        ];

        let config = { githubToken: '', gistId: '' };
        let spiders = [];
        let users = [];
        let shopPrices = { potion: 15, superPotion: 30, fullRestore: 50 };
        let currentUser = '';
        let currentFilter = 'all';
        let battleState = null;
        let selectedBattleSpider = null;
        let tradeOffers = [];
        let customFieldsCount = 0;
        let uploadedImageData = null;
        let bugReports = [];
        let activeBattles = [];
        let taglines = [
            "Spider League: Because Therapy Was Booked",
            "Eight Legs, Zero Thoughts",
            "Your Mom's Favorite",
            "Locally Sourced, Free-Range Spiders",
            "We Have Spiders at Home",
            "Spider League: It's Giving Arachnid",
            "No Thoughts, Just Spiders",
            "Spider League: Unhinged Since Tuesday",
            "POV You are a Spider",
            "Spiders But Make It Your Entire Personality"
        ];

        function getDailyTagline() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            const index = dayOfYear % taglines.length;
            return taglines[index];
        }
        
        function updateTagline() {
            const taglineElement = document.getElementById('tagline');
            if (taglineElement) {
                taglineElement.textContent = getDailyTagline();
            }
        }

        function calculateXpForLevel(level) {
            return Math.floor(100 * Math.pow(level, 1.5));
        }

        function changeStat(statName, delta) {
            const statInput = document.getElementById(statName);
            const currentValue = parseInt(statInput.value);
            const newValue = currentValue + delta;
            
            const pointsCount = document.getElementById('pointsCount');
            const currentPoints = parseInt(pointsCount.textContent);
            
            if (delta > 0 && currentPoints <= 0) return;
            if (delta < 0 && newValue < 0) return;
            if (newValue > 100) return;
            
            statInput.value = newValue;
            pointsCount.textContent = currentPoints - delta;
            
            const remaining = parseInt(pointsCount.textContent);
            const pointsDisplay = document.getElementById('pointsRemaining');
            if (remaining === 0) {
                pointsDisplay.style.borderColor = 'rgba(78, 205, 196, 0.6)';
                pointsDisplay.style.background = 'rgba(78, 205, 196, 0.2)';
            } else {
                pointsDisplay.style.borderColor = 'rgba(255, 165, 0, 0.6)';
                pointsDisplay.style.background = 'rgba(255, 165, 0, 0.2)';
            }
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                uploadedImageData = null;
                document.getElementById('imagePreview').style.display = 'none';
                return;
            }

            if (file.size > 2 * 1024 * 1024) {
                alert('Image too large! Please use an image under 2MB.');
                event.target.value = '';
                uploadedImageData = null;
                document.getElementById('imagePreview').style.display = 'none';
                return;
            }

            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file!');
                event.target.value = '';
                uploadedImageData = null;
                document.getElementById('imagePreview').style.display = 'none';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImageData = e.target.result;
                
                const preview = document.getElementById('imagePreview');
                const previewImg = document.getElementById('previewImg');
                previewImg.src = uploadedImageData;
                preview.style.display = 'block';

                document.getElementById('spiderImage').value = '';
            };
            reader.readAsDataURL(file);
        }
        
        function addCustomField() {
            customFieldsCount++;
            const container = document.getElementById('customFieldsContainer');
            const fieldId = `customField_${customFieldsCount}`;
            
            const fieldHTML = `
                <div id="${fieldId}" style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <label style="font-size: 0.9em;">Field Name:</label>
                            <input type="text" class="custom-field-name" placeholder="e.g., Cuteness, Mood" style="margin-top: 5px;">
                        </div>
                        <div style="flex: 1;">
                            <label style="font-size: 0.9em;">Value:</label>
                            <input type="text" class="custom-field-value" placeholder="Any value" style="margin-top: 5px;">
                        </div>
                    </div>
                    <button onclick="removeCustomField('${fieldId}')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 8px 16px; font-size: 0.9em;">Remove</button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', fieldHTML);
        }
        
        function removeCustomField(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) field.remove();
        }
        
        function getCustomFields() {
            const container = document.getElementById('customFieldsContainer');
            const fields = [];
            
            const fieldDivs = container.querySelectorAll('[id^="customField_"]');
            fieldDivs.forEach(div => {
                const name = div.querySelector('.custom-field-name').value.trim();
                const value = div.querySelector('.custom-field-value').value.trim();
                
                if (name && value) {
                    fields.push({ name, value });
                }
            });
            
            return fields;
        }
        
        function clearCustomFields() {
            document.getElementById('customFieldsContainer').innerHTML = '';
            customFieldsCount = 0;
        }

        function toggleConfig() {
            document.getElementById('configSection').classList.toggle('hidden');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'collection') {
                document.getElementById('collectionTab').classList.add('active');
            } else if (tab === 'add') {
                document.getElementById('addTab').classList.add('active');
            } else if (tab === 'battle') {
                document.getElementById('battleTab').classList.add('active');
                renderBattleSelect();
            } else if (tab === 'trade') {
                document.getElementById('tradeTab').classList.add('active');
                renderTradeTab();
                updateTradeTabIndicator();
            } else if (tab === 'hats') {
                document.getElementById('hatsTab').classList.add('active');
                try {
                    initializeDailyHats();
                    renderDailyHats();
                    renderHatInventory();
                } catch (e) { }
            } else if (tab === 'shop') {
                document.getElementById('shopTab').classList.add('active');
                updateShopPrices();
                renderInventory();
            } else if (tab === 'admin') {
                document.getElementById('adminTabContent').classList.add('active');
                checkAdminAccess();
            }
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderSpiders();
        }

        function showStatus(id, msg, type) {
            const el = document.getElementById(id);
            if (!el) return;
            el.textContent = msg;
            el.className = `status ${type}`;
            setTimeout(() => el.className = 'status hidden', 3000);
        }

        function showUserInfo() {
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');
            if (currentUser === 'admin') {
                document.getElementById('adminTab').classList.remove('hidden');
            }
            updateCoins();
            closeLoginModal();
        }

        function updateCoins() {
            const user = users.find(u => u.username === currentUser);
            const coins = user ? user.coins || 0 : 0;
            const coinsDisplay = document.getElementById('userCoins');
            
            if (currentUser) {
                coinsDisplay.textContent = `üí∞ ${coins} coins`;
                coinsDisplay.title = `Logged in as ${currentUser}`;
            } else {
                coinsDisplay.textContent = 'üí∞ Login';
                coinsDisplay.title = 'Click to login';
            }
        }

        function openLoginModal() {
            document.getElementById('loginModal').classList.add('active');
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.remove('active');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginStatus').innerHTML = '';
        }

        function closeLoginModalOnOverlay(event) {
            if (event.target.id === 'loginModal') {
                closeLoginModal();
            }
        }

        function getUserInventory() {
            const user = users.find(u => u.username === currentUser);
            if (!user) return {};
            if (!user.inventory) {
                user.inventory = {};
            }
            return user.inventory;
        }

        function setUserInventory(inventory) {
            const user = users.find(u => u.username === currentUser);
            if (user) {
                user.inventory = inventory;
            }
        }

        function generateMoves(spider) {
            const shuffled = [...MOVE_LIST].sort(() => Math.random() - 0.5);
            const moves = shuffled.slice(0, 4).map(move => ({
                ...move,
                power: move.basePower + Math.floor(spider.level * 3)
            }));
            return moves;
        }

        function loadConfig() {
            const saved = window.localStorage.getItem('spiderConfig');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('githubToken').value = config.githubToken || '';
                document.getElementById('gistId').value = config.gistId || '';
            }

            const savedUser = window.localStorage.getItem('spiderUser');
            if (savedUser) {
                currentUser = savedUser;
                showUserInfo();
            }

            loadData();
        }

        function saveConfig() {
            config.githubToken = document.getElementById('githubToken').value.trim();
            config.gistId = document.getElementById('gistId').value.trim();
            window.localStorage.setItem('spiderConfig', JSON.stringify(config));
            showStatus('configStatus', 'Configuration saved!', 'success');
            if (config.gistId) loadData();
        }

async function register() {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;

    if (!username || !password) {
        showStatus('loginStatus', 'Enter username and password!', 'error');
        return;
    }
    if (username.length < 3) {
        showStatus('loginStatus', 'Username must be 3+ characters', 'error');
        return;
    }
    if (password.length < 4) {
        showStatus('loginStatus', 'Password must be 4+ characters', 'error');
        return;
    }

    const confirmed = confirm(
        '‚ö†Ô∏è SECURITY WARNING ‚ö†Ô∏è\n\nYour password will be stored in a GitHub Gist.\nUse a simple, unique password only.'
    );
    if (!confirmed) return;

    // **FIX: Always fetch latest data before checking usernames**
    await loadData();

    // Now check if username exists with the fresh data
    if (users.some(u => u.username === username)) {
        showStatus('loginStatus', 'Username already taken!', 'error');
        return;
    }

    // Add the new user
    users.push({
        username,
        password,
        coins: 100,
        inventory: {},
        createdAt: new Date().toISOString()
    });

    // Save immediately
    const saveSuccess = await saveData();
    
    if (!saveSuccess) {
        showStatus('loginStatus', 'Registration failed. Please try again.', 'error');
        // Remove the user we just added since save failed
        users = users.filter(u => u.username !== username);
        return;
    }

    currentUser = username;
    window.localStorage.setItem('spiderUser', username);
    showUserInfo();
    showStatus('loginStatus', 'Registered! You start with 100 coins!', 'success');
}

        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showStatus('loginStatus', 'Enter username and password!', 'error');
                return;
            }

            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                currentUser = username;
                window.localStorage.setItem('spiderUser', username);
                showUserInfo();
                showStatus('loginStatus', 'Logged in successfully!', 'success');
                renderSpiders();
                renderHatInventory();
            } else {
                showStatus('loginStatus', 'Invalid username or password!', 'error');
            }
        }

        function logout() {
            if (!confirm('Logout?')) return;
            currentUser = '';
            window.localStorage.removeItem('spiderUser');
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('adminTab').classList.add('hidden');
            updateCoins();
            renderSpiders();
            renderHatInventory();
        }

        let saveTimeout = null;
        let pendingSave = false;

        async function loadData() {
            if (!config.githubToken || !config.gistId) return;

            try {
                const response = await fetch(`https://api.github.com/gists/${config.gistId}`, {
                    headers: {
                        'Authorization': `token ${config.githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) return;

                const data = await response.json();
                const content = JSON.parse(data.files['spider-league.json'].content);
                
                spiders = content.spiders || [];
                users = content.users || [];
                shopPrices = content.shopPrices || shopPrices;
                MOVE_LIST = content.moveList || MOVE_LIST;
                taglines = content.taglines || taglines;
                tradeOffers = content.tradeOffers || [];
                bugReports = content.bugReports || [];
                activeBattles = content.activeBattles || [];
                dailyHats = content.dailyHats || [];
                hatInventory = content.hatInventory || [];
                
                renderSpiders();
                updateCoins();
                updateShopPrices();
                renderInventory();
                updateTagline();
                updateTradeTabIndicator();
                renderDailyHats();
                renderHatInventory();
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        function debouncedSave() {
            pendingSave = true;
            
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            
            saveTimeout = setTimeout(async () => {
                await saveDataNow();
                pendingSave = false;
            }, 2000);
        }

       // --- helpers ---
function unionByKey(a = [], b = [], key = 'id') {
  const map = new Map();
  for (const item of a) map.set(item[key], item);
  for (const item of b) map.set(item[key], item);
  return Array.from(map.values());
}
function uniqueUsers(latestUsers = [], localUsers = []) {
  // Use username as stable key
  return unionByKey(latestUsers, localUsers, 'username');
}

// ---------- MERGE HELPERS (paste once) ----------
function unionByKey(a = [], b = [], key = 'id') {
  const map = new Map();
  for (const x of a || []) if (x && x[key] != null) map.set(x[key], x);
  for (const x of b || []) if (x && x[key] != null) map.set(x[key], x);
  return Array.from(map.values());
}

function unionByCompositeKey(a = [], b = [], keyFn) {
  const map = new Map();
  for (const x of a || []) map.set(keyFn(x), x);
  for (const x of b || []) map.set(keyFn(x), x);
  return Array.from(map.values());
}

function ensureId(prefix = 'id_') {
  return `${prefix}${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
}
		
// ---------- SAVE (replace your saveData / saveDataNow with this) ----------
let __saving = false;

async function saveData() {
  // prevent overlapping saves
  while (__saving) await new Promise(r => setTimeout(r, 50));
  __saving = true;

  try {
    // if no token, just keep local (useful for local dev)
    if (!config?.githubToken) {
      console.warn('No GitHub token; saved locally only.');
      // still cache config if gist got created later
      return true;
    }

    // First-time: create the gist
    if (!config.gistId) {
      const initial = {
        spiders, users, shopPrices, moveList: MOVE_LIST, taglines,
        tradeOffers, bugReports, activeBattles, dailyHats, hatInventory
      };

      const createResp = await fetch('https://api.github.com/gists', {
        method: 'POST',
        headers: {
          'Authorization': `token ${config.githubToken}`,
          'Accept': 'application/vnd.github.v3+json'
        },
        body: JSON.stringify({
          description: 'Spider League data',
          public: false,
          files: { 'spider-league.json': { content: JSON.stringify(initial, null, 2) } }
        })
      });

      if (!createResp.ok) {
        console.error('Failed to create Gist:', await createResp.text());
        return false;
      }

      const created = await createResp.json();
      config.gistId = created.id;
      localStorage.setItem('spiderConfig', JSON.stringify(config));
      return true;
    }

    // Pull latest to avoid clobbering other clients
    const resp = await fetch(`https://api.github.com/gists/${config.gistId}`, {
      headers: {
        'Authorization': `token ${config.githubToken}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });

    if (!resp.ok) {
      console.error('Failed to fetch latest Gist before save:', await resp.text());
      return false;
    }

    const gist = await resp.json();
    const latestRaw = gist.files?.['spider-league.json']?.content ?? '{}';
    let latest = {};
    try { latest = JSON.parse(latestRaw); } catch { latest = {}; }

    // Ensure local arrays exist
    spiders       = Array.isArray(spiders)       ? spiders       : [];
    users         = Array.isArray(users)         ? users         : [];
    tradeOffers   = Array.isArray(tradeOffers)   ? tradeOffers   : [];
    activeBattles = Array.isArray(activeBattles) ? activeBattles : [];
    dailyHats     = Array.isArray(dailyHats)     ? dailyHats     : [];
    hatInventory  = Array.isArray(hatInventory)  ? hatInventory  : [];
    bugReports    = Array.isArray(bugReports)    ? bugReports    : [];

    // ---- UNION MERGES (conflict-tolerant) ----
    const mergedSpiders = unionByKey(latest.spiders || [], spiders || [], 'id');
    const mergedUsers   = unionByKey(latest.users   || [], users   || [], 'username');

    const mergedTrades  = unionByKey(latest.tradeOffers || [], tradeOffers || [], 'id');

    const mergedBattles = unionByCompositeKey(
      latest.activeBattles || [],
      activeBattles || [],
      x => `${x.playerSpiderId}|${x.enemySpiderId}`
    );

    const mergedHatInv  = unionByKey(latest.hatInventory || [], hatInventory || [], 'id');
    const mergedDaily   = unionByKey(latest.dailyHats    || [], dailyHats    || [], 'id');
    const mergedBugs    = unionByKey(latest.bugReports   || [], bugReports   || [], 'id');

    const mergedMoveList = Array.isArray(MOVE_LIST) ? MOVE_LIST : (latest.moveList || []);
    const mergedShop     = { ...(latest.shopPrices || {}), ...(shopPrices || {}) };
    const mergedTags     = Array.isArray(taglines) ? taglines : (latest.taglines || []);

    const merged = {
      spiders:       mergedSpiders,
      users:         mergedUsers,
      tradeOffers:   mergedTrades,
      activeBattles: mergedBattles,
      dailyHats:     mergedDaily,
      hatInventory:  mergedHatInv,
      bugReports:    mergedBugs,
      moveList:      mergedMoveList,
      shopPrices:    mergedShop,
      taglines:      mergedTags
    };

    // Keep local memory consistent with what we write
    spiders       = merged.spiders;
    users         = merged.users;
    tradeOffers   = merged.tradeOffers;
    activeBattles = merged.activeBattles;
    dailyHats     = merged.dailyHats;
    hatInventory  = merged.hatInventory;
    bugReports    = merged.bugReports;
    MOVE_LIST     = merged.moveList;
    shopPrices    = merged.shopPrices;
    taglines      = merged.taglines;

    // Persist
    const patchResp = await fetch(`https://api.github.com/gists/${config.gistId}`, {
      method: 'PATCH',
      headers: {
        'Authorization': `token ${config.githubToken}`,
        'Accept': 'application/vnd.github.v3+json'
      },
      body: JSON.stringify({
        files: { 'spider-league.json': { content: JSON.stringify(merged, null, 2) } }
      })
    });

    if (!patchResp.ok) {
      console.error('Failed to patch Gist:', await patchResp.text());
      return false;
    }

    return true;
  } catch (e) {
    console.error('saveData error:', e);
    return false;
  } finally {
    __saving = false;
  }
}

// Some code calls saveDataNow(); keep a shim.
async function saveDataNow() { return saveData(); }

// ---------- ADD SPIDER (replace your addSpider) ----------
async function addSpider() {
  if (!currentUser) {
    showStatus('addStatus', 'Please log in first!', 'error');
    return;
  }

  const nameEl  = document.getElementById('spiderName');
  const latinEl = document.getElementById('spiderLatinName');
  const imgEl   = document.getElementById('spiderImage');

  const name  = (nameEl?.value || '').trim();
  const latin = (latinEl?.value || '').trim();
  const image = (uploadedImageData || imgEl?.value || '').trim();

  if (!name)  { showStatus('addStatus', 'Enter a spider name', 'error'); return; }
  if (!image) { showStatus('addStatus', 'Add an image or image URL', 'error'); return; }

  // Pull stat inputs (your UI uses readonly inputs with +/- controls)
  const strength   = parseInt(document.getElementById('strength').value, 10) || 1;
  const speed      = parseInt(document.getElementById('speed').value, 10) || 1;
  const size       = parseInt(document.getElementById('size').value, 10) || 1;
  const venom      = parseInt(document.getElementById('venom').value, 10) || 1;
  const toughInput = parseInt(document.getElementById('toughness').value, 10) || 1;

  // Max toughness starts equal to current toughness for new spiders
  const maxToughness = Math.max(1, toughInput);

  // Build the new spider (PENDING + not verified)
  const newSpider = {
    id: ensureId('spider_'),
    name,
    latinName: latin || null,
    image,
    owner: currentUser,

    // core stats
    level: 1,
    strength,
    speed,
    size,
    venom,

    // toughness model
    toughness: maxToughness,
    maxToughness,

    // flags for admin queue
    pending: true,
    verified: false,

    // records
    wins: 0,
    losses: 0,

    // moves (use your generator if present; otherwise ensureMoves will patch later)
    moves: typeof generateMoves === 'function'
      ? generateMoves({ level: 1 })
      : [],

    createdAt: new Date().toISOString()
  };

  // Optimistic add locally
  spiders.push(newSpider);

  // Save with conflict-proof merge
  const ok = await saveData();
  if (!ok) {
    showStatus('addStatus', 'Could not save spider. Try again.', 'error');
    // Optionally roll back local push if desired
    return;
  }

  showStatus('addStatus', 'Spider submitted! Waiting for admin approval.', 'success');

  // Clear the form
  if (nameEl)  nameEl.value = '';
  if (latinEl) latinEl.value = '';
  if (imgEl)   imgEl.value = '';
  uploadedImageData = null;
  clearCustomFields?.();

  // Reset point allocator UI if you use it
  const pointsCountEl = document.getElementById('pointsCount');
  if (pointsCountEl) pointsCountEl.textContent = '95';
  ['strength','speed','size','venom','toughness'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.value = 1;
  });

  // Refresh UI
  if (typeof renderSpiders === 'function') renderSpiders();

  // If currently on Admin tab, refresh the queue
  const adminTabVisible = document.getElementById('adminTabContent')?.classList.contains('active');
  if (adminTabVisible && typeof renderAdminPanel === 'function') {
    renderAdminPanel();
  }
}

        async function deleteSpider(id) {
            if (!confirm('Delete this spider?')) return;
            
            const spider = spiders.find(s => s.id === id);
            if (!spider) return;
            
            if (spider.owner !== currentUser && currentUser !== 'admin') {
                alert('You can only delete your own spiders!');
                return;
            }

            spiders = spiders.filter(s => s.id !== id);
            
            renderSpiders();
            
            debouncedSave();
        }

        function renderSpiders() {
            const grid = document.getElementById('spiderGrid');
            
            let filtered = spiders.filter(s => s.verified);
            if (currentFilter === 'mine') {
                filtered = filtered.filter(s => s.owner === currentUser);
            }

            const pendingSpiders = spiders.filter(s => s.pending && !s.verified && s.owner === currentUser);

            if (filtered.length === 0 && pendingSpiders.length === 0) {
                grid.innerHTML = '<p style="color: #666;">No spiders to display.</p>';
                return;
            }

            let html = '';

            if (pendingSpiders.length > 0) {
                html += pendingSpiders.map(spider => `
                    <div class="spider-card" style="border: 2px solid rgba(255, 165, 0, 0.8);">
                        <div style="background: rgba(255, 165, 0, 0.9); padding: 5px 10px; border-radius: 15px; display: inline-block; margin-bottom: 10px; font-size: 12px;">‚è≥ Pending Approval</div>
                        <img src="${spider.image}" class="spider-image" alt="${spider.name}">
                        <div class="spider-name">${spider.name}</div>
                        ${spider.latinName ? `<div style="font-style: italic; color: #aaa; font-size: 0.9em; margin-bottom: 8px;">${spider.latinName}</div>` : ''}
                        <div class="stat"><span>Strength:</span><span>${spider.strength}</span></div>
                        <div class="stat"><span>Speed:</span><span>${spider.speed}</span></div>
                        <div class="stat"><span>Size:</span><span>${spider.size}</span></div>
                        <div class="stat"><span>Venom:</span><span>${spider.venom}</span></div>
                        <div class="stat"><span>Toughness:</span><span>${spider.toughness}</span></div>
                        ${spider.customFields && spider.customFields.length > 0 ? spider.customFields.map(field => `
                            <div class="stat"><span>${field.name}:</span><span>${field.value}</span></div>
                        `).join('') : ''}
                    </div>
                `).join('');
            }

            html += filtered.map(spider => {
                const ownerHistory = spider.ownerHistory || [spider.owner];
                const historyText = ownerHistory.length > 1 ? 
                    `Previous owners: ${ownerHistory.slice(0, -1).join(' ‚Üí ')}` : '';

                const moveNames = spider.moves ? spider.moves.map(m => m.name).join(', ') : 'Moves will be assigned';
                
                const isDead = (spider.toughness !== undefined && spider.toughness <= 0);
                
                const currentXp = spider.xp || 0;
                const xpNeeded = calculateXpForLevel(spider.level);
                const xpPercent = (currentXp / xpNeeded) * 100;

                return `
                    <div class="spider-card" style="${isDead ? 'opacity: 0.6; border: 2px solid rgba(255, 87, 108, 0.5);' : ''}">
                        ${isDead ? '<div style="background: rgba(255, 87, 108, 0.9); padding: 5px 10px; border-radius: 15px; display: inline-block; margin-bottom: 10px; font-size: 12px;">üíÄ FAINTED</div>' : ''}
                        <img src="${spider.image}" class="spider-image" alt="${spider.name}" style="${isDead ? 'filter: grayscale(100%);' : ''}">
                        <div class="spider-name">${spider.name}</div>
                        ${spider.latinName ? `<div style="font-style: italic; color: #aaa; font-size: 0.9em; margin-bottom: 8px;">${spider.latinName}</div>` : ''}
                        <div class="stat"><span>Level:</span><span>${spider.level}</span></div>
                        <div style="margin: 8px 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                <span style="font-size: 0.85em; color: #aaa;">XP to Next Level:</span>
                                <span style="font-size: 0.85em; color: #4ecdc4;">${currentXp} / ${xpNeeded}</span>
                            </div>
                            <div style="width: 100%; height: 8px; background: rgba(0, 0, 0, 0.5); border-radius: 10px; overflow: hidden;">
                                <div style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: ${xpPercent}%; transition: width 0.5s;"></div>
                            </div>
                        </div>
                        <div class="stat ${isDead ? 'style="background: rgba(255, 87, 108, 0.2);"' : ''}"><span>Toughness:</span><span>${Math.max(0, spider.toughness || 0)}/${spider.maxToughness}</span></div>
                        <div class="stat"><span>Strength:</span><span>${spider.strength}</span></div>
                        <div class="stat"><span>Speed:</span><span>${spider.speed}</span></div>
                        <div class="stat"><span>Size:</span><span>${spider.size}</span></div>
                        <div class="stat"><span>Venom:</span><span>${spider.venom}</span></div>
                        ${spider.customFields && spider.customFields.length > 0 ? spider.customFields.map(field => `
                            <div class="stat" style="opacity: 0.6;"><span>${field.name}:</span><span>${field.value}</span></div>
                        `).join('') : ''}
                        <div class="stat"><span>Record:</span><span>${spider.wins || 0}W - ${spider.losses || 0}L</span></div>
                        <div class="stat"><span>Owner:</span><span>${spider.owner}</span></div>
                        ${historyText ? `<div class="owner-history">${historyText}</div>` : ''}
                        <div class="move-list">Moves: ${moveNames}</div>
                        ${(spider.owner === currentUser && isDead) ? `
                            <div style="background: rgba(255, 165, 0, 0.2); padding: 10px; border-radius: 8px; margin-top: 10px;">
                                <p style="color: #ffa500; font-size: 0.9em; margin-bottom: 8px;">üíä Revive Spider:</p>
                                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    <button onclick="useItemOnSpider('${spider.id'}, 'potion', 20)" style="flex: 1; padding: 8px; font-size: 0.85em;">Potion (+20)</button>
                                    <button onclick="useItemOnSpider('${spider.id'}, 'superPotion', 50)" style="flex: 1; padding: 8px; font-size: 0.85em;">Super (+50)</button>
                                    <button onclick="useItemOnSpider('${spider.id'}, 'fullRestore', 999)" style="flex: 1; padding: 8px; font-size: 0.85em;">Full Restore</button>
                                </div>
                            </div>
                        ` : ''}
                        ${spider.owner === currentUser || currentUser === 'admin' ? `<button onclick="deleteSpider('${spider.id}')">Delete</button>" style="width: 100%; margin-top: 10px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">Delete</button>` : ''}
                    </div>
                `;
            }).join('');

            grid.innerHTML = html;
        }

        function updateTradeTabIndicator() {
            // Placeholder
        }

        function renderTradeTab() {
            document.getElementById('incomingTrades').innerHTML = '<p style="color: #666;">Trade system placeholder</p>';
            document.getElementById('outgoingTrades').innerHTML = '<p style="color: #666;">Trade system placeholder</p>';
            document.getElementById('tradeMySpiders').innerHTML = '<p style="color: #666;">Trade system placeholder</p>';
        }

        function updateShopPrices() {
            document.getElementById('pricePotion').textContent = shopPrices.potion;
            document.getElementById('priceSuperPotion').textContent = shopPrices.superPotion;
            document.getElementById('priceFullRestore').textContent = shopPrices.fullRestore;
        }

        function renderInventory() {
            const inventory = getUserInventory();
            const display = document.getElementById('inventoryDisplay');
            
            const items = [
                { key: 'potion', name: 'Potion' },
                { key: 'superPotion', name: 'Super Potion' },
                { key: 'fullRestore', name: 'Full Restore' }
            ];

            const html = items.map(item => {
                const count = inventory[item.key] || 0;
                return `
                    <div class="inventory-item">
                        <span>${item.name}</span>
                        <span>x${count}</span>
                    </div>
                `;
            }).join('');

            display.innerHTML = html || '<p style="color: #666;">No items yet</p>';
        }

        let isProcessingPurchase = false;

async function buyShopItem(itemKey) {
    if (isProcessingPurchase) {
        showStatus('shopStatus', 'Please wait, processing...', 'error');
        return;
    }

    if (!currentUser) {
        showStatus('shopStatus', 'Please login first!', 'error');
        return;
    }

    // **FIX: Load fresh data first**
    await loadData();

    const user = users.find(u => u.username === currentUser);
    if (!user) {
        showStatus('shopStatus', 'User not found! Please login again.', 'error');
        return;
    }

    const price = shopPrices[itemKey];
    if (!price) {
        showStatus('shopStatus', 'Invalid item!', 'error');
        return;
    }

    const currentCoins = user.coins || 0;
    if (currentCoins < price) {
        showStatus('shopStatus', `Not enough coins! You have ${currentCoins}, need ${price} coins.`, 'error');
        return;
    }

    isProcessingPurchase = true;

    try {
        user.coins = currentCoins - price;
        
        if (!user.inventory) {
            user.inventory = {};
        }
        
        user.inventory[itemKey] = (user.inventory[itemKey] || 0) + 1;

        const saveSuccess = await saveData();
        
        if (saveSuccess) {
            showStatus('shopStatus', `Successfully purchased ${itemKey}!`, 'success');
            updateCoins();
            renderInventory();
        } else {
            // Rollback not needed since saveData() already merged
            await loadData(); // Just reload to get correct state
            showStatus('shopStatus', 'Purchase failed - please try again', 'error');
        }
    } catch (error) {
        console.error('Purchase error:', error);
        await loadData(); // Reload to get correct state
        showStatus('shopStatus', 'Purchase failed - please try again', 'error');
    } finally {
        setTimeout(() => {
            isProcessingPurchase = false;
        }, 500);
    }
}

async function useItemOnSpider(spiderId, itemKey, healAmount) {
    if (!currentUser) {
        alert('Please login first!');
        return;
    }

    // **FIX: Load fresh data first**
    await loadData();

    const spider = spiders.find(s => s.id === spiderId);
    if (!spider || spider.owner !== currentUser) {
        alert('You can only use items on your own spiders!');
        return;
    }

    const inventory = getUserInventory();
    if (!inventory[itemKey] || inventory[itemKey] <= 0) {
        alert(`You don't have any ${itemKey}! Buy some from the shop.`);
        return;
    }

    inventory[itemKey]--;
    setUserInventory(inventory);

    const actualHeal = Math.min(healAmount, spider.maxToughness - spider.toughness);
    spider.toughness = Math.min(spider.toughness + healAmount, spider.maxToughness);

    if (await saveData()) {
        alert(`Used ${itemKey}! ${spider.name} restored ${actualHeal} Toughness and is now at ${spider.toughness}/${spider.maxToughness} Toughness!`);
        renderSpiders();
        renderInventory();
    }
}

        function checkAdminAccess() {
            if (currentUser === 'admin') {
                document.getElementById('adminAccessDenied').classList.add('hidden');
                document.getElementById('adminContent').classList.remove('hidden');
                renderAdminPanel();
            } else {
                document.getElementById('adminAccessDenied').classList.remove('hidden');
                document.getElementById('adminContent').classList.add('hidden');
            }
        }

        function renderAdminPanel() {
            if (currentUser !== 'admin') return;

            if (config.gistId) {
                const gistUrl = `https://gist.github.com/${config.gistId}`;
                const adminGistLink = document.getElementById('adminGistLink');
                if (adminGistLink) {
                    adminGistLink.href = gistUrl;
                }
            }

            const pendingSpiders = spiders.filter(s => s.pending && !s.verified);
            const queueDiv = document.getElementById('verificationQueue');

            if (pendingSpiders.length === 0) {
                queueDiv.innerHTML = '<p style="color: #666;">No pending spiders</p>';
            } else {
                queueDiv.innerHTML = pendingSpiders.map(spider => `
                    <div style="background: rgba(255, 165, 0, 0.1); border: 2px solid rgba(255, 165, 0, 0.5); padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                        <img src="${spider.image}" style="max-width: 300px; max-height: 300px; border-radius: 10px; margin-bottom: 15px;" alt="${spider.name}">
                        <h3>${spider.name}</h3>
                        ${spider.latinName ? `<p style="font-style: italic; color: #aaa;">${spider.latinName}</p>` : ''}
                        <p style="color: #aaa;">By: ${spider.owner}</p>
                        <div class="stat"><span>Strength:</span><span>${spider.strength}</span></div>
                        <div class="stat"><span>Speed:</span><span>${spider.speed}</span></div>
                        <div class="stat"><span>Size:</span><span>${spider.size}</span></div>
                        <div class="stat"><span>Venom:</span><span>${spider.venom}</span></div>
                        <div class="stat"><span>Toughness:</span><span>${spider.toughness}</span></div>
                        ${spider.customFields && spider.customFields.length > 0 ? spider.customFields.map(field => `
                            <div class="stat"><span>${field.name}:</span><span>${field.value}</span></div>
                        `).join('') : ''}
                        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 15px;">
                        	<button onclick="verifySpider('${spider.id}', true)" style="background: linear-gradient(135deg, #4ecdc4 0%, #44a6a0 100%); padding: 12px 40px;">‚úì Approve</button>
							<button onclick="verifySpider('${spider.id}', false)" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 12px 40px;">‚úï Deny</button>
                        </div>
                    </div>
                `).join('');
            }

            document.getElementById('adminMoves').value = JSON.stringify(MOVE_LIST, null, 2);
            document.getElementById('adminPricePotion').value = shopPrices.potion;
            document.getElementById('adminPriceSuperPotion').value = shopPrices.superPotion;
            document.getElementById('adminPriceFullRestore').value = shopPrices.fullRestore;
            document.getElementById('adminTaglines').value = taglines.join('\n');

            const usersList = document.getElementById('usersList');
            usersList.innerHTML = users.map(user => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: rgba(255, 255, 255, 0.05); border-radius: 5px;">
                    <div>
                        <strong>${user.username}</strong>
                        <div style="color: #aaa; font-size: 0.9em;">
                            Coins: ${user.coins || 0} | 
                            Spiders: ${spiders.filter(s => s.owner === user.username && s.verified).length}
                        </div>
                    </div>
                    ${user.username !== 'admin' ? `<button onclick="deleteUser('${user.username}')" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">Delete</button>` : ''}
                </div>
            `).join('');
        }

async function verifySpider(spiderId, approved) {
  if (currentUser !== 'admin') {
    alert('Admin only.');
    return;
  }

  const idx = spiders.findIndex(s => s.id === spiderId);
  if (idx === -1) return;
  const spider = spiders[idx];

  if (approved) {
    spider.verified = true;
    spider.pending = false;

    try {
      if (!spider.moves || !Array.isArray(spider.moves) || spider.moves.length === 0) {
        if (typeof generateMoves === 'function') {
          spider.moves = generateMoves(spider);
        } else if (Array.isArray(MOVE_LIST) && MOVE_LIST.length) {
          spider.moves = MOVE_LIST.slice(0, 4).map(m => ({
            name: m.name, stat: m.stat, basePower: m.basePower, effect: m.effect || null
          }));
        } else {
          spider.moves = [];
        }
      }
    } catch (e) {
      console.error('generateMoves failed:', e);
      spider.moves = spider.moves || [];
    }

    const owner = users.find(u => u.username === spider.owner);
    if (owner) owner.coins = (owner.coins || 0) + 50;

    showStatus('adminStatus', `Spider approved! ${spider.owner} earned 50 coins.`, 'success');
  } else {
    spiders = spiders.filter(s => s.id !== spiderId);
    showStatus('adminStatus', 'Spider denied and removed.', 'error');
  }

  await saveData();
  if (typeof renderAdminPanel === 'function') renderAdminPanel();
  if (typeof renderSpiders === 'function') renderSpiders();
}
        async function saveMoveList() {
            try {
                MOVE_LIST = JSON.parse(document.getElementById('adminMoves').value);
                if (await saveData()) {
                    showStatus('adminStatus', 'Move list updated!', 'success');
                }
            } catch (e) {
                showStatus('adminStatus', 'Invalid JSON format!', 'error');
            }
        }

        async function saveShopPrices() {
            shopPrices.potion = parseInt(document.getElementById('adminPricePotion').value);
            shopPrices.superPotion = parseInt(document.getElementById('adminPriceSuperPotion').value);
            shopPrices.fullRestore = parseInt(document.getElementById('adminPriceFullRestore').value);

            if (await saveData()) {
                showStatus('adminStatus', 'Shop prices updated!', 'success');
                updateShopPrices();
            }
        }
        
        async function saveTaglines() {
            const taglinesText = document.getElementById('adminTaglines').value;
            const lines = taglinesText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            
            if (lines.length === 0) {
                showStatus('adminStatus', 'Please enter at least one tagline!', 'error');
                return;
            }
            
            taglines = lines;
            
            if (await saveData()) {
                showStatus('adminStatus', `Taglines updated! (${taglines.length} total)`, 'success');
                updateTagline();
            }
        }

        async function deleteUser(username) {
            if (!confirm(`Delete user ${username}?`)) return;
            users = users.filter(u => u.username !== username);
            spiders = spiders.filter(s => s.owner !== username);
            
            renderAdminPanel();
            
            debouncedSave();
        }

        function openBugReport() {
            document.getElementById('bugReportModal').classList.add('active');
            if (currentUser) {
                document.getElementById('bugReporterName').value = currentUser;
            }
        }

        function closeBugReport() {
            document.getElementById('bugReportModal').classList.remove('active');
            document.getElementById('bugDescription').value = '';
            document.getElementById('bugSteps').value = '';
            document.getElementById('bugReporterName').value = '';
            document.getElementById('bugReportStatus').innerHTML = '';
        }

        function closeBugReportOnOverlay(event) {
            if (event.target.id === 'bugReportModal') {
                closeBugReport();
            }
        }

        async function submitBugReport() {
            const description = document.getElementById('bugDescription').value.trim();
            const steps = document.getElementById('bugSteps').value.trim();
            const reporterName = document.getElementById('bugReporterName').value.trim() || 'Anonymous';

            if (!description) {
                showStatus('bugReportStatus', 'Please describe the bug!', 'error');
                return;
            }

            const report = {
                id: `bug_${Date.now()}`,
                description: description,
                steps: steps,
                reportedBy: reporterName,
                timestamp: new Date().toISOString(),
                status: 'open'
            };

            bugReports.push(report);

            if (await saveData()) {
                showStatus('bugReportStatus', 'Bug report submitted! Thank you!', 'success');
                setTimeout(() => {
                    closeBugReport();
                }, 2000);
            } else {
                showStatus('bugReportStatus', 'Failed to submit. Please try again.', 'error');
            }
        }

        loadConfig();
        updateTagline();
        
        window.addEventListener('beforeunload', () => {
            if (pendingSave) {
                saveDataNow();
            }
        });
    </script>
<script>
// ===== BATTLE SYSTEM (toughness + effects + XP + WAGERS) =====

// Globals expected to already exist elsewhere in your app:
// spiders, users, currentUser, activeBattles (Array), MOVE_LIST (Array of moves),
// saveData() or saveDataNow(), updateCoins(), getSpiderWithHatStats(spider)
// DOM ids: battleSelectSpiders, battleOpponents, battleSelectPhase, battleOpponentPhase, battleArenaPhase, battleTabBtn

// ---------- persistence helper ----------
const _save = typeof saveData === 'function' ? saveData
            : (typeof saveDataNow === 'function' ? saveDataNow : async () => true);

// ---------- misc helpers ----------
function isSpiderInBattle(spiderId) {
  return activeBattles.some(b => b.playerSpiderId === spiderId || b.enemySpiderId === spiderId);
}
function ensureMoves(spider) {
  if (spider.moves && spider.moves.length) return spider.moves;
  const picks = (MOVE_LIST || []).slice(0, 4).map(m => ({
    name: m.name, stat: m.stat, basePower: m.basePower, effect: m.effect || null
  }));
  spider.moves = picks;
  return spider.moves;
}
function getUserByName(name) {
  return users.find(u => u.username === name);
}
function derivedPower(s) {
  const stats = getSpiderWithHatStats ? getSpiderWithHatStats(s) : s;
  return Math.round((stats.strength + stats.speed + stats.size + stats.venom) / 4);
}

// ---------- UI: select your spider ----------
function renderBattleSelect() {
  const grid = document.getElementById('battleSelectSpiders');

  if (!currentUser) {
    grid.innerHTML = '<p style="color:#666;">Please log in to pick a spider for battle.</p>';
    return;
  }

  const mySpiders = spiders.filter(s => s.owner === currentUser && s.verified && s.toughness > 0);

  if (mySpiders.length === 0) {
    grid.innerHTML = '<p style="color:#666;">You have no healthy, verified spiders. Create one, ask an admin to approve yours, or revive a fainted one.</p>';
    return;
  }

  grid.innerHTML = mySpiders.map(spider => {
    const inBattle = isSpiderInBattle(spider.id);
    const stats = getSpiderWithHatStats ? getSpiderWithHatStats(spider) : spider;
    return `
      <div class="spider-card"
           style="cursor:${inBattle?'not-allowed':'pointer'};opacity:${inBattle?0.5:1};"
           ${inBattle ? '' : `onclick="selectBattleSpider('${spider.id}')"`}>
        ${inBattle ? '<div style="background: rgba(255,255,255,0.15); padding:6px 10px; border-radius:10px; margin-bottom:10px; font-size:12px;">‚öîÔ∏è In Battle</div>' : ''}
        <img src="${spider.image}" class="spider-image" alt="${spider.name}">
        <div class="spider-name">${spider.name}</div>
        ${spider.latinName ? `<div style="font-style:italic;color:#aaa;font-size:0.9em;margin-bottom:8px;">${spider.latinName}</div>` : ''}
        <div class="stat"><span>Level:</span><span>${spider.level}</span></div>
        <div class="hp-bar">
          <div class="hp-fill ${(stats.toughness / stats.maxToughness)<0.3 ? 'low':''}"
               style="width:${(stats.toughness / stats.maxToughness) * 100}%">
            Toughness: ${stats.toughness}/${stats.maxToughness}
          </div>
        </div>
        <div class="stat"><span>Power:</span><span>${derivedPower(spider)}</span></div>
        ${inBattle ? '<button disabled>Spider is Busy</button>' : '<button>Select for Battle</button>'}
      </div>
    `;
  }).join('');
}

function selectBattleSpider(spiderId) {
  const spider = spiders.find(s => s.id === spiderId);
  if (!spider) return;
  if (isSpiderInBattle(spiderId)) {
    alert('This spider is already in a battle!');
    return;
  }
  window.selectedBattleSpider = spider;
  ensureMoves(selectedBattleSpider);

  document.getElementById('battleSelectPhase').classList.add('hidden');
  document.getElementById('battleOpponentPhase').classList.remove('hidden');
  renderOpponents();
}

// ---------- Wager UI helper ----------
function ensureWagerUI() {
  const phase = document.getElementById('battleOpponentPhase');
  if (!phase) return;
  if (!document.getElementById('wagerBox')) {
    const box = document.createElement('div');
    box.id = 'wagerBox';
    box.style.margin = '0 0 12px 0';
    box.style.display = 'grid';
    box.style.gridTemplateColumns = '1fr auto';
    box.style.gap = '10px';
    box.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.08);padding:10px;border-radius:10px;">
        <label for="battleWager" style="color:#aaa;">Wager (coins):</label>
        <input id="battleWager" type="number" min="0" step="1" value="${Number(localStorage.getItem('lastWager')||0)}"
               style="max-width:140px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.1);border:none;color:#fff;">
        <span id="wagerMyCoins" style="color:#ffd700;font-weight:bold;margin-left:auto;">üí∞ ${getUserByName(currentUser)?.coins || 0}</span>
      </div>
      <div style="display:flex;align-items:center;justify-content:flex-end;">
        <small style="color:#aaa;">Both players must have at least this amount.</small>
      </div>
    `;
    const opponentsGrid = document.getElementById('battleOpponents');
    phase.insertBefore(box, opponentsGrid);
  } else {
    // refresh coins display
    const span = document.getElementById('wagerMyCoins');
    if (span) span.textContent = `üí∞ ${getUserByName(currentUser)?.coins || 0}`;
  }
}

// ---------- UI: pick opponent (with wager box) ----------
function renderOpponents() {
  ensureWagerUI();

  const grid = document.getElementById('battleOpponents');
  const opponents = spiders.filter(s => s.verified && s.owner !== currentUser && s.toughness > 0);

  if (opponents.length === 0) {
    grid.innerHTML = '<p style="color:#666;">No opponents available!</p>';
    return;
  }

  grid.innerHTML = opponents.map(spider => {
    const stats = getSpiderWithHatStats ? getSpiderWithHatStats(spider) : spider;
    const enemyCoins = getUserByName(spider.owner)?.coins ?? 0;
    return `
      <div class="spider-card">
        <img src="${spider.image}" class="spider-image" alt="${spider.name}">
        <div class="spider-name">${spider.name}</div>
        <div class="stat"><span>Owner:</span><span>@${spider.owner} ‚Ä¢ üí∞ ${enemyCoins}</span></div>
        <div class="stat"><span>Level:</span><span>${spider.level}</span></div>
        <div class="hp-bar">
          <div class="hp-fill ${(stats.toughness / stats.maxToughness)<0.3 ? 'low':''}"
               style="width:${(stats.toughness / stats.maxToughness) * 100}%">
            Toughness: ${stats.toughness}/${stats.maxToughness}
          </div>
        </div>
        <div class="stat"><span>Power:</span><span>${derivedPower(spider)}</span></div>
        <button onclick="startBattle('${selectedBattleSpider.id}', '${spider.id}', Number(document.getElementById('battleWager').value||0))">Challenge!</button>
      </div>
    `;
  }).join('');
}
// ---------- status effects engine ----------
/*
  Effects stored as { type, turns, magnitude?, meta? }:
  - poison: start of owner's turn, lose floor(maxToughness * magnitude) (default 0.05)
  - burn:   start of owner's turn, lose floor(maxToughness * magnitude) (default 0.04), outgoing √ó0.8
  - bleed:  start of owner's turn, lose floor(lastDamageTaken * magnitude) (default 0.25)
  - slow:   outgoing √ó0.8 (no DoT)
  - stun:   skip the entire turn once (consumes 1 turn immediately when applied at start)
  - charge: next attack √ó1.5 (consumed on hit)
*/
const EFFECT_DEFAULTS = {
  poison: { magnitude: 0.05 },
  burn:   { magnitude: 0.04 },
  bleed:  { magnitude: 0.25 },
  slow:   { magnitude: 0.20 },
  charge: { magnitude: 0.50 }
};
function addEffect(side, eff) {
  const list = battleState.effects[side];
  const copy = { ...eff };
  if (copy.magnitude == null && EFFECT_DEFAULTS[copy.type]?.magnitude != null) {
    copy.magnitude = EFFECT_DEFAULTS[copy.type].magnitude;
  }
  list.push(copy);
}
function purgeExpired(side) {
  battleState.effects[side] = battleState.effects[side].filter(e => e.turns > 0);
}
function applyStartOfTurn(side) {
  const actor = battleState[side];
  const spider = actor.spider;
  const effects = battleState.effects[side];

  // stun
  const stun = effects.find(e => e.type === 'stun');
  if (stun) {
    stun.turns -= 1;
    battleState.log.push(`${spider.name} is stunned and cannot move!`);
    purgeExpired(side);
    return { stunned: true };
  }

  // DoT ticks
  let totalDot = 0;
  for (const e of effects) {
    if (e.type === 'poison' || e.type === 'burn') {
      const dot = Math.max(1, Math.floor(spider.maxToughness * e.magnitude));
      actor.currentToughness = Math.max(0, actor.currentToughness - dot);
      totalDot += dot;
    } else if (e.type === 'bleed' && e.meta?.lastDamageTaken) {
      const dot = Math.max(1, Math.floor(e.meta.lastDamageTaken * e.magnitude));
      actor.currentToughness = Math.max(0, actor.currentToughness - dot);
      totalDot += dot;
    }
  }
  if (totalDot > 0) battleState.log.push(`${spider.name} suffers ${totalDot} damage from effects.`);

  // decrement durations (stun already decremented)
  for (const e of effects) { if (e.type !== 'stun') e.turns -= 1; }
  purgeExpired(side);

  return { stunned: false };
}
function outgoingDamageMultiplier(side) {
  const effects = battleState.effects[side];
  let mult = 1;
  if (effects.some(e => e.type === 'burn')) mult *= 0.8;
  if (effects.some(e => e.type === 'slow')) mult *= 0.8;
  return mult;
}
function consumeCharge(side) {
  const idx = battleState.effects[side].findIndex(e => e.type === 'charge');
  if (idx >= 0) {
    battleState.effects[side].splice(idx, 1);
    return 1 + EFFECT_DEFAULTS.charge.magnitude; // 1.5
  }
  return 1;
}
function maybeInflictEffect(targetSide, targetSpider, move, lastDamage) {
  if (!move.effect || !move.effect.type) return;

  // support legacy effect structures
  const effBlock = move.effect;
  const type = effBlock.type;
  if (!type) return;

  // chance: prefer .chance, else default to 1; legacy damage/magnitude mapping
  const chance = effBlock.chance != null ? effBlock.chance : 1;
  if (Math.random() > chance) return;

  // normalize common legacy shapes
  let magnitude = effBlock.magnitude;
  if (magnitude == null) {
    if (type === 'poison' || type === 'burn') {
      // legacy used fixed damage; convert approx. to fraction of max
      if (effBlock.damage != null) magnitude = Math.max(0.01, effBlock.damage / 100);
      else magnitude = EFFECT_DEFAULTS[type].magnitude;
    }
  }
  const turns = effBlock.turns != null ? effBlock.turns : 2;

  const eff = { type, turns, magnitude };
  if (type === 'bleed') eff.meta = { lastDamageTaken: lastDamage };
  addEffect(targetSide, eff);

  battleState.log.push(`${targetSpider.name} is ${effectLabel(type)}!`);
}
function effectLabel(type) {
  return ({
    poison: 'poisoned',
    burn: 'burned',
    bleed: 'bleeding',
    slow: 'slowed',
    stun: 'stunned',
    charge: 'charging'
  })[type] || type;
}

// ---------- XP / Leveling ----------
function grantBattleXP(winner, loser) {
  const pwrW = derivedPower(winner), pwrL = derivedPower(loser);
  const levelDelta = Math.max(0, loser.level - winner.level);
  const base = 15 + Math.round((pwrL / Math.max(1, pwrW)) * 10) + levelDelta * 5;
  const xpGain = Math.max(10, Math.min(120, base));
  winner.xp = (winner.xp || 0) + xpGain;

  let leveled = false;
  while ((winner.xp || 0) >= xpNeededForLevel(winner.level)) {
    winner.xp -= xpNeededForLevel(winner.level);
    levelUp(winner);
    leveled = true;
  }
  return { xpGain, leveled };
}
function xpNeededForLevel(level) { return 50 * level; }
function levelUp(spider) {
  spider.level = (spider.level || 1) + 1;
  const inc = () => 1 + Math.floor(Math.random() * 2); // +1..+2
  spider.strength += inc();
  spider.speed += inc();
  spider.size += 1;
  spider.venom += inc();
  const bonusT = 5 + Math.floor(Math.random() * 4); // +5..+8
  spider.maxToughness += bonusT;
  spider.toughness = spider.maxToughness;
}

// ---------- start battle (validates wager) ----------
async function startBattle(playerId, enemyId, wager = 0) {
  // Validate IDs exist and are strings
  if (!playerId || !enemyId || typeof playerId !== 'string' || typeof enemyId !== 'string') {
    alert('Invalid spider selection! Please try again.');
    console.error('Invalid spider IDs:', { playerId, enemyId });
    return;
  }

  // Prevent battling yourself
  if (playerId === enemyId) {
    alert('You cannot battle your own spider!');
    return;
  }

  // Load fresh data to ensure we have latest spider/user info
  await loadData();

  // Find the spiders
  const playerSpider = spiders.find(s => s.id === playerId);
  const enemySpider  = spiders.find(s => s.id === enemyId);
  
  if (!playerSpider) {
    alert('Could not find your spider! It may have been deleted.');
    return;
  }
  
  if (!enemySpider) {
    alert('Could not find opponent spider! It may have been deleted.');
    return;
  }

  // Verify ownership
  if (playerSpider.owner !== currentUser) {
    alert('You can only battle with your own spiders!');
    return;
  }

  // Check if spiders are healthy
  if (playerSpider.toughness <= 0) {
    alert('Your spider has fainted! Revive it before battling.');
    return;
  }

  if (enemySpider.toughness <= 0) {
    alert('That spider has fainted and cannot battle!');
    return;
  }

  // Check if spiders are verified
  if (!playerSpider.verified) {
    alert('Your spider must be verified by an admin before battling!');
    return;
  }

  if (!enemySpider.verified) {
    alert('That spider is not yet verified and cannot battle!');
    return;
  }

  // Check if either spider is already in battle
  if (isSpiderInBattle(playerId)) {
    alert('Your spider is already in a battle!');
    return;
  }

  if (isSpiderInBattle(enemyId)) {
    alert('That spider is already in a battle!');
    return;
  }

  // Sanitize and validate wager
  wager = Math.max(0, Math.floor(Number(wager) || 0));
  
  if (isNaN(wager) || wager < 0) {
    wager = 0;
  }

  // Store wager preference
  localStorage.setItem('lastWager', String(wager));

  // Validate coins for both players if there's a wager
  if (wager > 0) {
    const playerUser = getUserByName(currentUser);
    const enemyUser  = getUserByName(enemySpider.owner);
    
    if (!playerUser) {
      alert('Could not find your account. Please log in again.');
      return;
    }
    
    if (!enemyUser) {
      alert(`Could not find opponent's account (@${enemySpider.owner}).`);
      return;
    }

    // Ensure coins property exists
    if (playerUser.coins == null) playerUser.coins = 0;
    if (enemyUser.coins == null) enemyUser.coins = 0;

    // Check if player has enough coins
    if (playerUser.coins < wager) {
      alert(`You don't have enough coins for this wager!\n\nYou have: ${playerUser.coins} coins\nWager amount: ${wager} coins\n\nReduce your wager or earn more coins.`);
      return;
    }

    // Check if opponent has enough coins
    if (enemyUser.coins < wager) {
      alert(`Opponent @${enemyUser.username} doesn't have enough coins for this wager.\n\nThey have: ${enemyUser.coins} coins\nWager amount: ${wager} coins\n\nChoose a lower wager or a different opponent.`);
      return;
    }
  }

  // Ensure both spiders have moves
  ensureMoves(playerSpider);
  ensureMoves(enemySpider);

  // Verify moves were generated
  if (!playerSpider.moves || playerSpider.moves.length === 0) {
    alert('Your spider has no moves! Please contact an admin.');
    console.error('Player spider has no moves:', playerSpider);
    return;
  }

  if (!enemySpider.moves || enemySpider.moves.length === 0) {
    alert('Opponent spider has no moves! Please contact an admin.');
    console.error('Enemy spider has no moves:', enemySpider);
    return;
  }

  // Mark spiders as in battle
  activeBattles.push({ 
    playerSpiderId: playerSpider.id, 
    enemySpiderId: enemySpider.id,
    startedAt: new Date().toISOString()
  });

  // Create battle state with deep copies to avoid mutation
  window.battleState = {
    turn: 'player',
    player: {
      spider: JSON.parse(JSON.stringify(playerSpider)),
      currentToughness: playerSpider.toughness
    },
    enemy: {
      spider: JSON.parse(JSON.stringify(enemySpider)),
      currentToughness: enemySpider.toughness
    },
    log: [`Battle started! ${playerSpider.name} vs ${enemySpider.name}!`],
    effects: { player: [], enemy: [] },
    wager: wager
  };

  // Update UI and save
  updateBattleTabIndicator();
  await _save();
  renderBattle();

  // Switch to battle view
  document.getElementById('battleOpponentPhase').classList.add('hidden');
  document.getElementById('battleArenaPhase').classList.remove('hidden');

  console.log('Battle started successfully:', {
    player: playerSpider.name,
    enemy: enemySpider.name,
    wager: wager
  });
}

// ---------- damage model ----------
function moveBaseDamage(attacker, defender, move, sideKey) {
  const aStats = getSpiderWithHatStats ? getSpiderWithHatStats(attacker) : attacker;
  const dStats = getSpiderWithHatStats ? getSpiderWithHatStats(defender) : defender;

  const atk = aStats[move.stat] || 1;
  const def = Math.max(1, Math.round((dStats.size + dStats.toughness) / 2));
  const crit = Math.random() < 0.1 ? 1.5 : 1.0;
  const variance = 0.85 + Math.random() * 0.3;

  let base = (move.basePower || 1) * 6; // scale for punchiness
  let mult = outgoingDamageMultiplier(sideKey) * consumeCharge(sideKey);

  const raw = Math.round(((atk / def) * base) * crit * variance * mult);
  return { dmg: Math.max(1, raw), crit: crit > 1.0, multUsed: mult };
}

// ---------- arena render ----------
function renderBattle() {
  const arena = document.getElementById('battleArenaPhase');
  if (!battleState) return;

  const p = battleState.player.spider;
  const e = battleState.enemy.spider;
  const pPow = derivedPower(p), ePow = derivedPower(e);

  // Wager ribbon (if any)
  const wagerRibbon = battleState.wager > 0
    ? `<div style="text-align:center;margin-bottom:8px;">
         <span style="background:linear-gradient(135deg,#ffd700,#ffed4e);color:#000;padding:6px 12px;border-radius:999px;font-weight:bold;">
           üí∞ Wager: ${battleState.wager} coins
         </span>
       </div>`
    : '';

  arena.innerHTML = `
    <div class="arena-wrap">
      <button onclick="backToBattleSelect()">‚Üê Back</button>
      ${wagerRibbon}
      <h3 style="margin:10px 0 20px;">Battle</h3>
      <div class="arena-sides" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div class="spider-card">
          <img src="${p.image}" class="spider-image" alt="${p.name}">
          <div class="spider-name">${p.name}</div>
          <div class="stat"><span>Owner:</span><span>@${battleState.player.spider.owner || currentUser}</span></div>
          <div class="stat"><span>Level:</span><span>${p.level}</span></div>
          <div class="hp-bar"><div class="hp-fill ${(battleState.player.currentToughness/p.maxToughness)<0.3?'low':''}" style="width:${(battleState.player.currentToughness / p.maxToughness) * 100}%">Toughness: ${battleState.player.currentToughness}/${p.maxToughness}</div></div>
          <div class="stat"><span>Power:</span><span>${pPow}</span></div>
          ${battleState.turn === 'player' ? `
            <div style="display:grid;gap:8px;margin-top:10px;">
              ${ensureMoves(p).map((m,i)=>`<button onclick="playerUseMove(${i})">${m.name}</button>`).join('')}
              <button onclick="forfeitBattle()" style="background:linear-gradient(135deg,#f093fb,#f5576c)">Forfeit</button>
            </div>` : `<p style="color:#aaa;margin-top:10px;">Waiting for enemy turn‚Ä¶</p>`
          }
        </div>

        <div class="spider-card">
          <img src="${e.image}" class="spider-image" alt="${e.name}">
          <div class="spider-name">${e.name}</div>
          <div class="stat"><span>Owner:</span><span>@${e.owner}</span></div>
          <div class="stat"><span>Level:</span><span>${e.level}</span></div>
          <div class="hp-bar"><div class="hp-fill ${(battleState.enemy.currentToughness/e.maxToughness)<0.3?'low':''}" style="width:${(battleState.enemy.currentToughness / e.maxToughness) * 100}%">Toughness: ${battleState.enemy.currentToughness}/${e.maxToughness}</div></div>
          <div class="stat"><span>Power:</span><span>${ePow}</span></div>
        </div>
      </div>

      <div style="margin-top:16px;padding:12px;border-radius:10px;background:rgba(255,255,255,0.05);max-height:220px;overflow:auto;">
        ${battleState.log.slice().reverse().map(l=>`<div style="color:#ddd;font-size:0.95em;margin:4px 0;">${l}</div>`).join('')}
      </div>
    </div>
  `;
}

// ---------- player/enemy turns ----------
async function playerUseMove(idx) {
  if (!battleState || battleState.turn !== 'player') return;

  const start = applyStartOfTurn('player');
  if (battleState.player.currentToughness <= 0) { await endBattle(false); return; }
  if (start.stunned) { battleState.turn = 'enemy'; renderBattle(); return setTimeout(enemyTurn, 600); }

  const p = battleState.player.spider;
  const e = battleState.enemy.spider;
  const move = ensureMoves(p)[idx];

  const res = moveBaseDamage(p, e, move, 'player');
  battleState.enemy.currentToughness = Math.max(0, battleState.enemy.currentToughness - res.dmg);
  battleState.log.push(`${p.name} used ${move.name}! ${res.multUsed>1 ? 'üîã Charged! ' : ''}${res.crit ? '‚ú® Critical! ' : ''}It dealt ${res.dmg} damage.`);
  maybeInflictEffect('enemy', e, move, res.dmg);

  if (await checkBattleEnd()) return;
  battleState.turn = 'enemy';
  renderBattle();
  setTimeout(enemyTurn, 800);
}

function enemyTurn() {
  if (!battleState || battleState.turn !== 'enemy') return;

  const start = applyStartOfTurn('enemy');
  if (battleState.enemy.currentToughness <= 0) { endBattle(true); return; }
  if (start.stunned) { battleState.turn = 'player'; return renderBattle(); }

  const e = battleState.enemy.spider;
  const p = battleState.player.spider;

  const moves = ensureMoves(e);
  const idx = Math.floor(Math.random() * moves.length);
  const move = moves[idx];

  const res = moveBaseDamage(e, p, move, 'enemy');
  battleState.player.currentToughness = Math.max(0, battleState.player.currentToughness - res.dmg);
  battleState.log.push(`${e.name} used ${move.name}! ${res.multUsed>1 ? 'üîã Charged! ' : ''}${res.crit ? '‚ú® Critical! ' : ''}It dealt ${res.dmg} damage.`);
  maybeInflictEffect('player', p, move, res.dmg);

  if (checkBattleEndSync()) return;
  battleState.turn = 'player';
  renderBattle();
}

// ---------- end checks ----------
async function checkBattleEnd() {
  if (battleState.enemy.currentToughness <= 0) {
    await endBattle(true);
    return true;
  }
  if (battleState.player.currentToughness <= 0) {
    await endBattle(false);
    return true;
  }
  renderBattle();
  return false;
}
function checkBattleEndSync() {
  if (battleState.enemy.currentToughness <= 0) { endBattle(true); return true; }
  if (battleState.player.currentToughness <= 0) { endBattle(false); return true; }
  return false;
}

// ---------- finish / forfeit (coin transfer if wager > 0) ----------
async function endBattle(playerWon) {
  if (!battleState) return;

  const playerLive = spiders.find(s => s.id === battleState.player.spider.id);
  const enemyLive  = spiders.find(s => s.id === battleState.enemy.spider.id);

  // persist toughness back
  playerLive.toughness = Math.max(0, battleState.player.currentToughness);
  enemyLive.toughness  = Math.max(0, battleState.enemy.currentToughness);

  // wins / losses + XP
  if (playerWon) {
    playerLive.wins = (playerLive.wins || 0) + 1;
    enemyLive.losses = (enemyLive.losses || 0) + 1;
    const { xpGain, leveled } = grantBattleXP(playerLive, enemyLive);
    battleState.log.push(`${enemyLive.name} fainted! You gained ${xpGain} XP${leveled ? ' and leveled up!' : ''}.`);
  } else {
    enemyLive.wins = (enemyLive.wins || 0) + 1;
    playerLive.losses = (playerLive.losses || 0) + 1;
    const { xpGain, leveled } = grantBattleXP(enemyLive, playerLive);
    battleState.log.push(`${playerLive.name} fainted! Opponent gained ${xpGain} XP${leveled ? ' and leveled up!' : ''}.`);
  }

  // coin transfer (wager)
  const wager = battleState.wager || 0;
  if (wager > 0) {
    const pUser = getUserByName(currentUser);
    const eUser = getUserByName(enemyLive.owner);

    if (playerWon) {
      if (eUser) eUser.coins = Math.max(0, (eUser.coins || 0) - wager);
      if (pUser) pUser.coins = (pUser.coins || 0) + wager;
      battleState.log.push(`üí∞ You won the wager and receive ${wager} coins from @${eUser?.username || 'opponent'}!`);
    } else {
      if (pUser) pUser.coins = Math.max(0, (pUser.coins || 0) - wager);
      if (eUser) eUser.coins = (eUser.coins || 0) + wager;
      battleState.log.push(`üí∞ You lost the wager; @${eUser?.username || 'opponent'} receives ${wager} coins.`);
    }
  }

  // free slot
  activeBattles = activeBattles.filter(b =>
    b.playerSpiderId !== playerLive.id && b.enemySpiderId !== enemyLive.id
  );

  await _save();
  if (typeof updateCoins === 'function') updateCoins();
  renderBattle();

  setTimeout(() => {
    alert(playerWon ? 'üéâ You won the battle!' : 'üíî You lost the battle!');
    backToBattleSelect();
  }, 700);
}

async function forfeitBattle() {
  if (!confirm('Forfeit this battle? You will lose (and lose the wager if any).')) return;
  await endBattle(false);
}

// ---------- nav / indicator ----------
function backToBattleSelect() {
  document.getElementById('battleSelectPhase').classList.remove('hidden');
  document.getElementById('battleOpponentPhase').classList.add('hidden');
  document.getElementById('battleArenaPhase').classList.add('hidden');
  window.battleState = null;
  window.selectedBattleSpider = null;
  updateBattleTabIndicator();
  renderBattleSelect();
}
function updateBattleTabIndicator() {
  const btn = document.getElementById('battleTabBtn');
  if (!btn) return;
  if (battleState) {
    btn.innerHTML = '‚öîÔ∏è Battle üî¥';
    btn.style.position = 'relative';
    btn.style.animation = 'pulse 2s infinite';
  } else {
    btn.innerHTML = '‚öîÔ∏è Battle';
    btn.style.animation = 'none';
  }
}
</script>
</body>
</html>
